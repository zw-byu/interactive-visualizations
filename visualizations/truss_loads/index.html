<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Truss Tributaries Interactive Explorer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-a943fd88264382075bece5689f2f9969.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script type="module" src="index_files/libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="index_files/libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Truss Tributaries Interactive Explorer</h1>
</div>



<div class="quarto-title-meta column-page">

    
  
    
  </div>
  


</header>


<style>
  .viz-wrap { max-width: 1100px; margin: 0 auto; }
  svg { width: 100%; height: auto; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }

  /* Members (structure) */
  .chord-top { stroke: #1f2937; stroke-width: 3; fill: none; }
  .chord-bot { stroke: #1f2937; stroke-width: 2; fill: none; }
  .web       { stroke: #1f2937; stroke-width: 2; fill: none; }  /* webs in black */

  /* Dimensioning */
  .dim { stroke: #9ca3af; stroke-width: 1; fill: none; }
  .dim-total { stroke: #6b7280; stroke-dasharray: 4 3; }
  .ext { stroke: #9ca3af; stroke-width: 1; }
  .tick { stroke: #9ca3af; stroke-width: 1.2; }
  .label { fill: #374151; font-size: 12px; dominant-baseline: middle; }
  .label-small { fill: #4b5563; font-size: 11px; dominant-baseline: middle; }
  .label-dim { fill: #374151; font-size: 12px; }

  /* Extra light diagonal-chord dims */
  .dim-ghost { stroke: #e5e7eb; stroke-width: 1.2; fill: none; }
  .tick-ghost { stroke: #e5e7eb; stroke-width: 1.2; }

  /* Hover affordances */
  .node-hit { fill: #000; opacity: 0; pointer-events: all; }
  .node-ring { fill: #ffffff; stroke: #111827; stroke-width: 1.25; }
  .node-ring.hot { fill: #fef3c7; stroke: #b45309; }

  /* Highlighted tributary */
  .tribu { stroke-width: 6; fill: none; }
  .tribu-dim { stroke-width: 1.5; fill: none; }

  .baseline { stroke: #9ca3af; stroke-width: 1.2; stroke-dasharray: 3 3; }

  .controls { display:flex; gap:12px; align-items:center; margin: 0 0 10px 0; flex-wrap: wrap; }
  .controls label { font-weight: 600; color:#374151; }
  .controls select { padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; background:#fff; }
</style>
<section id="double-howe-double-fink-interactive-tributary-highlight" class="level2">
<h2 class="anchored" data-anchor-id="double-howe-double-fink-interactive-tributary-highlight">Double Howe / Double Fink â€” Interactive Tributary Highlight</h2>
<p>Use the dropdowns to switch <strong>Truss type</strong> and <strong>Units</strong>.<br>
- <strong>Metric:</strong> span &amp; sub-dimensions in meters.<br>
- <strong>USCS:</strong> span in feet; <strong>sub-dimensions in inches</strong> (including hover labels and horizontal projections).</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="56" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 55;"><span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@7"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="61" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 60;"><span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ===== Units &amp; helpers (shared) =====</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> IN <span class="op">=</span> <span class="fl">0.0254</span><span class="op">,</span> FT <span class="op">=</span> <span class="dv">12</span> <span class="op">*</span> IN<span class="op">;</span>   <span class="co">// meters per inch, meters per foot</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Formatters</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">fmtSpan</span>(m<span class="op">,</span> unitsMode) {</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (unitsMode <span class="op">===</span> <span class="st">"uscs"</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>(m<span class="op">/</span>FT)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> ft`</span><span class="op">;</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs"> m`</span><span class="op">;</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">fmtSub</span>(m<span class="op">,</span> unitsMode) {</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (unitsMode <span class="op">===</span> <span class="st">"uscs"</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>(m<span class="op">/</span>IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> in`</span><span class="op">;</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs"> m`</span><span class="op">;</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">fmtHeight</span>(m<span class="op">,</span> unitsMode) {</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (unitsMode <span class="op">===</span> <span class="st">"uscs"</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>(m<span class="op">/</span>IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> in`</span><span class="op">;</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>m<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="vs"> m`</span><span class="op">;</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">accumulateArc</span>(nodes) {</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> out <span class="op">=</span> [{<span class="op">...</span>nodes[<span class="dv">0</span>]<span class="op">,</span> s}]<span class="op">;</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> k <span class="op">&lt;</span> nodes<span class="op">.</span><span class="at">length</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dx <span class="op">=</span> nodes[k]<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> nodes[k<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span><span class="op">;</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dy <span class="op">=</span> nodes[k]<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> nodes[k<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">yh</span><span class="op">;</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> ds <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(dx<span class="op">,</span> dy)<span class="op">;</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>      s <span class="op">+=</span> ds<span class="op">;</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>      out<span class="op">.</span><span class="fu">push</span>({<span class="op">...</span>nodes[k]<span class="op">,</span> s})<span class="op">;</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">slicePolylineByS</span>(nodesS<span class="op">,</span> s0<span class="op">,</span> s1) {</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> segs <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> k <span class="op">&lt;</span> nodesS<span class="op">.</span><span class="at">length</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> A <span class="op">=</span> nodesS[k<span class="op">-</span><span class="dv">1</span>]<span class="op">,</span> B <span class="op">=</span> nodesS[k]<span class="op">;</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> sA <span class="op">=</span> A<span class="op">.</span><span class="at">s</span><span class="op">,</span> sB <span class="op">=</span> B<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> overlap0 <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(s0<span class="op">,</span> sA)<span class="op">;</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> overlap1 <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(s1<span class="op">,</span> sB)<span class="op">;</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (overlap1 <span class="op">&lt;=</span> overlap0) <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> t0 <span class="op">=</span> (overlap0 <span class="op">-</span> sA) <span class="op">/</span> (sB <span class="op">-</span> sA)<span class="op">;</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> t1 <span class="op">=</span> (overlap1 <span class="op">-</span> sA) <span class="op">/</span> (sB <span class="op">-</span> sA)<span class="op">;</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> P0 <span class="op">=</span> { <span class="dt">xh</span><span class="op">:</span> A<span class="op">.</span><span class="at">xh</span> <span class="op">+</span> (B<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span>) <span class="op">*</span> t0<span class="op">,</span> <span class="dt">yh</span><span class="op">:</span> A<span class="op">.</span><span class="at">yh</span> <span class="op">+</span> (B<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">yh</span>) <span class="op">*</span> t0 }<span class="op">;</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> P1 <span class="op">=</span> { <span class="dt">xh</span><span class="op">:</span> A<span class="op">.</span><span class="at">xh</span> <span class="op">+</span> (B<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span>) <span class="op">*</span> t1<span class="op">,</span> <span class="dt">yh</span><span class="op">:</span> A<span class="op">.</span><span class="at">yh</span> <span class="op">+</span> (B<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">yh</span>) <span class="op">*</span> t1 }<span class="op">;</span></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>      segs<span class="op">.</span><span class="fu">push</span>([P0<span class="op">,</span> P1])<span class="op">;</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> segs<span class="op">;</span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">sAtX</span>(topS<span class="op">,</span> xTarget_m) {</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (xTarget_m <span class="op">&lt;=</span> topS[<span class="dv">0</span>]<span class="op">.</span><span class="at">xh</span>) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> last <span class="op">=</span> topS[topS<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (xTarget_m <span class="op">&gt;=</span> last<span class="op">.</span><span class="at">xh</span>) <span class="cf">return</span> last<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> k <span class="op">&lt;</span> topS<span class="op">.</span><span class="at">length</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> A <span class="op">=</span> topS[k<span class="op">-</span><span class="dv">1</span>]<span class="op">,</span> B <span class="op">=</span> topS[k]<span class="op">;</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (xTarget_m <span class="op">&lt;=</span> B<span class="op">.</span><span class="at">xh</span>) {</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> t <span class="op">=</span> (xTarget_m <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span>) <span class="op">/</span> (B<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span>)<span class="op">;</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> A<span class="op">.</span><span class="at">s</span> <span class="op">+</span> t <span class="op">*</span> (B<span class="op">.</span><span class="at">s</span> <span class="op">-</span> A<span class="op">.</span><span class="at">s</span>)<span class="op">;</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> last<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">arrowTicks</span>(p<span class="op">,</span> q<span class="op">,</span> offVec<span class="op">,</span> tickLen <span class="op">=</span> <span class="dv">5</span>) {</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ux <span class="op">=</span> q<span class="op">.</span><span class="at">x</span> <span class="op">-</span> p<span class="op">.</span><span class="at">x</span><span class="op">,</span> uy <span class="op">=</span> q<span class="op">.</span><span class="at">y</span> <span class="op">-</span> p<span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> L <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(ux<span class="op">,</span> uy) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> vx <span class="op">=</span> <span class="op">-</span>uy <span class="op">/</span> L<span class="op">,</span> vy <span class="op">=</span> ux <span class="op">/</span> L<span class="op">;</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>      [p<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span> <span class="op">+</span> vx <span class="op">*</span> tickLen<span class="op">,</span> p<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span> <span class="op">+</span> vy <span class="op">*</span> tickLen<span class="op">,</span> p<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span> <span class="op">-</span> vx <span class="op">*</span> tickLen<span class="op">,</span> p<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span> <span class="op">-</span> vy <span class="op">*</span> tickLen]<span class="op">,</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>      [q<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span> <span class="op">+</span> vx <span class="op">*</span> tickLen<span class="op">,</span> q<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span> <span class="op">+</span> vy <span class="op">*</span> tickLen<span class="op">,</span> q<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span> <span class="op">-</span> vx <span class="op">*</span> tickLen<span class="op">,</span> q<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span> <span class="op">-</span> vy <span class="op">*</span> tickLen]<span class="op">,</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">// === Label: slanted top-chord true length (left half), ~85 px normal ===</span></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">placeTopChordLengthLabel</span>(topNodes<span class="op">,</span> topS<span class="op">,</span> group<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale) {</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> k <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">0</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(topNodes<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">2</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(topNodes<span class="op">.</span><span class="at">length</span> <span class="op">/</span> <span class="dv">4</span>)))<span class="op">;</span> <span class="co">// ~left quarter</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> A <span class="op">=</span> topNodes[k]<span class="op">,</span> B <span class="op">=</span> topNodes[k<span class="op">+</span><span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> px <span class="op">=</span> <span class="fu">x</span>(A<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> py <span class="op">=</span> <span class="fu">yScale</span>(A<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> qx <span class="op">=</span> <span class="fu">x</span>(B<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> qy <span class="op">=</span> <span class="fu">yScale</span>(B<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dx <span class="op">=</span> qx <span class="op">-</span> px<span class="op">,</span> dy <span class="op">=</span> qy <span class="op">-</span> py<span class="op">;</span></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Lp <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(dx<span class="op">,</span> dy) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> nx <span class="op">=</span> <span class="op">-</span>dy <span class="op">/</span> Lp<span class="op">,</span> ny <span class="op">=</span> dx <span class="op">/</span> Lp<span class="op">;</span>         <span class="co">// screen-space normal</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sign <span class="op">=</span> (ny <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span>          <span class="co">// push upward in screen coords</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> off <span class="op">=</span> <span class="dv">85</span><span class="op">;</span>                           <span class="co">// &lt;&lt; updated from 150 to ~85</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> (px <span class="op">+</span> qx) <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> nx <span class="op">*</span> off <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ty <span class="op">=</span> (py <span class="op">+</span> qy) <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ny <span class="op">*</span> off <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> angleDeg <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span>(dy<span class="op">,</span> dx) <span class="op">*</span> <span class="dv">180</span><span class="op">/</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">;</span></span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"label-dim"</span>)</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>tx<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>ty<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>angleDeg<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Top-chord true length â‰ˆ </span><span class="sc">${</span><span class="fu">fmtSpan</span>(topS[topS<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">.</span><span class="at">s</span><span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">// === New: diagonal-chord dimension lines for LEFT top chord (very light gray) ===</span></span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawLeftTopChordDiagDim</span>(topNodes<span class="op">,</span> group<span class="op">,</span> x<span class="op">,</span> yScale) {</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> midIdx <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>((topNodes<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span>)<span class="op">;</span> <span class="co">// apex index</span></span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> A <span class="op">=</span> topNodes[<span class="dv">0</span>]<span class="op">,</span> B <span class="op">=</span> topNodes[midIdx]<span class="op">;</span>          <span class="co">// left heel to apex (left top chord)</span></span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> P <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> <span class="fu">x</span>(A<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">yScale</span>(A<span class="op">.</span><span class="at">yh</span>) }<span class="op">;</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Q <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> <span class="fu">x</span>(B<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">yScale</span>(B<span class="op">.</span><span class="at">yh</span>) }<span class="op">;</span></span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dx <span class="op">=</span> Q<span class="op">.</span><span class="at">x</span> <span class="op">-</span> P<span class="op">.</span><span class="at">x</span><span class="op">,</span> dy <span class="op">=</span> Q<span class="op">.</span><span class="at">y</span> <span class="op">-</span> P<span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Lp <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(dx<span class="op">,</span> dy) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ux <span class="op">=</span> dx <span class="op">/</span> Lp<span class="op">,</span> uy <span class="op">=</span> dy <span class="op">/</span> Lp<span class="op">;</span></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> nx <span class="op">=</span> <span class="op">-</span>uy<span class="op">,</span> ny <span class="op">=</span> ux<span class="op">;</span>                                <span class="co">// normal</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sign <span class="op">=</span> (ny <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span>                       <span class="co">// same side as main label</span></span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> off <span class="op">=</span> <span class="dv">80</span><span class="op">;</span>                                       <span class="co">// slightly below the true-length label (85)</span></span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tick <span class="op">=</span> <span class="dv">10</span><span class="op">;</span>                                      <span class="co">// end tick half-length</span></span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Shifted end points for the parallel dim line</span></span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Pn <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> P<span class="op">.</span><span class="at">x</span> <span class="op">+</span> nx <span class="op">*</span> off <span class="op">*</span> sign<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> P<span class="op">.</span><span class="at">y</span> <span class="op">+</span> ny <span class="op">*</span> off <span class="op">*</span> sign }<span class="op">;</span></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Qn <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> Q<span class="op">.</span><span class="at">x</span> <span class="op">+</span> nx <span class="op">*</span> off <span class="op">*</span> sign<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> Q<span class="op">.</span><span class="at">y</span> <span class="op">+</span> ny <span class="op">*</span> off <span class="op">*</span> sign }<span class="op">;</span></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parallel line (very light gray)</span></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim-ghost"</span>)</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">x</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">x</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">// End ticks (normal to the chord, centered on Pn and Qn)</span></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick-ghost"</span>)</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">x</span> <span class="op">-</span> nx <span class="op">*</span> tick)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">y</span> <span class="op">-</span> ny <span class="op">*</span> tick)</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">x</span> <span class="op">+</span> nx <span class="op">*</span> tick)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> Pn<span class="op">.</span><span class="at">y</span> <span class="op">+</span> ny <span class="op">*</span> tick)<span class="op">;</span></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick-ghost"</span>)</span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">x</span> <span class="op">-</span> nx <span class="op">*</span> tick)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">y</span> <span class="op">-</span> ny <span class="op">*</span> tick)</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">x</span> <span class="op">+</span> nx <span class="op">*</span> tick)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> Qn<span class="op">.</span><span class="at">y</span> <span class="op">+</span> ny <span class="op">*</span> tick)<span class="op">;</span></span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>  <span class="co">// === Vertical height dimension (short equal stubs at dim line; vertical label) ===</span></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawApexHeightDim</span>(group<span class="op">,</span> x<span class="op">,</span> yScale<span class="op">,</span> span_m<span class="op">,</span> rise_m<span class="op">,</span> unitsMode) {</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> baseY <span class="op">=</span> <span class="fu">yScale</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xDim  <span class="op">=</span> <span class="fu">x</span>(<span class="dv">0</span>) <span class="op">-</span> <span class="dv">26</span><span class="op">;</span>  <span class="co">// to the left of the heel (dimension line position)</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stub <span class="op">=</span> <span class="dv">24</span><span class="op">;</span>          <span class="co">// short, equal-length horizontal stubs</span></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Short horizontal stubs at top (apex y) and bottom (heel y)</span></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"ext"</span>)</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xDim)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(rise_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xDim <span class="op">+</span> stub)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(rise_m))<span class="op">;</span></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"ext"</span>)</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xDim)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xDim <span class="op">+</span> stub)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Vertical dimension line</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim"</span>)</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xDim)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(rise_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xDim)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>    <span class="co">// End ticks on the vertical dim line</span></span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ticks <span class="op">=</span> [</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>      [xDim <span class="op">-</span> <span class="dv">6</span><span class="op">,</span> <span class="fu">yScale</span>(rise_m)<span class="op">,</span> xDim <span class="op">+</span> <span class="dv">6</span><span class="op">,</span> <span class="fu">yScale</span>(rise_m)]<span class="op">,</span></span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>      [xDim <span class="op">-</span> <span class="dv">6</span><span class="op">,</span> baseY<span class="op">,</span>          xDim <span class="op">+</span> <span class="dv">6</span><span class="op">,</span> baseY]</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>    ticks<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick"</span>)</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> t[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> t[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> t[<span class="dv">2</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> t[<span class="dv">3</span>]))<span class="op">;</span></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Vertical label (rotated), offset slightly left of the dim line</span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> yMid <span class="op">=</span> (<span class="fu">yScale</span>(rise_m) <span class="op">+</span> baseY) <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label"</span>)</span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>xDim <span class="op">-</span> <span class="dv">18</span><span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>yMid<span class="sc">}</span><span class="vs">) rotate(-90)`</span>)</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Height: </span><span class="sc">${</span><span class="fu">fmtHeight</span>(rise_m<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ===== Container, controls, and SVG shell =====</span></span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"viz-wrap"</span>)<span class="op">;</span></span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> controls <span class="op">=</span> container<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"controls"</span>)<span class="op">;</span></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Truss selector</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>  controls<span class="op">.</span><span class="fu">append</span>(<span class="st">"label"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"for"</span><span class="op">,</span><span class="st">"trussType"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"Truss:"</span>)<span class="op">;</span></span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selectTruss <span class="op">=</span> controls<span class="op">.</span><span class="fu">append</span>(<span class="st">"select"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span><span class="st">"trussType"</span>)<span class="op">;</span></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>  selectTruss<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"option"</span>)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>([</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">val</span><span class="op">:</span><span class="st">"double-howe"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span><span class="st">"Double Howe (6-panel)"</span>}<span class="op">,</span></span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">val</span><span class="op">:</span><span class="st">"double-fink"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span><span class="st">"Double Fink (40-ft canonical)"</span>}<span class="op">,</span></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()<span class="op">.</span><span class="fu">append</span>(<span class="st">"option"</span>)</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"value"</span><span class="op">,</span> d<span class="kw">=&gt;</span>d<span class="op">.</span><span class="at">val</span>)<span class="op">.</span><span class="fu">text</span>(d<span class="kw">=&gt;</span>d<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>  selectTruss<span class="op">.</span><span class="fu">property</span>(<span class="st">"value"</span><span class="op">,</span><span class="st">"double-howe"</span>)<span class="op">;</span></span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Units selector</span></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>  controls<span class="op">.</span><span class="fu">append</span>(<span class="st">"label"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"for"</span><span class="op">,</span><span class="st">"unitsMode"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"Units:"</span>)<span class="op">;</span></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selectUnits <span class="op">=</span> controls<span class="op">.</span><span class="fu">append</span>(<span class="st">"select"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span><span class="st">"unitsMode"</span>)<span class="op">;</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>  selectUnits<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"option"</span>)</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>([</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">val</span><span class="op">:</span><span class="st">"uscs"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span><span class="st">"USCS (ft span, in sub-dims)"</span>}<span class="op">,</span></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">val</span><span class="op">:</span><span class="st">"metric"</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span><span class="st">"Metric (m)"</span>}<span class="op">,</span></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()<span class="op">.</span><span class="fu">append</span>(<span class="st">"option"</span>)</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"value"</span><span class="op">,</span> d<span class="kw">=&gt;</span>d<span class="op">.</span><span class="at">val</span>)<span class="op">.</span><span class="fu">text</span>(d<span class="kw">=&gt;</span>d<span class="op">.</span><span class="at">label</span>)<span class="op">;</span></span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>  selectUnits<span class="op">.</span><span class="fu">property</span>(<span class="st">"value"</span><span class="op">,</span><span class="st">"uscs"</span>)<span class="op">;</span></span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extra headroom above chord for labels</span></span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> margin <span class="op">=</span> {<span class="dt">top</span><span class="op">:</span> <span class="dv">160</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">110</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">60</span>}<span class="op">;</span></span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> W <span class="op">=</span> <span class="dv">1000</span><span class="op">,</span> H <span class="op">=</span> <span class="dv">640</span><span class="op">;</span></span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> innerW <span class="op">=</span> W <span class="op">-</span> margin<span class="op">.</span><span class="at">left</span> <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span><span class="op">;</span></span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> innerH <span class="op">=</span> H <span class="op">-</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">-</span> margin<span class="op">.</span><span class="at">bottom</span><span class="op">;</span></span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> container<span class="op">.</span><span class="fu">append</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span>W<span class="op">,</span>H]<span class="op">.</span><span class="fu">join</span>(<span class="st">" "</span>))<span class="op">;</span></span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g   <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">left</span><span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">top</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ===== Dimension drawers =====</span></span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawDimAlongChord</span>(topNodes<span class="op">,</span> k<span class="op">,</span> group<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale) {</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> A <span class="op">=</span> topNodes[k]<span class="op">,</span> B <span class="op">=</span> topNodes[k<span class="op">+</span><span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>A <span class="op">||</span> <span class="op">!</span>B) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> P <span class="op">=</span> {<span class="dt">x</span><span class="op">:</span> <span class="fu">x</span>(A<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">yScale</span>(A<span class="op">.</span><span class="at">yh</span>)}<span class="op">;</span></span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Q <span class="op">=</span> {<span class="dt">x</span><span class="op">:</span> <span class="fu">x</span>(B<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="fu">yScale</span>(B<span class="op">.</span><span class="at">yh</span>)}<span class="op">;</span></span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Perpendicular (offset ABOVE chord)</span></span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ux <span class="op">=</span> Q<span class="op">.</span><span class="at">x</span> <span class="op">-</span> P<span class="op">.</span><span class="at">x</span><span class="op">,</span> uy <span class="op">=</span> Q<span class="op">.</span><span class="at">y</span> <span class="op">-</span> P<span class="op">.</span><span class="at">y</span><span class="op">,</span> L <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(ux<span class="op">,</span> uy) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> nx <span class="op">=</span> <span class="op">-</span>(uy <span class="op">/</span> L)<span class="op">,</span> ny <span class="op">=</span> ux <span class="op">/</span> L<span class="op">;</span></span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> off <span class="op">=</span> <span class="dv">12</span><span class="op">,</span> sign <span class="op">=</span> (ny <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> offVec <span class="op">=</span> {<span class="dt">x</span><span class="op">:</span> nx <span class="op">*</span> off <span class="op">*</span> sign<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> ny <span class="op">*</span> off <span class="op">*</span> sign}<span class="op">;</span></span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim"</span>)</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> P<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> P<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> Q<span class="op">.</span><span class="at">x</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> Q<span class="op">.</span><span class="at">y</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrowTicks</span>(P<span class="op">,</span> Q<span class="op">,</span> offVec<span class="op">,</span> <span class="dv">5</span>)<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick"</span>)</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> t[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> t[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> t[<span class="dv">2</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> t[<span class="dv">3</span>]))<span class="op">;</span></span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mid <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> (P<span class="op">.</span><span class="at">x</span><span class="op">+</span>Q<span class="op">.</span><span class="at">x</span>)<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">x</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> (P<span class="op">.</span><span class="at">y</span><span class="op">+</span>Q<span class="op">.</span><span class="at">y</span>)<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> offVec<span class="op">.</span><span class="at">y</span> }<span class="op">;</span></span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> len_m <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(B<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span><span class="op">,</span> B<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-small"</span>)</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> mid<span class="op">.</span><span class="at">x</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> mid<span class="op">.</span><span class="at">y</span> <span class="op">-</span> <span class="dv">8</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="fu">fmtSub</span>(len_m<span class="op">,</span> unitsMode))<span class="op">;</span></span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawDimHorizontal</span>(topNodes<span class="op">,</span> k<span class="op">,</span> group<span class="op">,</span> baseY<span class="op">,</span> yOffsetPx<span class="op">,</span> unitsMode<span class="op">,</span> x) {</span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> A <span class="op">=</span> topNodes[k]<span class="op">,</span> B <span class="op">=</span> topNodes[k<span class="op">+</span><span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>A <span class="op">||</span> <span class="op">!</span>B) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> x1p <span class="op">=</span> <span class="fu">x</span>(A<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> x2p <span class="op">=</span> <span class="fu">x</span>(B<span class="op">.</span><span class="at">xh</span>)<span class="op">;</span></span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> y0  <span class="op">=</span> baseY <span class="op">+</span> yOffsetPx<span class="op">;</span></span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim"</span>)</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> x1p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> y0)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> x2p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> y0)<span class="op">;</span></span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>    [x1p<span class="op">,</span> x2p]<span class="op">.</span><span class="fu">forEach</span>(xx <span class="kw">=&gt;</span> {</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>      group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"ext"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> y0)<span class="op">;</span></span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>      group<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> y0<span class="op">-</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> y0<span class="op">+</span><span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dx_m <span class="op">=</span> (B<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> A<span class="op">.</span><span class="at">xh</span>)<span class="op">;</span></span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>    group<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-small"</span>)</span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (x1p<span class="op">+</span>x2p)<span class="op">/</span><span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> y0 <span class="op">-</span> <span class="dv">6</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="fu">fmtSub</span>(dx_m<span class="op">,</span> unitsMode))<span class="op">;</span></span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ===== Render function (switchable) =====</span></span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">render</span>(trussType<span class="op">=</span><span class="st">"double-howe"</span><span class="op">,</span> unitsMode<span class="op">=</span><span class="st">"uscs"</span>) {</span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>    g<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chords <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> websG  <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"webs"</span>)<span class="op">;</span></span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dims   <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb2-312"><a href="#cb2-312" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> highlight <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb2-313"><a href="#cb2-313" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> nodesG <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb2-314"><a href="#cb2-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-315"><a href="#cb2-315" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> topNodes <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb2-316"><a href="#cb2-316" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> topS <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb2-317"><a href="#cb2-317" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> span_m <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-318"><a href="#cb2-318" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> rise_m <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-319"><a href="#cb2-319" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> x<span class="op">,</span> yScale<span class="op">;</span></span>
<span id="cb2-320"><a href="#cb2-320" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> topJoinIdx <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb2-321"><a href="#cb2-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-322"><a href="#cb2-322" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (trussType <span class="op">===</span> <span class="st">"double-howe"</span>) {</span>
<span id="cb2-323"><a href="#cb2-323" aria-hidden="true" tabindex="-1"></a>      <span class="co">// === Double Howe (default span: 40 ft) ===</span></span>
<span id="cb2-324"><a href="#cb2-324" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> span_ft <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb2-325"><a href="#cb2-325" aria-hidden="true" tabindex="-1"></a>      span_m <span class="op">=</span> span_ft <span class="op">*</span> FT<span class="op">;</span></span>
<span id="cb2-326"><a href="#cb2-326" aria-hidden="true" tabindex="-1"></a>      rise_m <span class="op">=</span> <span class="fl">0.2</span> <span class="op">*</span> span_m<span class="op">;</span>           <span class="co">// simple symmetric ridge</span></span>
<span id="cb2-327"><a href="#cb2-327" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> nPanels <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb2-328"><a href="#cb2-328" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> panel_m <span class="op">=</span> span_m <span class="op">/</span> nPanels<span class="op">;</span></span>
<span id="cb2-329"><a href="#cb2-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-330"><a href="#cb2-330" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> span_m])<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> innerW])<span class="op">;</span></span>
<span id="cb2-331"><a href="#cb2-331" aria-hidden="true" tabindex="-1"></a>      yScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([rise_m <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> innerH])<span class="op">;</span></span>
<span id="cb2-332"><a href="#cb2-332" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> baseY <span class="op">=</span> <span class="fu">yScale</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-333"><a href="#cb2-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-334"><a href="#cb2-334" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Top chord nodes (symmetric ridge)</span></span>
<span id="cb2-335"><a href="#cb2-335" aria-hidden="true" tabindex="-1"></a>      topNodes <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(nPanels <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>(i <span class="kw">=&gt;</span> {</span>
<span id="cb2-336"><a href="#cb2-336" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xh <span class="op">=</span> i <span class="op">*</span> panel_m<span class="op">;</span></span>
<span id="cb2-337"><a href="#cb2-337" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> mid <span class="op">=</span> span_m <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-338"><a href="#cb2-338" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> t <span class="op">=</span> xh <span class="op">&lt;=</span> mid <span class="op">?</span> xh <span class="op">/</span> mid <span class="op">:</span> (span_m <span class="op">-</span> xh) <span class="op">/</span> mid<span class="op">;</span></span>
<span id="cb2-339"><a href="#cb2-339" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> yh <span class="op">=</span> rise_m <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb2-340"><a href="#cb2-340" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {i<span class="op">,</span> xh<span class="op">,</span> yh}<span class="op">;</span></span>
<span id="cb2-341"><a href="#cb2-341" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-342"><a href="#cb2-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-343"><a href="#cb2-343" aria-hidden="true" tabindex="-1"></a>      <span class="co">// chords &amp; baseline</span></span>
<span id="cb2-344"><a href="#cb2-344" aria-hidden="true" tabindex="-1"></a>      g<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"baseline"</span>)</span>
<span id="cb2-345"><a href="#cb2-345" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(span_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-346"><a href="#cb2-346" aria-hidden="true" tabindex="-1"></a>      chords<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"chord-bot"</span>)</span>
<span id="cb2-347"><a href="#cb2-347" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">x</span>(d<span class="kw">=&gt;</span>d[<span class="dv">0</span>])<span class="op">.</span><span class="fu">y</span>(d<span class="kw">=&gt;</span>d[<span class="dv">1</span>])([[<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">,</span> baseY]<span class="op">,</span>[<span class="fu">x</span>(span_m)<span class="op">,</span> baseY]]) )<span class="op">;</span></span>
<span id="cb2-348"><a href="#cb2-348" aria-hidden="true" tabindex="-1"></a>      chords<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"chord-top"</span>)</span>
<span id="cb2-349"><a href="#cb2-349" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">x</span>(d<span class="kw">=&gt;</span><span class="fu">x</span>(d<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">y</span>(d<span class="kw">=&gt;</span><span class="fu">yScale</span>(d<span class="op">.</span><span class="at">yh</span>))(topNodes))<span class="op">;</span></span>
<span id="cb2-350"><a href="#cb2-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-351"><a href="#cb2-351" aria-hidden="true" tabindex="-1"></a>      <span class="co">// webs (5 verticals + diagonals toward center)</span></span>
<span id="cb2-352"><a href="#cb2-352" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> midIdx <span class="op">=</span> nPanels<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-353"><a href="#cb2-353" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span>midIdx<span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span>]<span class="op">.</span><span class="fu">forEach</span>(i<span class="kw">=&gt;</span>{</span>
<span id="cb2-354"><a href="#cb2-354" aria-hidden="true" tabindex="-1"></a>        websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-355"><a href="#cb2-355" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[i]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(topNodes[i]<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-356"><a href="#cb2-356" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[i]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-357"><a href="#cb2-357" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-358"><a href="#cb2-358" aria-hidden="true" tabindex="-1"></a>      <span class="co">// diagonals: Left top(1)-&gt;bottom(2), top(2)-&gt;bottom(3); Right top(5)-&gt;bottom(4), top(4)-&gt;bottom(3)</span></span>
<span id="cb2-359"><a href="#cb2-359" aria-hidden="true" tabindex="-1"></a>      websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-360"><a href="#cb2-360" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(topNodes[<span class="dv">1</span>]<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-361"><a href="#cb2-361" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">2</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-362"><a href="#cb2-362" aria-hidden="true" tabindex="-1"></a>      websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-363"><a href="#cb2-363" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">2</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(topNodes[<span class="dv">2</span>]<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-364"><a href="#cb2-364" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[midIdx]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-365"><a href="#cb2-365" aria-hidden="true" tabindex="-1"></a>      websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-366"><a href="#cb2-366" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">5</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(topNodes[<span class="dv">5</span>]<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-367"><a href="#cb2-367" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">4</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-368"><a href="#cb2-368" aria-hidden="true" tabindex="-1"></a>      websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-369"><a href="#cb2-369" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[<span class="dv">4</span>]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(topNodes[<span class="dv">4</span>]<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-370"><a href="#cb2-370" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(topNodes[midIdx]<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-371"><a href="#cb2-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-372"><a href="#cb2-372" aria-hidden="true" tabindex="-1"></a>      <span class="co">// include end nodes in hover set</span></span>
<span id="cb2-373"><a href="#cb2-373" aria-hidden="true" tabindex="-1"></a>      topJoinIdx <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>([<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">6</span>])<span class="op">;</span></span>
<span id="cb2-374"><a href="#cb2-374" aria-hidden="true" tabindex="-1"></a>      topS <span class="op">=</span> <span class="fu">accumulateArc</span>(topNodes)<span class="op">;</span></span>
<span id="cb2-375"><a href="#cb2-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-376"><a href="#cb2-376" aria-hidden="true" tabindex="-1"></a>      <span class="co">// per-panel dims (sub-dimensions)</span></span>
<span id="cb2-377"><a href="#cb2-377" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;</span> topNodes<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb2-378"><a href="#cb2-378" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawDimAlongChord</span>(topNodes<span class="op">,</span> k<span class="op">,</span> dims<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-379"><a href="#cb2-379" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawDimHorizontal</span>(topNodes<span class="op">,</span> k<span class="op">,</span> dims<span class="op">,</span> baseY<span class="op">,</span> <span class="dv">28</span><span class="op">,</span> unitsMode<span class="op">,</span> x)<span class="op">;</span></span>
<span id="cb2-380"><a href="#cb2-380" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-381"><a href="#cb2-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-382"><a href="#cb2-382" aria-hidden="true" tabindex="-1"></a>      <span class="co">// total span dim</span></span>
<span id="cb2-383"><a href="#cb2-383" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> yD_total <span class="op">=</span> baseY <span class="op">+</span> <span class="dv">70</span><span class="op">;</span></span>
<span id="cb2-384"><a href="#cb2-384" aria-hidden="true" tabindex="-1"></a>      dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim dim-total"</span>)</span>
<span id="cb2-385"><a href="#cb2-385" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD_total)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(span_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD_total)<span class="op">;</span></span>
<span id="cb2-386"><a href="#cb2-386" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span><span class="op">,</span> span_m]<span class="op">.</span><span class="fu">forEach</span>(X<span class="kw">=&gt;</span>{</span>
<span id="cb2-387"><a href="#cb2-387" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"ext"</span>)</span>
<span id="cb2-388"><a href="#cb2-388" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(X))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(X))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD_total)<span class="op">;</span></span>
<span id="cb2-389"><a href="#cb2-389" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-390"><a href="#cb2-390" aria-hidden="true" tabindex="-1"></a>      [[<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">,</span>yD_total]<span class="op">,</span>[<span class="fu">x</span>(span_m)<span class="op">,</span>yD_total]]<span class="op">.</span><span class="fu">forEach</span>(([xx<span class="op">,</span>yy])<span class="kw">=&gt;</span>{</span>
<span id="cb2-391"><a href="#cb2-391" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yy<span class="op">-</span><span class="dv">6</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yy<span class="op">+</span><span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb2-392"><a href="#cb2-392" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-393"><a href="#cb2-393" aria-hidden="true" tabindex="-1"></a>      dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label"</span>)</span>
<span id="cb2-394"><a href="#cb2-394" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">+</span><span class="fu">x</span>(span_m))<span class="op">/</span><span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD_total <span class="op">-</span> <span class="dv">10</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-395"><a href="#cb2-395" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span><span class="fu">fmtSpan</span>(span_m<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs"> (horizontal span)`</span>)<span class="op">;</span></span>
<span id="cb2-396"><a href="#cb2-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-397"><a href="#cb2-397" aria-hidden="true" tabindex="-1"></a>      <span class="co">// top-chord true length label (slanted, left half, ~85px off)</span></span>
<span id="cb2-398"><a href="#cb2-398" aria-hidden="true" tabindex="-1"></a>      <span class="fu">placeTopChordLengthLabel</span>(topNodes<span class="op">,</span> topS<span class="op">,</span> dims<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-399"><a href="#cb2-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-400"><a href="#cb2-400" aria-hidden="true" tabindex="-1"></a>      <span class="co">// NEW: diagonal-chord dim (left top chord) below the label</span></span>
<span id="cb2-401"><a href="#cb2-401" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drawLeftTopChordDiagDim</span>(topNodes<span class="op">,</span> dims<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-402"><a href="#cb2-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-403"><a href="#cb2-403" aria-hidden="true" tabindex="-1"></a>      <span class="co">// apex-height dim at left (short equal stubs; vertical label)</span></span>
<span id="cb2-404"><a href="#cb2-404" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drawApexHeightDim</span>(dims<span class="op">,</span> x<span class="op">,</span> yScale<span class="op">,</span> span_m<span class="op">,</span> rise_m<span class="op">,</span> unitsMode)<span class="op">;</span></span>
<span id="cb2-405"><a href="#cb2-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-406"><a href="#cb2-406" aria-hidden="true" tabindex="-1"></a>      <span class="co">// color scale</span></span>
<span id="cb2-407"><a href="#cb2-407" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> colorScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()</span>
<span id="cb2-408"><a href="#cb2-408" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">range</span>(topS<span class="op">.</span><span class="at">length</span>))</span>
<span id="cb2-409"><a href="#cb2-409" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">range</span>([<span class="st">"#2563eb"</span><span class="op">,</span><span class="st">"#dc2626"</span><span class="op">,</span><span class="st">"#16a34a"</span><span class="op">,</span><span class="st">"#a855f7"</span><span class="op">,</span><span class="st">"#ea580c"</span><span class="op">,</span><span class="st">"#0891b2"</span><span class="op">,</span><span class="st">"#eab308"</span><span class="op">,</span><span class="st">"#0ea5e9"</span><span class="op">,</span><span class="st">"#f97316"</span><span class="op">,</span><span class="st">"#22c55e"</span><span class="op">,</span><span class="st">"#ef4444"</span>])<span class="op">;</span></span>
<span id="cb2-410"><a href="#cb2-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-411"><a href="#cb2-411" aria-hidden="true" tabindex="-1"></a>      <span class="kw">function</span> <span class="fu">showTributary</span>(iNode) {</span>
<span id="cb2-412"><a href="#cb2-412" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb2-413"><a href="#cb2-413" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> color <span class="op">=</span> <span class="fu">colorScale</span>(iNode)<span class="op">;</span></span>
<span id="cb2-414"><a href="#cb2-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-415"><a href="#cb2-415" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Along-chord span</span></span>
<span id="cb2-416"><a href="#cb2-416" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> s0<span class="op">,</span> s1<span class="op">;</span></span>
<span id="cb2-417"><a href="#cb2-417" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (iNode <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb2-418"><a href="#cb2-418" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xEnd <span class="op">=</span> topNodes[<span class="dv">0</span>]<span class="op">.</span><span class="at">xh</span><span class="op">,</span> xNext <span class="op">=</span> topNodes[<span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span><span class="op">;</span></span>
<span id="cb2-419"><a href="#cb2-419" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xHalf <span class="op">=</span> xEnd <span class="op">+</span> (xNext <span class="op">-</span> xEnd)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-420"><a href="#cb2-420" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-421"><a href="#cb2-421" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> <span class="fu">sAtX</span>(topS<span class="op">,</span> xHalf)<span class="op">;</span></span>
<span id="cb2-422"><a href="#cb2-422" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (iNode <span class="op">===</span> topS<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb2-423"><a href="#cb2-423" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xEnd <span class="op">=</span> topNodes[topNodes<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span><span class="op">,</span> xPrev <span class="op">=</span> topNodes[topNodes<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">2</span>]<span class="op">.</span><span class="at">xh</span><span class="op">;</span></span>
<span id="cb2-424"><a href="#cb2-424" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xHalf <span class="op">=</span> xPrev <span class="op">+</span> (xEnd <span class="op">-</span> xPrev)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-425"><a href="#cb2-425" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> <span class="fu">sAtX</span>(topS<span class="op">,</span> xHalf)<span class="op">;</span></span>
<span id="cb2-426"><a href="#cb2-426" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> topS[topS<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-427"><a href="#cb2-427" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb2-428"><a href="#cb2-428" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> s_i   <span class="op">=</span> topS[iNode]<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-429"><a href="#cb2-429" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> s_prev <span class="op">=</span> topS[iNode<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-430"><a href="#cb2-430" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> s_next <span class="op">=</span> topS[iNode<span class="op">+</span><span class="dv">1</span>]<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-431"><a href="#cb2-431" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> (s_prev <span class="op">+</span> s_i) <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-432"><a href="#cb2-432" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> (s_i <span class="op">+</span> s_next) <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-433"><a href="#cb2-433" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-434"><a href="#cb2-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-435"><a href="#cb2-435" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> segs <span class="op">=</span> <span class="fu">slicePolylineByS</span>(topS<span class="op">,</span> s0<span class="op">,</span> s1)<span class="op">;</span></span>
<span id="cb2-436"><a href="#cb2-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-437"><a href="#cb2-437" aria-hidden="true" tabindex="-1"></a>        segs<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-438"><a href="#cb2-438" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-439"><a href="#cb2-439" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-440"><a href="#cb2-440" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-441"><a href="#cb2-441" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-442"><a href="#cb2-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-443"><a href="#cb2-443" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Metrics &amp; label placement</span></span>
<span id="cb2-444"><a href="#cb2-444" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> L_along <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> Xc <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> Yc <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> sumDXp <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> sumDYp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-445"><a href="#cb2-445" aria-hidden="true" tabindex="-1"></a>        segs<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-446"><a href="#cb2-446" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> ds <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(Q<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> P<span class="op">.</span><span class="at">xh</span><span class="op">,</span> Q<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> P<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-447"><a href="#cb2-447" aria-hidden="true" tabindex="-1"></a>          L_along <span class="op">+=</span> ds<span class="op">;</span></span>
<span id="cb2-448"><a href="#cb2-448" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xm <span class="op">=</span> (P<span class="op">.</span><span class="at">xh</span> <span class="op">+</span> Q<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">,</span> ym <span class="op">=</span> (P<span class="op">.</span><span class="at">yh</span> <span class="op">+</span> Q<span class="op">.</span><span class="at">yh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-449"><a href="#cb2-449" aria-hidden="true" tabindex="-1"></a>          Xc <span class="op">+=</span> xm <span class="op">*</span> ds<span class="op">;</span> Yc <span class="op">+=</span> ym <span class="op">*</span> ds<span class="op">;</span></span>
<span id="cb2-450"><a href="#cb2-450" aria-hidden="true" tabindex="-1"></a>          sumDXp <span class="op">+=</span> (<span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>) <span class="op">-</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">;</span></span>
<span id="cb2-451"><a href="#cb2-451" aria-hidden="true" tabindex="-1"></a>          sumDYp <span class="op">+=</span> (<span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>) <span class="op">-</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-452"><a href="#cb2-452" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-453"><a href="#cb2-453" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (L_along <span class="op">&gt;</span> <span class="dv">0</span>) { Xc <span class="op">/=</span> L_along<span class="op">;</span> Yc <span class="op">/=</span> L_along<span class="op">;</span> }</span>
<span id="cb2-454"><a href="#cb2-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-455"><a href="#cb2-455" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> Lp <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(sumDXp<span class="op">,</span> sumDYp) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-456"><a href="#cb2-456" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nx <span class="op">=</span> <span class="op">-</span>sumDYp <span class="op">/</span> Lp<span class="op">,</span> ny <span class="op">=</span> sumDXp <span class="op">/</span> Lp<span class="op">;</span></span>
<span id="cb2-457"><a href="#cb2-457" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> sign <span class="op">=</span> (ny <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-458"><a href="#cb2-458" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> offAlong <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> offNode <span class="op">=</span> <span class="dv">74</span><span class="op">;</span></span>
<span id="cb2-459"><a href="#cb2-459" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> angleDeg <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span>(sumDYp<span class="op">,</span> sumDXp) <span class="op">*</span> <span class="dv">180</span><span class="op">/</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">;</span></span>
<span id="cb2-460"><a href="#cb2-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-461"><a href="#cb2-461" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tx <span class="op">=</span> <span class="fu">x</span>(Xc) <span class="op">+</span> nx <span class="op">*</span> offAlong <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-462"><a href="#cb2-462" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> ty <span class="op">=</span> <span class="fu">yScale</span>(Yc) <span class="op">+</span> ny <span class="op">*</span> offAlong <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-463"><a href="#cb2-463" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-464"><a href="#cb2-464" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)</span>
<span id="cb2-465"><a href="#cb2-465" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-466"><a href="#cb2-466" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-467"><a href="#cb2-467" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>tx<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>ty<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>angleDeg<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb2-468"><a href="#cb2-468" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Along chord: </span><span class="sc">${</span><span class="fu">fmtSub</span>(L_along<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-469"><a href="#cb2-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-470"><a href="#cb2-470" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tx2 <span class="op">=</span> <span class="fu">x</span>(Xc) <span class="op">+</span> nx <span class="op">*</span> offNode <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-471"><a href="#cb2-471" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> ty2 <span class="op">=</span> <span class="fu">yScale</span>(Yc) <span class="op">+</span> ny <span class="op">*</span> offNode <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-472"><a href="#cb2-472" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-473"><a href="#cb2-473" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)</span>
<span id="cb2-474"><a href="#cb2-474" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-475"><a href="#cb2-475" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-476"><a href="#cb2-476" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>tx2<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>ty2<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>angleDeg<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb2-477"><a href="#cb2-477" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Node </span><span class="sc">${</span>iNode<span class="sc">}</span><span class="vs"> tributary`</span>)<span class="op">;</span></span>
<span id="cb2-478"><a href="#cb2-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-479"><a href="#cb2-479" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Horizontal projection</span></span>
<span id="cb2-480"><a href="#cb2-480" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> n <span class="op">=</span> topNodes<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb2-481"><a href="#cb2-481" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xH <span class="op">=</span> topNodes[iNode]<span class="op">.</span><span class="at">xh</span><span class="op">;</span></span>
<span id="cb2-482"><a href="#cb2-482" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xL <span class="op">=</span> (iNode <span class="op">===</span> <span class="dv">0</span>)     <span class="op">?</span> xH <span class="op">:</span> (xH <span class="op">+</span> topNodes[iNode<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-483"><a href="#cb2-483" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xR <span class="op">=</span> (iNode <span class="op">===</span> n<span class="op">-</span><span class="dv">1</span>)   <span class="op">?</span> xH <span class="op">:</span> (xH <span class="op">+</span> topNodes[iNode<span class="op">+</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-484"><a href="#cb2-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-485"><a href="#cb2-485" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> Lx_m <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(xR <span class="op">-</span> xL)<span class="op">;</span></span>
<span id="cb2-486"><a href="#cb2-486" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xLeft_m  <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(xL<span class="op">,</span> xR)<span class="op">;</span></span>
<span id="cb2-487"><a href="#cb2-487" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xRight_m <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(xL<span class="op">,</span> xR)<span class="op">;</span></span>
<span id="cb2-488"><a href="#cb2-488" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> x1p <span class="op">=</span> <span class="fu">x</span>(xLeft_m)<span class="op">,</span> x2p <span class="op">=</span> <span class="fu">x</span>(xRight_m)<span class="op">;</span></span>
<span id="cb2-489"><a href="#cb2-489" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> yD <span class="op">=</span> baseY <span class="op">+</span> <span class="dv">95</span><span class="op">;</span></span>
<span id="cb2-490"><a href="#cb2-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-491"><a href="#cb2-491" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-492"><a href="#cb2-492" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> x1p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> x2p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD)<span class="op">;</span></span>
<span id="cb2-493"><a href="#cb2-493" aria-hidden="true" tabindex="-1"></a>        [x1p<span class="op">,</span>x2p]<span class="op">.</span><span class="fu">forEach</span>(xx<span class="kw">=&gt;</span>{</span>
<span id="cb2-494"><a href="#cb2-494" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-495"><a href="#cb2-495" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD)<span class="op">;</span></span>
<span id="cb2-496"><a href="#cb2-496" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-497"><a href="#cb2-497" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD<span class="op">-</span><span class="dv">6</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD<span class="op">+</span><span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb2-498"><a href="#cb2-498" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-499"><a href="#cb2-499" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-500"><a href="#cb2-500" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (x1p<span class="op">+</span>x2p)<span class="op">/</span><span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">16</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-501"><a href="#cb2-501" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Horizontal: </span><span class="sc">${</span><span class="fu">fmtSub</span>(Lx_m<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-502"><a href="#cb2-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-503"><a href="#cb2-503" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> leftIn  <span class="op">=</span> (xLeft_m  <span class="op">/</span> IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-504"><a href="#cb2-504" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> rightIn <span class="op">=</span> (xRight_m <span class="op">/</span> IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-505"><a href="#cb2-505" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-506"><a href="#cb2-506" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> x1p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">32</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-507"><a href="#cb2-507" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span>leftIn<span class="sc">}</span><span class="vs"> in`</span>)<span class="op">;</span></span>
<span id="cb2-508"><a href="#cb2-508" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-509"><a href="#cb2-509" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> x2p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">32</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-510"><a href="#cb2-510" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span>rightIn<span class="sc">}</span><span class="vs"> in`</span>)<span class="op">;</span></span>
<span id="cb2-511"><a href="#cb2-511" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-512"><a href="#cb2-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-513"><a href="#cb2-513" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Hover circles (includes end nodes)</span></span>
<span id="cb2-514"><a href="#cb2-514" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> topJoinSorted <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(topJoinIdx)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span>a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb2-515"><a href="#cb2-515" aria-hidden="true" tabindex="-1"></a>      topJoinSorted<span class="op">.</span><span class="fu">forEach</span>((idx) <span class="kw">=&gt;</span> {</span>
<span id="cb2-516"><a href="#cb2-516" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> nd <span class="op">=</span> topNodes[idx]<span class="op">;</span></span>
<span id="cb2-517"><a href="#cb2-517" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> px <span class="op">=</span> <span class="fu">x</span>(nd<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> py <span class="op">=</span> <span class="fu">yScale</span>(nd<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-518"><a href="#cb2-518" aria-hidden="true" tabindex="-1"></a>        nodesG<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"node-ring"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> px)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> py)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb2-519"><a href="#cb2-519" aria-hidden="true" tabindex="-1"></a>        nodesG<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"node-hit"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> px)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> py)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb2-520"><a href="#cb2-520" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseenter"</span><span class="op">,</span> <span class="kw">function</span>(){ d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">previousSibling</span>)<span class="op">.</span><span class="fu">classed</span>(<span class="st">"hot"</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="fu">showTributary</span>(idx)<span class="op">;</span> })</span>
<span id="cb2-521"><a href="#cb2-521" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseleave"</span><span class="op">,</span> <span class="kw">function</span>(){ d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">previousSibling</span>)<span class="op">.</span><span class="fu">classed</span>(<span class="st">"hot"</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> highlight<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span> })<span class="op">;</span></span>
<span id="cb2-522"><a href="#cb2-522" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-523"><a href="#cb2-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-524"><a href="#cb2-524" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-525"><a href="#cb2-525" aria-hidden="true" tabindex="-1"></a>      <span class="co">// === Double Fink (canonical 40 ft; angles preserved) ===</span></span>
<span id="cb2-526"><a href="#cb2-526" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> span_ft <span class="op">=</span> <span class="dv">40</span><span class="op">,</span> span_in <span class="op">=</span> span_ft <span class="op">*</span> <span class="dv">12</span><span class="op">,</span> half_in <span class="op">=</span> span_in<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-527"><a href="#cb2-527" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rise_base_in <span class="op">=</span> <span class="fl">105.958</span><span class="op">;</span>              <span class="co">// given at 40 ft</span></span>
<span id="cb2-528"><a href="#cb2-528" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> slope_per_in <span class="op">=</span> rise_base_in <span class="op">/</span> <span class="dv">240</span><span class="op">;</span>   <span class="co">// per inch of half-span</span></span>
<span id="cb2-529"><a href="#cb2-529" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rise_in <span class="op">=</span> slope_per_in <span class="op">*</span> half_in<span class="op">;</span></span>
<span id="cb2-530"><a href="#cb2-530" aria-hidden="true" tabindex="-1"></a>      rise_m <span class="op">=</span> rise_in <span class="op">*</span> IN<span class="op">;</span></span>
<span id="cb2-531"><a href="#cb2-531" aria-hidden="true" tabindex="-1"></a>      span_m <span class="op">=</span> span_in <span class="op">*</span> IN<span class="op">;</span></span>
<span id="cb2-532"><a href="#cb2-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-533"><a href="#cb2-533" aria-hidden="true" tabindex="-1"></a>      x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> span_m])<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> innerW])<span class="op">;</span></span>
<span id="cb2-534"><a href="#cb2-534" aria-hidden="true" tabindex="-1"></a>      yScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([rise_m <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="dv">0</span><span class="op">,</span> innerH])<span class="op">;</span></span>
<span id="cb2-535"><a href="#cb2-535" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> baseY <span class="op">=</span> <span class="fu">yScale</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-536"><a href="#cb2-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-537"><a href="#cb2-537" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> r <span class="op">=</span> span_in <span class="op">/</span> <span class="dv">480</span><span class="op">;</span></span>
<span id="cb2-538"><a href="#cb2-538" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> top_x_in <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="fl">88.4</span><span class="op">,</span> <span class="fl">164.2</span><span class="op">,</span> <span class="fl">240.0</span><span class="op">,</span> <span class="fl">315.8</span><span class="op">,</span> <span class="fl">391.6</span><span class="op">,</span> <span class="fl">480.0</span>]<span class="op">.</span><span class="fu">map</span>(v <span class="kw">=&gt;</span> v <span class="op">*</span> r)<span class="op">;</span></span>
<span id="cb2-539"><a href="#cb2-539" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> topNodes_in <span class="op">=</span> top_x_in<span class="op">.</span><span class="fu">map</span>((xin<span class="op">,</span> i) <span class="kw">=&gt;</span> ({ i<span class="op">,</span> <span class="dt">xh_in</span><span class="op">:</span> xin<span class="op">,</span> <span class="dt">yh_in</span><span class="op">:</span> slope_per_in <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(xin<span class="op">,</span> span_in <span class="op">-</span> xin) }))<span class="op">;</span></span>
<span id="cb2-540"><a href="#cb2-540" aria-hidden="true" tabindex="-1"></a>      topNodes <span class="op">=</span> topNodes_in<span class="op">.</span><span class="fu">map</span>(({i<span class="op">,</span> xh_in<span class="op">,</span> yh_in}) <span class="kw">=&gt;</span> ({ i<span class="op">,</span> <span class="dt">xh</span><span class="op">:</span> xh_in<span class="op">*</span>IN<span class="op">,</span> <span class="dt">yh</span><span class="op">:</span> yh_in<span class="op">*</span>IN }))<span class="op">;</span></span>
<span id="cb2-541"><a href="#cb2-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-542"><a href="#cb2-542" aria-hidden="true" tabindex="-1"></a>      <span class="co">// chords &amp; baseline</span></span>
<span id="cb2-543"><a href="#cb2-543" aria-hidden="true" tabindex="-1"></a>      g<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"baseline"</span>)</span>
<span id="cb2-544"><a href="#cb2-544" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(span_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> baseY)<span class="op">;</span></span>
<span id="cb2-545"><a href="#cb2-545" aria-hidden="true" tabindex="-1"></a>      chords<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"chord-bot"</span>)</span>
<span id="cb2-546"><a href="#cb2-546" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">x</span>(d<span class="kw">=&gt;</span>d[<span class="dv">0</span>])<span class="op">.</span><span class="fu">y</span>(d<span class="kw">=&gt;</span>d[<span class="dv">1</span>])([[<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">,</span> baseY]<span class="op">,</span>[<span class="fu">x</span>(span_m)<span class="op">,</span> baseY]]) )<span class="op">;</span></span>
<span id="cb2-547"><a href="#cb2-547" aria-hidden="true" tabindex="-1"></a>      chords<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"chord-top"</span>)</span>
<span id="cb2-548"><a href="#cb2-548" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">x</span>(d<span class="kw">=&gt;</span><span class="fu">x</span>(d<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">y</span>(d<span class="kw">=&gt;</span><span class="fu">yScale</span>(d<span class="op">.</span><span class="at">yh</span>))(topNodes))<span class="op">;</span></span>
<span id="cb2-549"><a href="#cb2-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-550"><a href="#cb2-550" aria-hidden="true" tabindex="-1"></a>      <span class="co">// webs per canonical mapping</span></span>
<span id="cb2-551"><a href="#cb2-551" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bpt <span class="op">=</span> xin <span class="kw">=&gt;</span> ({ <span class="dt">xh</span><span class="op">:</span> xin<span class="op">*</span>IN<span class="op">,</span> <span class="dt">yh</span><span class="op">:</span> <span class="dv">0</span> })<span class="op">;</span></span>
<span id="cb2-552"><a href="#cb2-552" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> T <span class="op">=</span> topNodes<span class="op">;</span></span>
<span id="cb2-553"><a href="#cb2-553" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> C_top   <span class="op">=</span> T[<span class="dv">3</span>]<span class="op">,</span> L1_top <span class="op">=</span> T[<span class="dv">1</span>]<span class="op">,</span> L2L3_top <span class="op">=</span> T[<span class="dv">2</span>]<span class="op">,</span> R2R3_top <span class="op">=</span> T[<span class="dv">4</span>]<span class="op">,</span> R1_top <span class="op">=</span> T[<span class="dv">5</span>]<span class="op">;</span></span>
<span id="cb2-554"><a href="#cb2-554" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> b_mid   <span class="op">=</span> <span class="fu">bpt</span>(<span class="fl">240.0</span> <span class="op">*</span> r)<span class="op">;</span></span>
<span id="cb2-555"><a href="#cb2-555" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> b_10356 <span class="op">=</span> <span class="fu">bpt</span>(<span class="fl">103.56</span> <span class="op">*</span> r)<span class="op">,</span> b_19452 <span class="op">=</span> <span class="fu">bpt</span>(<span class="fl">194.52</span> <span class="op">*</span> r)<span class="op">;</span></span>
<span id="cb2-556"><a href="#cb2-556" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> b_28548 <span class="op">=</span> <span class="fu">bpt</span>(<span class="fl">285.48</span> <span class="op">*</span> r)<span class="op">,</span> b_37644 <span class="op">=</span> <span class="fu">bpt</span>(<span class="fl">376.44</span> <span class="op">*</span> r)<span class="op">;</span></span>
<span id="cb2-557"><a href="#cb2-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-558"><a href="#cb2-558" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Left diagonals</span></span>
<span id="cb2-559"><a href="#cb2-559" aria-hidden="true" tabindex="-1"></a>      [[L1_top<span class="op">,</span> b_10356]<span class="op">,</span>[L2L3_top<span class="op">,</span> b_10356]<span class="op">,</span>[L2L3_top<span class="op">,</span> b_19452]<span class="op">,</span>[C_top<span class="op">,</span> b_19452]]<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-560"><a href="#cb2-560" aria-hidden="true" tabindex="-1"></a>        websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-561"><a href="#cb2-561" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-562"><a href="#cb2-562" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-563"><a href="#cb2-563" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-564"><a href="#cb2-564" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Center vertical</span></span>
<span id="cb2-565"><a href="#cb2-565" aria-hidden="true" tabindex="-1"></a>      websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-566"><a href="#cb2-566" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(C_top<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(C_top<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-567"><a href="#cb2-567" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(b_mid<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(b_mid<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-568"><a href="#cb2-568" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Right diagonals</span></span>
<span id="cb2-569"><a href="#cb2-569" aria-hidden="true" tabindex="-1"></a>      [[R1_top<span class="op">,</span> b_37644]<span class="op">,</span>[R2R3_top<span class="op">,</span> b_37644]<span class="op">,</span>[R2R3_top<span class="op">,</span> b_28548]<span class="op">,</span>[C_top<span class="op">,</span> b_28548]]<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-570"><a href="#cb2-570" aria-hidden="true" tabindex="-1"></a>        websG<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"web"</span>)</span>
<span id="cb2-571"><a href="#cb2-571" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-572"><a href="#cb2-572" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-573"><a href="#cb2-573" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-574"><a href="#cb2-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-575"><a href="#cb2-575" aria-hidden="true" tabindex="-1"></a>      <span class="co">// include end nodes</span></span>
<span id="cb2-576"><a href="#cb2-576" aria-hidden="true" tabindex="-1"></a>      topJoinIdx <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>([<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">6</span>])<span class="op">;</span></span>
<span id="cb2-577"><a href="#cb2-577" aria-hidden="true" tabindex="-1"></a>      topS <span class="op">=</span> <span class="fu">accumulateArc</span>(topNodes)<span class="op">;</span></span>
<span id="cb2-578"><a href="#cb2-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-579"><a href="#cb2-579" aria-hidden="true" tabindex="-1"></a>      <span class="co">// per-panel dims (sub-dimensions)</span></span>
<span id="cb2-580"><a href="#cb2-580" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> k <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> k <span class="op">&lt;</span> topNodes<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> k<span class="op">++</span>) {</span>
<span id="cb2-581"><a href="#cb2-581" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawDimAlongChord</span>(topNodes<span class="op">,</span> k<span class="op">,</span> dims<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-582"><a href="#cb2-582" aria-hidden="true" tabindex="-1"></a>        <span class="fu">drawDimHorizontal</span>(topNodes<span class="op">,</span> k<span class="op">,</span> dims<span class="op">,</span> baseY<span class="op">,</span> <span class="dv">28</span><span class="op">,</span> unitsMode<span class="op">,</span> x)<span class="op">;</span></span>
<span id="cb2-583"><a href="#cb2-583" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-584"><a href="#cb2-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-585"><a href="#cb2-585" aria-hidden="true" tabindex="-1"></a>      <span class="co">// total span dim</span></span>
<span id="cb2-586"><a href="#cb2-586" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> yD_total <span class="op">=</span> baseY <span class="op">+</span> <span class="dv">70</span><span class="op">;</span></span>
<span id="cb2-587"><a href="#cb2-587" aria-hidden="true" tabindex="-1"></a>      dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dim dim-total"</span>)</span>
<span id="cb2-588"><a href="#cb2-588" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD_total)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(span_m))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD_total)<span class="op">;</span></span>
<span id="cb2-589"><a href="#cb2-589" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span><span class="op">,</span> span_m]<span class="op">.</span><span class="fu">forEach</span>(X<span class="kw">=&gt;</span>{</span>
<span id="cb2-590"><a href="#cb2-590" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"ext"</span>)</span>
<span id="cb2-591"><a href="#cb2-591" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(X))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(X))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD_total)<span class="op">;</span></span>
<span id="cb2-592"><a href="#cb2-592" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-593"><a href="#cb2-593" aria-hidden="true" tabindex="-1"></a>      [[<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">,</span>yD_total]<span class="op">,</span>[<span class="fu">x</span>(span_m)<span class="op">,</span>yD_total]]<span class="op">.</span><span class="fu">forEach</span>(([xx<span class="op">,</span>yy])<span class="kw">=&gt;</span>{</span>
<span id="cb2-594"><a href="#cb2-594" aria-hidden="true" tabindex="-1"></a>        dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tick"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yy<span class="op">-</span><span class="dv">6</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yy<span class="op">+</span><span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb2-595"><a href="#cb2-595" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-596"><a href="#cb2-596" aria-hidden="true" tabindex="-1"></a>      dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label"</span>)</span>
<span id="cb2-597"><a href="#cb2-597" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (<span class="fu">x</span>(<span class="dv">0</span>)<span class="op">+</span><span class="fu">x</span>(span_m))<span class="op">/</span><span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD_total <span class="op">-</span> <span class="dv">10</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-598"><a href="#cb2-598" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span><span class="fu">fmtSpan</span>(span_m<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs"> (horizontal span)`</span>)<span class="op">;</span></span>
<span id="cb2-599"><a href="#cb2-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-600"><a href="#cb2-600" aria-hidden="true" tabindex="-1"></a>      <span class="co">// top-chord true length label (slanted, left half, ~85px off)</span></span>
<span id="cb2-601"><a href="#cb2-601" aria-hidden="true" tabindex="-1"></a>      <span class="fu">placeTopChordLengthLabel</span>(topNodes<span class="op">,</span> topS<span class="op">,</span> dims<span class="op">,</span> unitsMode<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-602"><a href="#cb2-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-603"><a href="#cb2-603" aria-hidden="true" tabindex="-1"></a>      <span class="co">// NEW: diagonal-chord dim (left top chord) below the label</span></span>
<span id="cb2-604"><a href="#cb2-604" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drawLeftTopChordDiagDim</span>(topNodes<span class="op">,</span> dims<span class="op">,</span> x<span class="op">,</span> yScale)<span class="op">;</span></span>
<span id="cb2-605"><a href="#cb2-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-606"><a href="#cb2-606" aria-hidden="true" tabindex="-1"></a>      <span class="co">// apex-height dim at left (short equal stubs; vertical label)</span></span>
<span id="cb2-607"><a href="#cb2-607" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drawApexHeightDim</span>(dims<span class="op">,</span> x<span class="op">,</span> yScale<span class="op">,</span> span_m<span class="op">,</span> rise_m<span class="op">,</span> unitsMode)<span class="op">;</span></span>
<span id="cb2-608"><a href="#cb2-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-609"><a href="#cb2-609" aria-hidden="true" tabindex="-1"></a>      <span class="co">// color scale</span></span>
<span id="cb2-610"><a href="#cb2-610" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> colorScale <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>()</span>
<span id="cb2-611"><a href="#cb2-611" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">domain</span>(d3<span class="op">.</span><span class="fu">range</span>(topS<span class="op">.</span><span class="at">length</span>))</span>
<span id="cb2-612"><a href="#cb2-612" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">range</span>([<span class="st">"#2563eb"</span><span class="op">,</span><span class="st">"#dc2626"</span><span class="op">,</span><span class="st">"#16a34a"</span><span class="op">,</span><span class="st">"#a855f7"</span><span class="op">,</span><span class="st">"#ea580c"</span><span class="op">,</span><span class="st">"#0891b2"</span><span class="op">,</span><span class="st">"#eab308"</span><span class="op">,</span><span class="st">"#0ea5e9"</span><span class="op">,</span><span class="st">"#f97316"</span><span class="op">,</span><span class="st">"#22c55e"</span><span class="op">,</span><span class="st">"#ef4444"</span>])<span class="op">;</span></span>
<span id="cb2-613"><a href="#cb2-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-614"><a href="#cb2-614" aria-hidden="true" tabindex="-1"></a>      <span class="kw">function</span> <span class="fu">showTributary</span>(iNode) {</span>
<span id="cb2-615"><a href="#cb2-615" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb2-616"><a href="#cb2-616" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> color <span class="op">=</span> <span class="fu">colorScale</span>(iNode)<span class="op">;</span></span>
<span id="cb2-617"><a href="#cb2-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-618"><a href="#cb2-618" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Along-chord span (Fink rule: along-chord halves between neighbors)</span></span>
<span id="cb2-619"><a href="#cb2-619" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> s_i   <span class="op">=</span> topS[iNode]<span class="op">.</span><span class="at">s</span><span class="op">;</span></span>
<span id="cb2-620"><a href="#cb2-620" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> s_prev <span class="op">=</span> iNode <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> topS[iNode<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">s</span> <span class="op">:</span> s_i<span class="op">;</span></span>
<span id="cb2-621"><a href="#cb2-621" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> s_next <span class="op">=</span> iNode <span class="op">&lt;</span> topS<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span> <span class="op">?</span> topS[iNode<span class="op">+</span><span class="dv">1</span>]<span class="op">.</span><span class="at">s</span> <span class="op">:</span> s_i<span class="op">;</span></span>
<span id="cb2-622"><a href="#cb2-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-623"><a href="#cb2-623" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> s0<span class="op">,</span> s1<span class="op">;</span></span>
<span id="cb2-624"><a href="#cb2-624" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (iNode <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb2-625"><a href="#cb2-625" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> s_i<span class="op">;</span></span>
<span id="cb2-626"><a href="#cb2-626" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> s_i <span class="op">+</span> <span class="fl">0.5</span><span class="op">*</span>(s_next <span class="op">-</span> s_i)<span class="op">;</span></span>
<span id="cb2-627"><a href="#cb2-627" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (iNode <span class="op">===</span> topS<span class="op">.</span><span class="at">length</span><span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb2-628"><a href="#cb2-628" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> s_i <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>(s_i <span class="op">-</span> s_prev)<span class="op">;</span></span>
<span id="cb2-629"><a href="#cb2-629" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> s_i<span class="op">;</span></span>
<span id="cb2-630"><a href="#cb2-630" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb2-631"><a href="#cb2-631" aria-hidden="true" tabindex="-1"></a>          s0 <span class="op">=</span> (s_prev <span class="op">+</span> s_i)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-632"><a href="#cb2-632" aria-hidden="true" tabindex="-1"></a>          s1 <span class="op">=</span> (s_i <span class="op">+</span> s_next)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-633"><a href="#cb2-633" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-634"><a href="#cb2-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-635"><a href="#cb2-635" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> segs <span class="op">=</span> <span class="fu">slicePolylineByS</span>(topS<span class="op">,</span> s0<span class="op">,</span> s1)<span class="op">;</span></span>
<span id="cb2-636"><a href="#cb2-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-637"><a href="#cb2-637" aria-hidden="true" tabindex="-1"></a>        segs<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-638"><a href="#cb2-638" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-639"><a href="#cb2-639" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))</span>
<span id="cb2-640"><a href="#cb2-640" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> <span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> <span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-641"><a href="#cb2-641" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-642"><a href="#cb2-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-643"><a href="#cb2-643" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Metrics &amp; label placement</span></span>
<span id="cb2-644"><a href="#cb2-644" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> L_along <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> Xc <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> Yc <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> sumDXp <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> sumDYp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-645"><a href="#cb2-645" aria-hidden="true" tabindex="-1"></a>        segs<span class="op">.</span><span class="fu">forEach</span>(([P<span class="op">,</span>Q])<span class="kw">=&gt;</span>{</span>
<span id="cb2-646"><a href="#cb2-646" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> ds <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(Q<span class="op">.</span><span class="at">xh</span> <span class="op">-</span> P<span class="op">.</span><span class="at">xh</span><span class="op">,</span> Q<span class="op">.</span><span class="at">yh</span> <span class="op">-</span> P<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-647"><a href="#cb2-647" aria-hidden="true" tabindex="-1"></a>          L_along <span class="op">+=</span> ds<span class="op">;</span></span>
<span id="cb2-648"><a href="#cb2-648" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> xm <span class="op">=</span> (P<span class="op">.</span><span class="at">xh</span> <span class="op">+</span> Q<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">,</span> ym <span class="op">=</span> (P<span class="op">.</span><span class="at">yh</span> <span class="op">+</span> Q<span class="op">.</span><span class="at">yh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-649"><a href="#cb2-649" aria-hidden="true" tabindex="-1"></a>          Xc <span class="op">+=</span> xm <span class="op">*</span> ds<span class="op">;</span> Yc <span class="op">+=</span> ym <span class="op">*</span> ds<span class="op">;</span></span>
<span id="cb2-650"><a href="#cb2-650" aria-hidden="true" tabindex="-1"></a>          sumDXp <span class="op">+=</span> (<span class="fu">x</span>(Q<span class="op">.</span><span class="at">xh</span>) <span class="op">-</span> <span class="fu">x</span>(P<span class="op">.</span><span class="at">xh</span>))<span class="op">;</span></span>
<span id="cb2-651"><a href="#cb2-651" aria-hidden="true" tabindex="-1"></a>          sumDYp <span class="op">+=</span> (<span class="fu">yScale</span>(Q<span class="op">.</span><span class="at">yh</span>) <span class="op">-</span> <span class="fu">yScale</span>(P<span class="op">.</span><span class="at">yh</span>))<span class="op">;</span></span>
<span id="cb2-652"><a href="#cb2-652" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-653"><a href="#cb2-653" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (L_along <span class="op">&gt;</span> <span class="dv">0</span>) { Xc <span class="op">/=</span> L_along<span class="op">;</span> Yc <span class="op">/=</span> L_along<span class="op">;</span> }</span>
<span id="cb2-654"><a href="#cb2-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-655"><a href="#cb2-655" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> Lp <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(sumDXp<span class="op">,</span> sumDYp) <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-656"><a href="#cb2-656" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> nx <span class="op">=</span> <span class="op">-</span>sumDYp <span class="op">/</span> Lp<span class="op">,</span> ny <span class="op">=</span> sumDXp <span class="op">/</span> Lp<span class="op">;</span></span>
<span id="cb2-657"><a href="#cb2-657" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> sign <span class="op">=</span> (ny <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-658"><a href="#cb2-658" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> offAlong <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> offNode <span class="op">=</span> <span class="dv">74</span><span class="op">;</span></span>
<span id="cb2-659"><a href="#cb2-659" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> angleDeg <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span>(sumDYp<span class="op">,</span> sumDXp) <span class="op">*</span> <span class="dv">180</span><span class="op">/</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">;</span></span>
<span id="cb2-660"><a href="#cb2-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-661"><a href="#cb2-661" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tx <span class="op">=</span> <span class="fu">x</span>(Xc) <span class="op">+</span> nx <span class="op">*</span> offAlong <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-662"><a href="#cb2-662" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> ty <span class="op">=</span> <span class="fu">yScale</span>(Yc) <span class="op">+</span> ny <span class="op">*</span> offAlong <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-663"><a href="#cb2-663" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-664"><a href="#cb2-664" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)</span>
<span id="cb2-665"><a href="#cb2-665" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-666"><a href="#cb2-666" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-667"><a href="#cb2-667" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>tx<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>ty<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>angleDeg<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb2-668"><a href="#cb2-668" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Along chord: </span><span class="sc">${</span><span class="fu">fmtSub</span>(L_along<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-669"><a href="#cb2-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-670"><a href="#cb2-670" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tx2 <span class="op">=</span> <span class="fu">x</span>(Xc) <span class="op">+</span> nx <span class="op">*</span> offNode <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-671"><a href="#cb2-671" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> ty2 <span class="op">=</span> <span class="fu">yScale</span>(Yc) <span class="op">+</span> ny <span class="op">*</span> offNode <span class="op">*</span> sign<span class="op">;</span></span>
<span id="cb2-672"><a href="#cb2-672" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-673"><a href="#cb2-673" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)</span>
<span id="cb2-674"><a href="#cb2-674" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-675"><a href="#cb2-675" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-676"><a href="#cb2-676" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>tx2<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>ty2<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>angleDeg<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb2-677"><a href="#cb2-677" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Node </span><span class="sc">${</span>iNode<span class="sc">}</span><span class="vs"> tributary`</span>)<span class="op">;</span></span>
<span id="cb2-678"><a href="#cb2-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-679"><a href="#cb2-679" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Horizontal projection</span></span>
<span id="cb2-680"><a href="#cb2-680" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> n <span class="op">=</span> topNodes<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb2-681"><a href="#cb2-681" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xH <span class="op">=</span> topNodes[iNode]<span class="op">.</span><span class="at">xh</span><span class="op">;</span></span>
<span id="cb2-682"><a href="#cb2-682" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xL <span class="op">=</span> (iNode <span class="op">===</span> <span class="dv">0</span>)     <span class="op">?</span> xH <span class="op">:</span> (xH <span class="op">+</span> topNodes[iNode<span class="op">-</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-683"><a href="#cb2-683" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xR <span class="op">=</span> (iNode <span class="op">===</span> n<span class="op">-</span><span class="dv">1</span>)   <span class="op">?</span> xH <span class="op">:</span> (xH <span class="op">+</span> topNodes[iNode<span class="op">+</span><span class="dv">1</span>]<span class="op">.</span><span class="at">xh</span>)<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb2-684"><a href="#cb2-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-685"><a href="#cb2-685" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> Lx_m <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(xR <span class="op">-</span> xL)<span class="op">;</span></span>
<span id="cb2-686"><a href="#cb2-686" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xLeft_m  <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(xL<span class="op">,</span> xR)<span class="op">;</span></span>
<span id="cb2-687"><a href="#cb2-687" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> xRight_m <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(xL<span class="op">,</span> xR)<span class="op">;</span></span>
<span id="cb2-688"><a href="#cb2-688" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> x1p <span class="op">=</span> <span class="fu">x</span>(xLeft_m)<span class="op">,</span> x2p <span class="op">=</span> <span class="fu">x</span>(xRight_m)<span class="op">;</span></span>
<span id="cb2-689"><a href="#cb2-689" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> yD <span class="op">=</span> baseY <span class="op">+</span> <span class="dv">95</span><span class="op">;</span></span>
<span id="cb2-690"><a href="#cb2-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-691"><a href="#cb2-691" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-692"><a href="#cb2-692" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> x1p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> x2p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD)<span class="op">;</span></span>
<span id="cb2-693"><a href="#cb2-693" aria-hidden="true" tabindex="-1"></a>        [x1p<span class="op">,</span>x2p]<span class="op">.</span><span class="fu">forEach</span>(xx<span class="kw">=&gt;</span>{</span>
<span id="cb2-694"><a href="#cb2-694" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-695"><a href="#cb2-695" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> baseY)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD)<span class="op">;</span></span>
<span id="cb2-696"><a href="#cb2-696" aria-hidden="true" tabindex="-1"></a>          highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"tribu-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> color)</span>
<span id="cb2-697"><a href="#cb2-697" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> yD<span class="op">-</span><span class="dv">6</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> xx)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> yD<span class="op">+</span><span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb2-698"><a href="#cb2-698" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb2-699"><a href="#cb2-699" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-700"><a href="#cb2-700" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> (x1p<span class="op">+</span>x2p)<span class="op">/</span><span class="dv">2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">16</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-701"><a href="#cb2-701" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Horizontal: </span><span class="sc">${</span><span class="fu">fmtSub</span>(Lx_m<span class="op">,</span> unitsMode)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-702"><a href="#cb2-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-703"><a href="#cb2-703" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> leftIn  <span class="op">=</span> (xLeft_m  <span class="op">/</span> IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-704"><a href="#cb2-704" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> rightIn <span class="op">=</span> (xRight_m <span class="op">/</span> IN)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb2-705"><a href="#cb2-705" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-706"><a href="#cb2-706" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> x1p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">32</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-707"><a href="#cb2-707" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span>leftIn<span class="sc">}</span><span class="vs"> in`</span>)<span class="op">;</span></span>
<span id="cb2-708"><a href="#cb2-708" aria-hidden="true" tabindex="-1"></a>        highlight<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"label-dim"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> color)</span>
<span id="cb2-709"><a href="#cb2-709" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> x2p)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> yD <span class="op">+</span> <span class="dv">32</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb2-710"><a href="#cb2-710" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>(<span class="vs">`</span><span class="sc">${</span>rightIn<span class="sc">}</span><span class="vs"> in`</span>)<span class="op">;</span></span>
<span id="cb2-711"><a href="#cb2-711" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-712"><a href="#cb2-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-713"><a href="#cb2-713" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Hover circles (includes end nodes)</span></span>
<span id="cb2-714"><a href="#cb2-714" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> topJoinSorted <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(topJoinIdx)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span>b)<span class="kw">=&gt;</span>a<span class="op">-</span>b)<span class="op">;</span></span>
<span id="cb2-715"><a href="#cb2-715" aria-hidden="true" tabindex="-1"></a>      topJoinSorted<span class="op">.</span><span class="fu">forEach</span>((idx) <span class="kw">=&gt;</span> {</span>
<span id="cb2-716"><a href="#cb2-716" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> nd <span class="op">=</span> topNodes[idx]<span class="op">;</span></span>
<span id="cb2-717"><a href="#cb2-717" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> px <span class="op">=</span> <span class="fu">x</span>(nd<span class="op">.</span><span class="at">xh</span>)<span class="op">,</span> py <span class="op">=</span> <span class="fu">yScale</span>(nd<span class="op">.</span><span class="at">yh</span>)<span class="op">;</span></span>
<span id="cb2-718"><a href="#cb2-718" aria-hidden="true" tabindex="-1"></a>        nodesG<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"node-ring"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> px)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> py)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb2-719"><a href="#cb2-719" aria-hidden="true" tabindex="-1"></a>        nodesG<span class="op">.</span><span class="fu">append</span>(<span class="st">"circle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"node-hit"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> px)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> py)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb2-720"><a href="#cb2-720" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseenter"</span><span class="op">,</span> <span class="kw">function</span>(){ d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">previousSibling</span>)<span class="op">.</span><span class="fu">classed</span>(<span class="st">"hot"</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="fu">showTributary</span>(idx)<span class="op">;</span> })</span>
<span id="cb2-721"><a href="#cb2-721" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseleave"</span><span class="op">,</span> <span class="kw">function</span>(){ d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">previousSibling</span>)<span class="op">.</span><span class="fu">classed</span>(<span class="st">"hot"</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> highlight<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span> })<span class="op">;</span></span>
<span id="cb2-722"><a href="#cb2-722" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-723"><a href="#cb2-723" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-724"><a href="#cb2-724" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-725"><a href="#cb2-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-726"><a href="#cb2-726" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initial render &amp; control wiring</span></span>
<span id="cb2-727"><a href="#cb2-727" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">rerender</span>() {</span>
<span id="cb2-728"><a href="#cb2-728" aria-hidden="true" tabindex="-1"></a>    <span class="fu">render</span>(selectTruss<span class="op">.</span><span class="fu">property</span>(<span class="st">"value"</span>)<span class="op">,</span> selectUnits<span class="op">.</span><span class="fu">property</span>(<span class="st">"value"</span>))<span class="op">;</span></span>
<span id="cb2-729"><a href="#cb2-729" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-730"><a href="#cb2-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rerender</span>()<span class="op">;</span></span>
<span id="cb2-731"><a href="#cb2-731" aria-hidden="true" tabindex="-1"></a>  selectTruss<span class="op">.</span><span class="fu">on</span>(<span class="st">"change"</span><span class="op">,</span> rerender)<span class="op">;</span></span>
<span id="cb2-732"><a href="#cb2-732" aria-hidden="true" tabindex="-1"></a>  selectUnits<span class="op">.</span><span class="fu">on</span>(<span class="st">"change"</span><span class="op">,</span> rerender)<span class="op">;</span></span>
<span id="cb2-733"><a href="#cb2-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-734"><a href="#cb2-734" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return DOM node so Quarto renders the UI + SVG</span></span>
<span id="cb2-735"><a href="#cb2-735" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> container<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span>   <span class="co">// &lt;-- not 'svg', not 'svg;'</span></span>
<span id="cb2-736"><a href="#cb2-736" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="expression">

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb3" data-startfrom="741" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 740;"><span id="cb3-741"><a href="#cb3-741" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-742"><a href="#cb3-742" aria-hidden="true" tabindex="-1"></a>  <span class="co">// === Three-Truss Roof: Tributary Areas &amp; Dead-Load Expressions (isometric, colinear extensions) ===</span></span>
<span id="cb3-743"><a href="#cb3-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-744"><a href="#cb3-744" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-745"><a href="#cb3-745" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Basic geometry</span></span>
<span id="cb3-746"><a href="#cb3-746" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-747"><a href="#cb3-747" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> span_in <span class="op">=</span> <span class="dv">40</span> <span class="op">*</span> <span class="dv">12</span><span class="op">;</span>           <span class="co">// 40 ft span (in)</span></span>
<span id="cb3-748"><a href="#cb3-748" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> half_in <span class="op">=</span> span_in <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-749"><a href="#cb3-749" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> rise_in <span class="op">=</span> (<span class="dv">6</span><span class="op">/</span><span class="dv">12</span>) <span class="op">*</span> half_in<span class="op">;</span>  <span class="co">// 6:12 pitch -&gt; 120 in</span></span>
<span id="cb3-750"><a href="#cb3-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-751"><a href="#cb3-751" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> L_units <span class="op">=</span> <span class="dv">900</span><span class="op">;</span>               <span class="co">// displayed ridge run (symbolic L)</span></span>
<span id="cb3-752"><a href="#cb3-752" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> D_units <span class="op">=</span> L_units <span class="op">/</span> <span class="dv">2</span><span class="op">;</span>       <span class="co">// truss spacing "L/2" (display only)</span></span>
<span id="cb3-753"><a href="#cb3-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-754"><a href="#cb3-754" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-755"><a href="#cb3-755" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Isometric projection</span></span>
<span id="cb3-756"><a href="#cb3-756" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-757"><a href="#cb3-757" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> deg <span class="op">=</span> d <span class="kw">=&gt;</span> d <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">/</span> <span class="dv">180</span><span class="op">;</span></span>
<span id="cb3-758"><a href="#cb3-758" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> phiX <span class="op">=</span> <span class="fu">deg</span>(<span class="dv">30</span>)<span class="op">,</span> phiY <span class="op">=</span> <span class="fu">deg</span>(<span class="dv">150</span>)<span class="op">,</span> phiZ <span class="op">=</span> <span class="fu">deg</span>(<span class="dv">90</span>)<span class="op">;</span></span>
<span id="cb3-759"><a href="#cb3-759" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ux <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(phiX)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(phiX) }<span class="op">;</span>   <span class="co">// span (x)</span></span>
<span id="cb3-760"><a href="#cb3-760" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uy <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(phiY)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(phiY) }<span class="op">;</span>   <span class="co">// ridge (y)</span></span>
<span id="cb3-761"><a href="#cb3-761" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> uz <span class="op">=</span> { <span class="dt">x</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">cos</span>(phiZ)<span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sin</span>(phiZ) }<span class="op">;</span>   <span class="co">// vertical (z)</span></span>
<span id="cb3-762"><a href="#cb3-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-763"><a href="#cb3-763" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> W <span class="op">=</span> <span class="dv">1500</span><span class="op">,</span> H <span class="op">=</span> <span class="dv">840</span><span class="op">;</span></span>
<span id="cb3-764"><a href="#cb3-764" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> margin <span class="op">=</span> {<span class="dt">top</span><span class="op">:</span> <span class="dv">24</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span> <span class="dv">56</span><span class="op">,</span> <span class="dt">bottom</span><span class="op">:</span> <span class="dv">24</span><span class="op">,</span> <span class="dt">left</span><span class="op">:</span> <span class="dv">72</span>}<span class="op">;</span></span>
<span id="cb3-765"><a href="#cb3-765" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> innerW <span class="op">=</span> W <span class="op">-</span> margin<span class="op">.</span><span class="at">left</span> <span class="op">-</span> margin<span class="op">.</span><span class="at">right</span><span class="op">;</span></span>
<span id="cb3-766"><a href="#cb3-766" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> innerH <span class="op">=</span> H <span class="op">-</span> margin<span class="op">.</span><span class="at">top</span> <span class="op">-</span> margin<span class="op">.</span><span class="at">bottom</span><span class="op">;</span></span>
<span id="cb3-767"><a href="#cb3-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-768"><a href="#cb3-768" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"viz-wrap"</span>)<span class="op">;</span></span>
<span id="cb3-769"><a href="#cb3-769" aria-hidden="true" tabindex="-1"></a>  container<span class="op">.</span><span class="fu">append</span>(<span class="st">"h3"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"Three-Truss Roof: Dead-Load Tributary Areas (isometric)"</span>)<span class="op">;</span></span>
<span id="cb3-770"><a href="#cb3-770" aria-hidden="true" tabindex="-1"></a>  container<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb3-771"><a href="#cb3-771" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"margin"</span><span class="op">,</span><span class="st">"2px 0 10px 0"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#4b5563"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"14px"</span>)</span>
<span id="cb3-772"><a href="#cb3-772" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">"40-ft double Howe trusses @ &lt;b&gt;6/12&lt;/b&gt; pitch. Ridge length shown as &lt;b&gt;L&lt;/b&gt;; truss spacing is &lt;b&gt;L/2&lt;/b&gt; (depth exaggerated)."</span>)<span class="op">;</span></span>
<span id="cb3-773"><a href="#cb3-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-774"><a href="#cb3-774" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> container<span class="op">.</span><span class="fu">append</span>(<span class="st">"svg"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span>W<span class="op">,</span>H]<span class="op">.</span><span class="fu">join</span>(<span class="st">" "</span>))<span class="op">;</span></span>
<span id="cb3-775"><a href="#cb3-775" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g   <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">left</span><span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>margin<span class="op">.</span><span class="at">top</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb3-776"><a href="#cb3-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-777"><a href="#cb3-777" aria-hidden="true" tabindex="-1"></a>  <span class="co">// scale factors: keep z==x for pitch fidelity; widen ridge depth 1.5x</span></span>
<span id="cb3-778"><a href="#cb3-778" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kx <span class="op">=</span> (innerW <span class="op">*</span> <span class="fl">0.62</span>) <span class="op">/</span> span_in<span class="op">;</span></span>
<span id="cb3-779"><a href="#cb3-779" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> kz <span class="op">=</span> kx<span class="op">;</span></span>
<span id="cb3-780"><a href="#cb3-780" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ky <span class="op">=</span> <span class="fl">1.5</span> <span class="op">*</span> (innerW <span class="op">*</span> <span class="fl">0.26</span>) <span class="op">/</span> L_units<span class="op">;</span></span>
<span id="cb3-781"><a href="#cb3-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-782"><a href="#cb3-782" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">P0</span>(x_in<span class="op">,</span> y_u<span class="op">,</span> z_in){</span>
<span id="cb3-783"><a href="#cb3-783" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> X <span class="op">=</span> x_in <span class="op">*</span> kx <span class="op">*</span> ux<span class="op">.</span><span class="at">x</span> <span class="op">+</span> y_u <span class="op">*</span> ky <span class="op">*</span> uy<span class="op">.</span><span class="at">x</span> <span class="op">+</span> z_in <span class="op">*</span> kz <span class="op">*</span> uz<span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb3-784"><a href="#cb3-784" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Ym <span class="op">=</span> x_in <span class="op">*</span> kx <span class="op">*</span> ux<span class="op">.</span><span class="at">y</span> <span class="op">+</span> y_u <span class="op">*</span> ky <span class="op">*</span> uy<span class="op">.</span><span class="at">y</span> <span class="op">+</span> z_in <span class="op">*</span> kz <span class="op">*</span> uz<span class="op">.</span><span class="at">y</span><span class="op">;</span> <span class="co">// up-positive</span></span>
<span id="cb3-785"><a href="#cb3-785" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [X<span class="op">,</span> <span class="op">-</span>Ym]<span class="op">;</span></span>
<span id="cb3-786"><a href="#cb3-786" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-787"><a href="#cb3-787" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> PX <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span> <span class="fu">P0</span>(x<span class="op">,</span>y<span class="op">,</span>z)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-788"><a href="#cb3-788" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> PY <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span> <span class="fu">P0</span>(x<span class="op">,</span>y<span class="op">,</span>z)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb3-789"><a href="#cb3-789" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> screenPt <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span>[<span class="fu">PX</span>(x<span class="op">,</span>y<span class="op">,</span>z)<span class="op">,</span> <span class="fu">PY</span>(x<span class="op">,</span>y<span class="op">,</span>z)]<span class="op">;</span></span>
<span id="cb3-790"><a href="#cb3-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-791"><a href="#cb3-791" aria-hidden="true" tabindex="-1"></a>  <span class="co">// helpers</span></span>
<span id="cb3-792"><a href="#cb3-792" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> DIM <span class="op">=</span> <span class="st">"#cbd5e1"</span><span class="op">;</span></span>
<span id="cb3-793"><a href="#cb3-793" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vnorm <span class="op">=</span> (dx<span class="op">,</span>dy)<span class="kw">=&gt;</span>{ <span class="kw">const</span> L <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(dx<span class="op">,</span>dy)<span class="op">||</span><span class="dv">1</span><span class="op">;</span> <span class="cf">return</span> [dx<span class="op">/</span>L<span class="op">,</span> dy<span class="op">/</span>L]<span class="op">;</span> }<span class="op">;</span></span>
<span id="cb3-794"><a href="#cb3-794" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> addTick <span class="op">=</span> (G<span class="op">,</span>x<span class="op">,</span>y<span class="op">,</span>vx<span class="op">,</span>vy<span class="op">,</span>len)<span class="kw">=&gt;</span>{ <span class="kw">const</span> [uxx<span class="op">,</span>uyy]<span class="op">=</span><span class="fu">vnorm</span>(vx<span class="op">,</span>vy)<span class="op">;</span></span>
<span id="cb3-795"><a href="#cb3-795" aria-hidden="true" tabindex="-1"></a>    G<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-796"><a href="#cb3-796" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> x<span class="op">-</span>uxx<span class="op">*</span>len)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> y<span class="op">-</span>uyy<span class="op">*</span>len)</span>
<span id="cb3-797"><a href="#cb3-797" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> x<span class="op">+</span>uxx<span class="op">*</span>len)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> y<span class="op">+</span>uyy<span class="op">*</span>len)</span>
<span id="cb3-798"><a href="#cb3-798" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">1.2</span>)<span class="op">;</span></span>
<span id="cb3-799"><a href="#cb3-799" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-800"><a href="#cb3-800" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bcDirLeft <span class="op">=</span> (y)<span class="kw">=&gt;</span>{ <span class="kw">const</span> A<span class="op">=</span><span class="fu">screenPt</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> B<span class="op">=</span><span class="fu">screenPt</span>(<span class="op">-</span><span class="dv">10</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)<span class="op">;</span> <span class="cf">return</span> <span class="fu">vnorm</span>(B[<span class="dv">0</span>]<span class="op">-</span>A[<span class="dv">0</span>]<span class="op">,</span> B[<span class="dv">1</span>]<span class="op">-</span>A[<span class="dv">1</span>])<span class="op">;</span> }<span class="op">;</span></span>
<span id="cb3-801"><a href="#cb3-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-802"><a href="#cb3-802" aria-hidden="true" tabindex="-1"></a>  <span class="co">// robust 2D line intersection: P + t*v with Q + s*w</span></span>
<span id="cb3-803"><a href="#cb3-803" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">intersectPoint</span>(P<span class="op">,</span> v<span class="op">,</span> Q<span class="op">,</span> w){</span>
<span id="cb3-804"><a href="#cb3-804" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> det <span class="op">=</span> v[<span class="dv">0</span>]<span class="op">*</span>w[<span class="dv">1</span>] <span class="op">-</span> v[<span class="dv">1</span>]<span class="op">*</span>w[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-805"><a href="#cb3-805" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(det) <span class="op">&lt;</span> <span class="fl">1e-9</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb3-806"><a href="#cb3-806" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dX <span class="op">=</span> Q[<span class="dv">0</span>]<span class="op">-</span>P[<span class="dv">0</span>]<span class="op">,</span> dY <span class="op">=</span> Q[<span class="dv">1</span>]<span class="op">-</span>P[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb3-807"><a href="#cb3-807" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> (dX<span class="op">*</span>w[<span class="dv">1</span>] <span class="op">-</span> dY<span class="op">*</span>w[<span class="dv">0</span>]) <span class="op">/</span> det<span class="op">;</span></span>
<span id="cb3-808"><a href="#cb3-808" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [P[<span class="dv">0</span>] <span class="op">+</span> t<span class="op">*</span>v[<span class="dv">0</span>]<span class="op">,</span> P[<span class="dv">1</span>] <span class="op">+</span> t<span class="op">*</span>v[<span class="dv">1</span>]]<span class="op">;</span></span>
<span id="cb3-809"><a href="#cb3-809" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-810"><a href="#cb3-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-811"><a href="#cb3-811" aria-hidden="true" tabindex="-1"></a>  <span class="co">// roof faces for bbox and drawing</span></span>
<span id="cb3-812"><a href="#cb3-812" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">stripPolyRaw</span>(side<span class="op">,</span> y0<span class="op">,</span> y1){</span>
<span id="cb3-813"><a href="#cb3-813" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(side<span class="op">===</span><span class="st">"left"</span>){</span>
<span id="cb3-814"><a href="#cb3-814" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [ <span class="fu">P0</span>(<span class="dv">0</span><span class="op">,</span>y0<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">P0</span>(half_in<span class="op">,</span>y0<span class="op">,</span>rise_in)<span class="op">,</span> <span class="fu">P0</span>(half_in<span class="op">,</span>y1<span class="op">,</span>rise_in)<span class="op">,</span> <span class="fu">P0</span>(<span class="dv">0</span><span class="op">,</span>y1<span class="op">,</span><span class="dv">0</span>) ]<span class="op">;</span></span>
<span id="cb3-815"><a href="#cb3-815" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-816"><a href="#cb3-816" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [ <span class="fu">P0</span>(half_in<span class="op">,</span>y0<span class="op">,</span>rise_in)<span class="op">,</span> <span class="fu">P0</span>(span_in<span class="op">,</span>y0<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">P0</span>(span_in<span class="op">,</span>y1<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">P0</span>(half_in<span class="op">,</span>y1<span class="op">,</span>rise_in) ]<span class="op">;</span></span>
<span id="cb3-817"><a href="#cb3-817" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-818"><a href="#cb3-818" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-819"><a href="#cb3-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-820"><a href="#cb3-820" aria-hidden="true" tabindex="-1"></a>  <span class="co">// auto-fit translation</span></span>
<span id="cb3-821"><a href="#cb3-821" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> all <span class="op">=</span> [ <span class="op">...</span><span class="fu">stripPolyRaw</span>(<span class="st">"left"</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">*</span>D_units)<span class="op">,</span> <span class="op">...</span><span class="fu">stripPolyRaw</span>(<span class="st">"right"</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">*</span>D_units) ]<span class="op">;</span></span>
<span id="cb3-822"><a href="#cb3-822" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> minX<span class="op">=</span><span class="kw">Infinity</span><span class="op">,</span>maxX<span class="op">=-</span><span class="kw">Infinity</span><span class="op">,</span>minY<span class="op">=</span><span class="kw">Infinity</span><span class="op">,</span>maxY<span class="op">=-</span><span class="kw">Infinity</span><span class="op">;</span></span>
<span id="cb3-823"><a href="#cb3-823" aria-hidden="true" tabindex="-1"></a>  all<span class="op">.</span><span class="fu">forEach</span>(([X<span class="op">,</span>Y])<span class="kw">=&gt;</span>{minX<span class="op">=</span><span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(minX<span class="op">,</span>X)<span class="op">;</span>maxX<span class="op">=</span><span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(maxX<span class="op">,</span>X)<span class="op">;</span>minY<span class="op">=</span><span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(minY<span class="op">,</span>Y)<span class="op">;</span>maxY<span class="op">=</span><span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(maxY<span class="op">,</span>Y)<span class="op">;</span>})<span class="op">;</span></span>
<span id="cb3-824"><a href="#cb3-824" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tx <span class="op">=</span> (innerW <span class="op">-</span> (maxX<span class="op">-</span>minX))<span class="op">/</span><span class="dv">2</span> <span class="op">-</span> minX<span class="op">;</span></span>
<span id="cb3-825"><a href="#cb3-825" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ty <span class="op">=</span> (innerH <span class="op">-</span> (maxY<span class="op">-</span>minY))<span class="op">/</span><span class="dv">2</span> <span class="op">-</span> minY<span class="op">;</span></span>
<span id="cb3-826"><a href="#cb3-826" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sPX <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span> <span class="fu">PX</span>(x<span class="op">,</span>y<span class="op">,</span>z)<span class="op">+</span>tx<span class="op">;</span></span>
<span id="cb3-827"><a href="#cb3-827" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sPY <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span> <span class="fu">PY</span>(x<span class="op">,</span>y<span class="op">,</span>z)<span class="op">+</span>ty<span class="op">;</span></span>
<span id="cb3-828"><a href="#cb3-828" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sPt <span class="op">=</span> (x<span class="op">,</span>y<span class="op">,</span>z)<span class="kw">=&gt;</span> [<span class="fu">sPX</span>(x<span class="op">,</span>y<span class="op">,</span>z)<span class="op">,</span> <span class="fu">sPY</span>(x<span class="op">,</span>y<span class="op">,</span>z)]<span class="op">;</span></span>
<span id="cb3-829"><a href="#cb3-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-830"><a href="#cb3-830" aria-hidden="true" tabindex="-1"></a>  <span class="co">// top chord nodes (double Howe)</span></span>
<span id="cb3-831"><a href="#cb3-831" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> nPanels <span class="op">=</span> <span class="dv">6</span><span class="op">,</span> panel_in <span class="op">=</span> span_in <span class="op">/</span> nPanels<span class="op">;</span></span>
<span id="cb3-832"><a href="#cb3-832" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> topNodes <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(nPanels <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>(i <span class="kw">=&gt;</span> {</span>
<span id="cb3-833"><a href="#cb3-833" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> x <span class="op">=</span> i <span class="op">*</span> panel_in<span class="op">;</span></span>
<span id="cb3-834"><a href="#cb3-834" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> x <span class="op">&lt;=</span> half_in <span class="op">?</span> (x<span class="op">/</span>half_in) <span class="op">:</span> ((span_in<span class="op">-</span>x)<span class="op">/</span>half_in)<span class="op">;</span></span>
<span id="cb3-835"><a href="#cb3-835" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {i<span class="op">,</span> <span class="dt">x_in</span><span class="op">:</span> x<span class="op">,</span> <span class="dt">z_in</span><span class="op">:</span> rise_in <span class="op">*</span> t}<span class="op">;</span></span>
<span id="cb3-836"><a href="#cb3-836" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-837"><a href="#cb3-837" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bottomZ <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-838"><a href="#cb3-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-839"><a href="#cb3-839" aria-hidden="true" tabindex="-1"></a>  <span class="co">// webs + truss</span></span>
<span id="cb3-840"><a href="#cb3-840" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawHoweWebs</span>(gr<span class="op">,</span> y<span class="op">,</span> stroke<span class="op">,</span> sw){</span>
<span id="cb3-841"><a href="#cb3-841" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mid <span class="op">=</span> nPanels<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-842"><a href="#cb3-842" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span>mid<span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span>]<span class="op">.</span><span class="fu">forEach</span>(i<span class="kw">=&gt;</span>{</span>
<span id="cb3-843"><a href="#cb3-843" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> A <span class="op">=</span> topNodes[i]<span class="op">;</span></span>
<span id="cb3-844"><a href="#cb3-844" aria-hidden="true" tabindex="-1"></a>      gr<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-845"><a href="#cb3-845" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span><span class="fu">sPX</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span><span class="fu">sPY</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))</span>
<span id="cb3-846"><a href="#cb3-846" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span><span class="fu">sPX</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span><span class="fu">sPY</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))</span>
<span id="cb3-847"><a href="#cb3-847" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> stroke)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> sw)<span class="op">;</span></span>
<span id="cb3-848"><a href="#cb3-848" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-849"><a href="#cb3-849" aria-hidden="true" tabindex="-1"></a>    [[<span class="dv">1</span><span class="op">,</span><span class="dv">2</span>]<span class="op">,</span>[<span class="dv">2</span><span class="op">,</span>mid]]<span class="op">.</span><span class="fu">forEach</span>(([ia<span class="op">,</span>ib])<span class="kw">=&gt;</span>{</span>
<span id="cb3-850"><a href="#cb3-850" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> A<span class="op">=</span>topNodes[ia]<span class="op">,</span> B<span class="op">=</span>topNodes[ib]<span class="op">;</span></span>
<span id="cb3-851"><a href="#cb3-851" aria-hidden="true" tabindex="-1"></a>      gr<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-852"><a href="#cb3-852" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span><span class="fu">sPX</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span><span class="fu">sPY</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))</span>
<span id="cb3-853"><a href="#cb3-853" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span><span class="fu">sPX</span>(B<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span><span class="fu">sPY</span>(B<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))</span>
<span id="cb3-854"><a href="#cb3-854" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> stroke)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> sw)<span class="op">;</span></span>
<span id="cb3-855"><a href="#cb3-855" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-856"><a href="#cb3-856" aria-hidden="true" tabindex="-1"></a>    [[<span class="dv">5</span><span class="op">,</span><span class="dv">4</span>]<span class="op">,</span>[<span class="dv">4</span><span class="op">,</span>mid]]<span class="op">.</span><span class="fu">forEach</span>(([ia<span class="op">,</span>ib])<span class="kw">=&gt;</span>{</span>
<span id="cb3-857"><a href="#cb3-857" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> A<span class="op">=</span>topNodes[ia]<span class="op">,</span> B<span class="op">=</span>topNodes[ib]<span class="op">;</span></span>
<span id="cb3-858"><a href="#cb3-858" aria-hidden="true" tabindex="-1"></a>      gr<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-859"><a href="#cb3-859" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span><span class="fu">sPX</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span><span class="fu">sPY</span>(A<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>A<span class="op">.</span><span class="at">z_in</span>))</span>
<span id="cb3-860"><a href="#cb3-860" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span><span class="fu">sPX</span>(B<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span><span class="fu">sPY</span>(B<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>bottomZ))</span>
<span id="cb3-861"><a href="#cb3-861" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> stroke)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> sw)<span class="op">;</span></span>
<span id="cb3-862"><a href="#cb3-862" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-863"><a href="#cb3-863" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-864"><a href="#cb3-864" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawHoweTruss</span>(y<span class="op">,</span> <span class="bu">root</span><span class="op">,</span> {stroke<span class="op">=</span><span class="st">"#93c5fd"</span><span class="op">,</span> strokeWidth<span class="op">=</span><span class="fl">2.2</span><span class="op">,</span> className<span class="op">=</span><span class="st">"truss"</span>}<span class="op">=</span>{}){</span>
<span id="cb3-865"><a href="#cb3-865" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> gr <span class="op">=</span> <span class="bu">root</span><span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> className)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb3-866"><a href="#cb3-866" aria-hidden="true" tabindex="-1"></a>    gr<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-867"><a href="#cb3-867" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span><span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span>bottomZ))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span><span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span>bottomZ))</span>
<span id="cb3-868"><a href="#cb3-868" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span><span class="fu">sPX</span>(span_in<span class="op">,</span>y<span class="op">,</span>bottomZ))<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span><span class="fu">sPY</span>(span_in<span class="op">,</span>y<span class="op">,</span>bottomZ))</span>
<span id="cb3-869"><a href="#cb3-869" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> stroke)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> strokeWidth)<span class="op">;</span></span>
<span id="cb3-870"><a href="#cb3-870" aria-hidden="true" tabindex="-1"></a>    gr<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)</span>
<span id="cb3-871"><a href="#cb3-871" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">x</span>(d<span class="kw">=&gt;</span><span class="fu">sPX</span>(d<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>d<span class="op">.</span><span class="at">z_in</span>))<span class="op">.</span><span class="fu">y</span>(d<span class="kw">=&gt;</span><span class="fu">sPY</span>(d<span class="op">.</span><span class="at">x_in</span><span class="op">,</span>y<span class="op">,</span>d<span class="op">.</span><span class="at">z_in</span>))(topNodes))</span>
<span id="cb3-872"><a href="#cb3-872" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> stroke)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> strokeWidth)<span class="op">;</span></span>
<span id="cb3-873"><a href="#cb3-873" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drawHoweWebs</span>(gr<span class="op">,</span> y<span class="op">,</span> stroke<span class="op">,</span> <span class="fl">1.6</span>)<span class="op">;</span></span>
<span id="cb3-874"><a href="#cb3-874" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gr<span class="op">;</span></span>
<span id="cb3-875"><a href="#cb3-875" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-876"><a href="#cb3-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-877"><a href="#cb3-877" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-878"><a href="#cb3-878" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scene</span></span>
<span id="cb3-879"><a href="#cb3-879" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-880"><a href="#cb3-880" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> yTruss <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> D_units<span class="op">,</span> <span class="dv">2</span><span class="op">*</span>D_units]<span class="op">;</span></span>
<span id="cb3-881"><a href="#cb3-881" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> m0 <span class="op">=</span> D_units<span class="op">/</span><span class="dv">2</span><span class="op">,</span> m1 <span class="op">=</span> D_units <span class="op">+</span> D_units<span class="op">/</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb3-882"><a href="#cb3-882" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> yZones <span class="op">=</span> [[<span class="dv">0</span><span class="op">,</span>m0]<span class="op">,</span>[m0<span class="op">,</span>m1]<span class="op">,</span>[m1<span class="op">,</span><span class="dv">2</span><span class="op">*</span>D_units]]<span class="op">;</span></span>
<span id="cb3-883"><a href="#cb3-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-884"><a href="#cb3-884" aria-hidden="true" tabindex="-1"></a>  <span class="co">// roof</span></span>
<span id="cb3-885"><a href="#cb3-885" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> roofG <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb3-886"><a href="#cb3-886" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"left"</span><span class="op">,</span><span class="st">"right"</span>]<span class="op">.</span><span class="fu">forEach</span>(side<span class="kw">=&gt;</span>{</span>
<span id="cb3-887"><a href="#cb3-887" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> poly <span class="op">=</span> (side<span class="op">===</span><span class="st">"left"</span><span class="op">?</span> <span class="fu">stripPolyRaw</span>(<span class="st">"left"</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">*</span>D_units) <span class="op">:</span> <span class="fu">stripPolyRaw</span>(<span class="st">"right"</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">2</span><span class="op">*</span>D_units))</span>
<span id="cb3-888"><a href="#cb3-888" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(([X<span class="op">,</span>Y])<span class="kw">=&gt;</span>[X<span class="op">+</span>tx<span class="op">,</span> Y<span class="op">+</span>ty])<span class="op">;</span></span>
<span id="cb3-889"><a href="#cb3-889" aria-hidden="true" tabindex="-1"></a>    roofG<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)</span>
<span id="cb3-890"><a href="#cb3-890" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">curve</span>(d3<span class="op">.</span><span class="at">curveLinearClosed</span>)(poly))</span>
<span id="cb3-891"><a href="#cb3-891" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"#9ca3af"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span><span class="fl">0.12</span>)</span>
<span id="cb3-892"><a href="#cb3-892" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span><span class="st">"#9ca3af"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span><span class="fl">0.30</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-893"><a href="#cb3-893" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-894"><a href="#cb3-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-895"><a href="#cb3-895" aria-hidden="true" tabindex="-1"></a>  <span class="co">// trusses (middle orangey, back darker green)</span></span>
<span id="cb3-896"><a href="#cb3-896" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> trussG <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb3-897"><a href="#cb3-897" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pastel <span class="op">=</span> [<span class="st">"#93c5fd"</span><span class="op">,</span> <span class="st">"#f59e0b"</span><span class="op">,</span> <span class="st">"#34d399"</span>]<span class="op">;</span> <span class="co">// back darker</span></span>
<span id="cb3-898"><a href="#cb3-898" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vivid  <span class="op">=</span> [<span class="st">"#2563eb"</span><span class="op">,</span> <span class="st">"#d97706"</span><span class="op">,</span> <span class="st">"#059669"</span>]<span class="op">;</span> <span class="co">// hover colors</span></span>
<span id="cb3-899"><a href="#cb3-899" aria-hidden="true" tabindex="-1"></a>  yTruss<span class="op">.</span><span class="fu">forEach</span>((y<span class="op">,</span>i)<span class="kw">=&gt;</span> <span class="fu">drawHoweTruss</span>(y<span class="op">,</span> trussG<span class="op">,</span> { <span class="dt">stroke</span><span class="op">:</span> pastel[i]<span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">2.2</span><span class="op">,</span> <span class="dt">className</span><span class="op">:</span><span class="vs">`truss truss-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span> }))<span class="op">;</span></span>
<span id="cb3-900"><a href="#cb3-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-901"><a href="#cb3-901" aria-hidden="true" tabindex="-1"></a>  <span class="co">// hover scaffolding</span></span>
<span id="cb3-902"><a href="#cb3-902" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hitG <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb3-903"><a href="#cb3-903" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> segHits <span class="op">=</span> hitG<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"all"</span>)<span class="op">;</span></span>
<span id="cb3-904"><a href="#cb3-904" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> HUD <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb3-905"><a href="#cb3-905" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hiAreas <span class="op">=</span> HUD<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb3-906"><a href="#cb3-906" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hiTruss <span class="op">=</span> HUD<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">;</span></span>
<span id="cb3-907"><a href="#cb3-907" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dynDims <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dyn-dims"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb3-908"><a href="#cb3-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-909"><a href="#cb3-909" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">stripPoly</span>(side<span class="op">,</span>y0<span class="op">,</span>y1){ <span class="cf">return</span> <span class="fu">stripPolyRaw</span>(side<span class="op">,</span>y0<span class="op">,</span>y1)<span class="op">.</span><span class="fu">map</span>(([X<span class="op">,</span>Y])<span class="kw">=&gt;</span>[X<span class="op">+</span>tx<span class="op">,</span> Y<span class="op">+</span>ty])<span class="op">;</span> }</span>
<span id="cb3-910"><a href="#cb3-910" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> segments <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb3-911"><a href="#cb3-911" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"left"</span><span class="op">,</span><span class="st">"right"</span>]<span class="op">.</span><span class="fu">forEach</span>(side<span class="kw">=&gt;</span> yZones<span class="op">.</span><span class="fu">forEach</span>((yr<span class="op">,</span>idx)<span class="kw">=&gt;</span>segments<span class="op">.</span><span class="fu">push</span>({side<span class="op">,</span><span class="dt">truss</span><span class="op">:</span>idx<span class="op">,</span><span class="dt">y0</span><span class="op">:</span>yr[<span class="dv">0</span>]<span class="op">,</span><span class="dt">y1</span><span class="op">:</span>yr[<span class="dv">1</span>]})))<span class="op">;</span></span>
<span id="cb3-912"><a href="#cb3-912" aria-hidden="true" tabindex="-1"></a>  segHits<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"path.segHit"</span>)</span>
<span id="cb3-913"><a href="#cb3-913" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(segments)<span class="op">.</span><span class="fu">enter</span>()<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)</span>
<span id="cb3-914"><a href="#cb3-914" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"segHit"</span>)</span>
<span id="cb3-915"><a href="#cb3-915" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d<span class="kw">=&gt;</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">curve</span>(d3<span class="op">.</span><span class="at">curveLinearClosed</span>)(<span class="fu">stripPoly</span>(d<span class="op">.</span><span class="at">side</span><span class="op">,</span>d<span class="op">.</span><span class="at">y0</span><span class="op">,</span>d<span class="op">.</span><span class="at">y1</span>)))</span>
<span id="cb3-916"><a href="#cb3-916" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"#fff"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span><span class="fl">0.001</span>)</span>
<span id="cb3-917"><a href="#cb3-917" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"cursor"</span><span class="op">,</span><span class="st">"pointer"</span>)</span>
<span id="cb3-918"><a href="#cb3-918" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseenter"</span><span class="op">,</span>(_<span class="op">,</span>d)<span class="kw">=&gt;</span><span class="fu">setActive</span>(d<span class="op">.</span><span class="at">truss</span>))</span>
<span id="cb3-919"><a href="#cb3-919" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"mousemove"</span><span class="op">,</span> (_<span class="op">,</span>d)<span class="kw">=&gt;</span><span class="fu">setActive</span>(d<span class="op">.</span><span class="at">truss</span>))</span>
<span id="cb3-920"><a href="#cb3-920" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"mouseleave"</span><span class="op">,</span> clearActive)<span class="op">;</span></span>
<span id="cb3-921"><a href="#cb3-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-922"><a href="#cb3-922" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-923"><a href="#cb3-923" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Math panel (M input + dynamic text)</span></span>
<span id="cb3-924"><a href="#cb3-924" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-925"><a href="#cb3-925" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> T_in <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">hypot</span>(half_in<span class="op">,</span> rise_in)<span class="op">;</span></span>
<span id="cb3-926"><a href="#cb3-926" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> T_ft <span class="op">=</span> T_in <span class="op">/</span> <span class="dv">12</span><span class="op">;</span></span>
<span id="cb3-927"><a href="#cb3-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-928"><a href="#cb3-928" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mathWrap <span class="op">=</span> container<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"math-wrap"</span>)</span>
<span id="cb3-929"><a href="#cb3-929" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"margin"</span><span class="op">,</span><span class="st">"14px 0 0 0"</span>)<span class="op">;</span></span>
<span id="cb3-930"><a href="#cb3-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-931"><a href="#cb3-931" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> gen <span class="op">=</span> mathWrap<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb3-932"><a href="#cb3-932" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"padding"</span><span class="op">,</span><span class="st">"12px 14px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background"</span><span class="op">,</span><span class="st">"#f9fafb"</span>)</span>
<span id="cb3-933"><a href="#cb3-933" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"border"</span><span class="op">,</span><span class="st">"1px solid #e5e7eb"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"border-radius"</span><span class="op">,</span><span class="st">"6px"</span>)</span>
<span id="cb3-934"><a href="#cb3-934" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-family"</span><span class="op">,</span><span class="st">"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"</span>)</span>
<span id="cb3-935"><a href="#cb3-935" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"14px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"line-height"</span><span class="op">,</span><span class="st">"1.5"</span>)<span class="op">;</span></span>
<span id="cb3-936"><a href="#cb3-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-937"><a href="#cb3-937" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#111827"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin-bottom"</span><span class="op">,</span><span class="st">"6px"</span>)</span>
<span id="cb3-938"><a href="#cb3-938" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">"&lt;b&gt;Calculating a trussâ€™s dead load&lt;/b&gt;"</span>)<span class="op">;</span></span>
<span id="cb3-939"><a href="#cb3-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-940"><a href="#cb3-940" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> MVal <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-941"><a href="#cb3-941" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ctrl <span class="op">=</span> gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin"</span><span class="op">,</span><span class="st">"4px 0 10px 0"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#374151"</span>)<span class="op">;</span></span>
<span id="cb3-942"><a href="#cb3-942" aria-hidden="true" tabindex="-1"></a>  ctrl<span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"M (weight per unit area): "</span>)<span class="op">;</span></span>
<span id="cb3-943"><a href="#cb3-943" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mInput <span class="op">=</span> ctrl<span class="op">.</span><span class="fu">append</span>(<span class="st">"input"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"type"</span><span class="op">,</span><span class="st">"number"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"step"</span><span class="op">,</span><span class="st">"0.1"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"value"</span><span class="op">,</span><span class="st">"1.0"</span>)</span>
<span id="cb3-944"><a href="#cb3-944" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span><span class="st">"90px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin-left"</span><span class="op">,</span><span class="st">"6px"</span>)<span class="op">;</span></span>
<span id="cb3-945"><a href="#cb3-945" aria-hidden="true" tabindex="-1"></a>  ctrl<span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin-left"</span><span class="op">,</span><span class="st">"6px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#6b7280"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"(units/area)"</span>)<span class="op">;</span></span>
<span id="cb3-946"><a href="#cb3-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-947"><a href="#cb3-947" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"Let L = ridge length, T = top-chord true length, M = roof weight per unit area."</span>)<span class="op">;</span></span>
<span id="cb3-948"><a href="#cb3-948" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"For a truss with tributary ridge length b:"</span>)<span class="op">;</span></span>
<span id="cb3-949"><a href="#cb3-949" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"  â€¢ Total truss load:   W = (2 Â· T Â· b) Â· M"</span>)<span class="op">;</span></span>
<span id="cb3-950"><a href="#cb3-950" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"  â€¢ Line load on truss: w = W / T = (2 Â· b) Â· M"</span>)<span class="op">;</span></span>
<span id="cb3-951"><a href="#cb3-951" aria-hidden="true" tabindex="-1"></a>  gen<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin-top"</span><span class="op">,</span><span class="st">"6px"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"Here, b = L/4 for an end truss, and b = L/2 for the middle truss."</span>)<span class="op">;</span></span>
<span id="cb3-952"><a href="#cb3-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-953"><a href="#cb3-953" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> spec <span class="op">=</span> mathWrap<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb3-954"><a href="#cb3-954" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"margin"</span><span class="op">,</span><span class="st">"10px 0 0 0"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"padding"</span><span class="op">,</span><span class="st">"12px 14px"</span>)</span>
<span id="cb3-955"><a href="#cb3-955" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"background"</span><span class="op">,</span><span class="st">"#ffffff"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"border"</span><span class="op">,</span><span class="st">"1px solid #e5e7eb"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"border-radius"</span><span class="op">,</span><span class="st">"6px"</span>)</span>
<span id="cb3-956"><a href="#cb3-956" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-family"</span><span class="op">,</span><span class="st">"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"</span>)</span>
<span id="cb3-957"><a href="#cb3-957" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"14px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"line-height"</span><span class="op">,</span><span class="st">"1.5"</span>)<span class="op">;</span></span>
<span id="cb3-958"><a href="#cb3-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-959"><a href="#cb3-959" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> specTitle <span class="op">=</span> spec<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"margin-bottom"</span><span class="op">,</span><span class="st">"6px"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#111827"</span>)</span>
<span id="cb3-960"><a href="#cb3-960" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">"&lt;b&gt;Hover over a roof bay to see specific expressions&lt;/b&gt;"</span>)<span class="op">;</span></span>
<span id="cb3-961"><a href="#cb3-961" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> specLines <span class="op">=</span> spec<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">;</span></span>
<span id="cb3-962"><a href="#cb3-962" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> currentIdx <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb3-963"><a href="#cb3-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-964"><a href="#cb3-964" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">coefStr</span>(val){ <span class="cf">return</span> (<span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(val<span class="op">*</span><span class="dv">100</span>)<span class="op">/</span><span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span> }</span>
<span id="cb3-965"><a href="#cb3-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-966"><a href="#cb3-966" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">updateSpecific</span>(idx){</span>
<span id="cb3-967"><a href="#cb3-967" aria-hidden="true" tabindex="-1"></a>    specLines<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-968"><a href="#cb3-968" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(idx <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span> idx <span class="op">===</span> <span class="kw">undefined</span>){</span>
<span id="cb3-969"><a href="#cb3-969" aria-hidden="true" tabindex="-1"></a>      specTitle<span class="op">.</span><span class="fu">html</span>(<span class="st">"&lt;b&gt;Hover over a roof bay to see specific expressions&lt;/b&gt;"</span>)<span class="op">;</span></span>
<span id="cb3-970"><a href="#cb3-970" aria-hidden="true" tabindex="-1"></a>      specLines<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#6b7280"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"No bay selected."</span>)<span class="op">;</span></span>
<span id="cb3-971"><a href="#cb3-971" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb3-972"><a href="#cb3-972" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-973"><a href="#cb3-973" aria-hidden="true" tabindex="-1"></a>    currentIdx <span class="op">=</span> idx<span class="op">;</span></span>
<span id="cb3-974"><a href="#cb3-974" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> which <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> <span class="st">"Middle truss"</span> <span class="op">:</span> (idx<span class="op">===</span><span class="dv">0</span> <span class="op">?</span> <span class="st">"Right/front end truss"</span> <span class="op">:</span> <span class="st">"Left/back end truss"</span>)<span class="op">;</span></span>
<span id="cb3-975"><a href="#cb3-975" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bSym <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> <span class="st">"L/2"</span> <span class="op">:</span> <span class="st">"L/4"</span><span class="op">;</span></span>
<span id="cb3-976"><a href="#cb3-976" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> vividColor <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> <span class="st">"#d97706"</span> <span class="op">:</span> (idx<span class="op">===</span><span class="dv">0</span> <span class="op">?</span> <span class="st">"#2563eb"</span> <span class="op">:</span> <span class="st">"#059669"</span>)<span class="op">;</span></span>
<span id="cb3-977"><a href="#cb3-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-978"><a href="#cb3-978" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cW <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> (T_ft <span class="op">*</span> MVal) <span class="op">:</span> (T_ft <span class="op">*</span> MVal <span class="op">/</span> <span class="dv">2</span>)<span class="op">;</span> <span class="co">// W = cW * L</span></span>
<span id="cb3-979"><a href="#cb3-979" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cw <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> (<span class="dv">1</span> <span class="op">*</span> MVal)   <span class="op">:</span> (<span class="fl">0.5</span> <span class="op">*</span> MVal)<span class="op">;</span>       <span class="co">// w = cw * L</span></span>
<span id="cb3-980"><a href="#cb3-980" aria-hidden="true" tabindex="-1"></a>    specTitle<span class="op">.</span><span class="fu">html</span>(<span class="vs">`&lt;b&gt;</span><span class="sc">${</span>which<span class="sc">}</span><span class="vs"> (tributary)&lt;/b&gt;`</span>)<span class="op">;</span></span>
<span id="cb3-981"><a href="#cb3-981" aria-hidden="true" tabindex="-1"></a>    specLines<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span><span class="st">"#374151"</span>)</span>
<span id="cb3-982"><a href="#cb3-982" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Given T â‰ˆ </span><span class="sc">${</span>T_ft<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> ft (</span><span class="sc">${</span>T_in<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> in) and M = </span><span class="sc">${</span>MVal<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">:`</span>)<span class="op">;</span></span>
<span id="cb3-983"><a href="#cb3-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-984"><a href="#cb3-984" aria-hidden="true" tabindex="-1"></a>    specLines<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span> vividColor)</span>
<span id="cb3-985"><a href="#cb3-985" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Total load:   W = (2 Â· T Â· </span><span class="sc">${</span>bSym<span class="sc">}</span><span class="vs">) Â· M = (2 Â· </span><span class="sc">${</span>T_ft<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> Â· </span><span class="sc">${</span>bSym<span class="sc">}</span><span class="vs">) Â· </span><span class="sc">${</span>MVal<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> = </span><span class="sc">${</span><span class="fu">coefStr</span>(cW)<span class="sc">}</span><span class="vs">Â·L`</span>)<span class="op">;</span></span>
<span id="cb3-986"><a href="#cb3-986" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> wExpr <span class="op">=</span> (idx<span class="op">===</span><span class="dv">1</span>) <span class="op">?</span> <span class="st">"L Â· M"</span> <span class="op">:</span> <span class="st">"(L/2) Â· M"</span><span class="op">;</span></span>
<span id="cb3-987"><a href="#cb3-987" aria-hidden="true" tabindex="-1"></a>    specLines<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"color"</span><span class="op">,</span> vividColor)</span>
<span id="cb3-988"><a href="#cb3-988" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(<span class="vs">`Line load:    w = 2 Â· </span><span class="sc">${</span>bSym<span class="sc">}</span><span class="vs"> Â· M = </span><span class="sc">${</span>wExpr<span class="sc">}</span><span class="vs"> = </span><span class="sc">${</span><span class="fu">coefStr</span>(cw)<span class="sc">}</span><span class="vs">Â·L`</span>)<span class="op">;</span></span>
<span id="cb3-989"><a href="#cb3-989" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-990"><a href="#cb3-990" aria-hidden="true" tabindex="-1"></a>  mInput<span class="op">.</span><span class="fu">on</span>(<span class="st">"input"</span><span class="op">,</span> <span class="kw">function</span>(){</span>
<span id="cb3-991"><a href="#cb3-991" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> v <span class="op">=</span> <span class="pp">parseFloat</span>(<span class="kw">this</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb3-992"><a href="#cb3-992" aria-hidden="true" tabindex="-1"></a>    MVal <span class="op">=</span> <span class="bu">Number</span><span class="op">.</span><span class="fu">isFinite</span>(v) <span class="op">?</span> v <span class="op">:</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb3-993"><a href="#cb3-993" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSpecific</span>(currentIdx)<span class="op">;</span></span>
<span id="cb3-994"><a href="#cb3-994" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-995"><a href="#cb3-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-996"><a href="#cb3-996" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-997"><a href="#cb3-997" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Static dimension tiers + chord true length</span></span>
<span id="cb3-998"><a href="#cb3-998" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-999"><a href="#cb3-999" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dims <span class="op">=</span> g<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span><span class="st">"dims"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span><span class="st">"none"</span>)<span class="op">;</span></span>
<span id="cb3-1000"><a href="#cb3-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1001"><a href="#cb3-1001" aria-hidden="true" tabindex="-1"></a>  <span class="co">// inner tier: L/2 â€” extension lines are colinear with the bottom chords (unchanged)</span></span>
<span id="cb3-1002"><a href="#cb3-1002" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> extLen <span class="op">=</span> <span class="dv">56</span><span class="op">,</span> tickLen <span class="op">=</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb3-1003"><a href="#cb3-1003" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> exts <span class="op">=</span> yTruss<span class="op">.</span><span class="fu">map</span>(y<span class="kw">=&gt;</span>{</span>
<span id="cb3-1004"><a href="#cb3-1004" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> P <span class="op">=</span> [<span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)]<span class="op">;</span></span>
<span id="cb3-1005"><a href="#cb3-1005" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> v <span class="op">=</span> <span class="fu">bcDirLeft</span>(y)<span class="op">;</span></span>
<span id="cb3-1006"><a href="#cb3-1006" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> <span class="cn">E</span> <span class="op">=</span> [P[<span class="dv">0</span>] <span class="op">+</span> v[<span class="dv">0</span>]<span class="op">*</span>extLen<span class="op">,</span> P[<span class="dv">1</span>] <span class="op">+</span> v[<span class="dv">1</span>]<span class="op">*</span>extLen]<span class="op">;</span></span>
<span id="cb3-1007"><a href="#cb3-1007" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>P[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>P[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span><span class="cn">E</span>[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span><span class="cn">E</span>[<span class="dv">1</span>])</span>
<span id="cb3-1008"><a href="#cb3-1008" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.1</span>)<span class="op">;</span></span>
<span id="cb3-1009"><a href="#cb3-1009" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {y<span class="op">,</span> P<span class="op">,</span> <span class="cn">E</span><span class="op">,</span> v}<span class="op">;</span></span>
<span id="cb3-1010"><a href="#cb3-1010" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-1011"><a href="#cb3-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1012"><a href="#cb3-1012" aria-hidden="true" tabindex="-1"></a>  <span class="co">// connect L/2 spans</span></span>
<span id="cb3-1013"><a href="#cb3-1013" aria-hidden="true" tabindex="-1"></a>  [[<span class="dv">0</span><span class="op">,</span><span class="dv">1</span>]<span class="op">,</span>[<span class="dv">1</span><span class="op">,</span><span class="dv">2</span>]]<span class="op">.</span><span class="fu">forEach</span>(([i<span class="op">,</span>j])<span class="kw">=&gt;</span>{</span>
<span id="cb3-1014"><a href="#cb3-1014" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> A <span class="op">=</span> exts[i]<span class="op">.</span><span class="at">E</span><span class="op">,</span> B <span class="op">=</span> exts[j]<span class="op">.</span><span class="at">E</span><span class="op">;</span></span>
<span id="cb3-1015"><a href="#cb3-1015" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>A[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>A[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span>B[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span>B[<span class="dv">1</span>])</span>
<span id="cb3-1016"><a href="#cb3-1016" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.1</span>)<span class="op">;</span></span>
<span id="cb3-1017"><a href="#cb3-1017" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dims<span class="op">,</span> A[<span class="dv">0</span>]<span class="op">,</span>A[<span class="dv">1</span>]<span class="op">,</span> exts[i]<span class="op">.</span><span class="at">v</span>[<span class="dv">0</span>]<span class="op">,</span> exts[i]<span class="op">.</span><span class="at">v</span>[<span class="dv">1</span>]<span class="op">,</span> tickLen)<span class="op">;</span></span>
<span id="cb3-1018"><a href="#cb3-1018" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dims<span class="op">,</span> B[<span class="dv">0</span>]<span class="op">,</span>B[<span class="dv">1</span>]<span class="op">,</span> exts[j]<span class="op">.</span><span class="at">v</span>[<span class="dv">0</span>]<span class="op">,</span> exts[j]<span class="op">.</span><span class="at">v</span>[<span class="dv">1</span>]<span class="op">,</span> tickLen)<span class="op">;</span></span>
<span id="cb3-1019"><a href="#cb3-1019" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mid<span class="op">=</span>[(A[<span class="dv">0</span>]<span class="op">+</span>B[<span class="dv">0</span>])<span class="op">/</span><span class="dv">2</span><span class="op">,</span>(A[<span class="dv">1</span>]<span class="op">+</span>B[<span class="dv">1</span>])<span class="op">/</span><span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-1020"><a href="#cb3-1020" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> w<span class="op">=</span><span class="fu">vnorm</span>(B[<span class="dv">0</span>]<span class="op">-</span>A[<span class="dv">0</span>]<span class="op">,</span>B[<span class="dv">1</span>]<span class="op">-</span>A[<span class="dv">1</span>])<span class="op">;</span> <span class="kw">let</span> n<span class="op">=</span>[<span class="op">-</span>w[<span class="dv">1</span>]<span class="op">,</span>w[<span class="dv">0</span>]]<span class="op">;</span></span>
<span id="cb3-1021"><a href="#cb3-1021" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bcMid<span class="op">=</span><span class="fu">bcDirLeft</span>(yTruss[<span class="dv">1</span>])<span class="op">;</span> <span class="cf">if</span>(n[<span class="dv">0</span>]<span class="op">*</span>bcMid[<span class="dv">0</span>]<span class="op">+</span>n[<span class="dv">1</span>]<span class="op">*</span>bcMid[<span class="dv">1</span>]<span class="op">&lt;</span><span class="dv">0</span>) n<span class="op">=</span>[<span class="op">-</span>n[<span class="dv">0</span>]<span class="op">,-</span>n[<span class="dv">1</span>]]<span class="op">;</span></span>
<span id="cb3-1022"><a href="#cb3-1022" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> mid[<span class="dv">0</span>]<span class="op">+</span>n[<span class="dv">0</span>]<span class="op">*</span><span class="dv">12</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> mid[<span class="dv">1</span>]<span class="op">+</span>n[<span class="dv">1</span>]<span class="op">*</span><span class="dv">12</span>)</span>
<span id="cb3-1023"><a href="#cb3-1023" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"#4b5563"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"L/2"</span>)<span class="op">;</span></span>
<span id="cb3-1024"><a href="#cb3-1024" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-1025"><a href="#cb3-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1026"><a href="#cb3-1026" aria-hidden="true" tabindex="-1"></a>  <span class="co">// outer tier: L â€” extension lines must be colinear with chords and meet the L line</span></span>
<span id="cb3-1027"><a href="#cb3-1027" aria-hidden="true" tabindex="-1"></a>  <span class="co">// compute ridge direction + outward normal from inner E points</span></span>
<span id="cb3-1028"><a href="#cb3-1028" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> wRidge <span class="op">=</span> <span class="fu">vnorm</span>(exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">0</span>]<span class="op">-</span>exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">0</span>]<span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">1</span>]<span class="op">-</span>exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb3-1029"><a href="#cb3-1029" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> nOut <span class="op">=</span> [<span class="op">-</span>wRidge[<span class="dv">1</span>]<span class="op">,</span> wRidge[<span class="dv">0</span>]]<span class="op">;</span></span>
<span id="cb3-1030"><a href="#cb3-1030" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bcMid <span class="op">=</span> <span class="fu">bcDirLeft</span>(yTruss[<span class="dv">1</span>])<span class="op">;</span> <span class="cf">if</span>(nOut[<span class="dv">0</span>]<span class="op">*</span>bcMid[<span class="dv">0</span>]<span class="op">+</span>nOut[<span class="dv">1</span>]<span class="op">*</span>bcMid[<span class="dv">1</span>]<span class="op">&lt;</span><span class="dv">0</span>) nOut<span class="op">=</span>[<span class="op">-</span>nOut[<span class="dv">0</span>]<span class="op">,-</span>nOut[<span class="dv">1</span>]]<span class="op">;</span></span>
<span id="cb3-1031"><a href="#cb3-1031" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tierOff <span class="op">=</span> <span class="dv">56</span><span class="op">;</span></span>
<span id="cb3-1032"><a href="#cb3-1032" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> baseOut <span class="op">=</span> [exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">0</span>] <span class="op">+</span> nOut[<span class="dv">0</span>]<span class="op">*</span>tierOff<span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">1</span>] <span class="op">+</span> nOut[<span class="dv">1</span>]<span class="op">*</span>tierOff]<span class="op">;</span> <span class="co">// point on the L line</span></span>
<span id="cb3-1033"><a href="#cb3-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1034"><a href="#cb3-1034" aria-hidden="true" tabindex="-1"></a>  <span class="co">// find intersections with the two end extension lines (so extensions are colinear with chords)</span></span>
<span id="cb3-1035"><a href="#cb3-1035" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> I0 <span class="op">=</span> <span class="fu">intersectPoint</span>(exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">P</span><span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">v</span><span class="op">,</span> baseOut<span class="op">,</span> wRidge)<span class="op">;</span></span>
<span id="cb3-1036"><a href="#cb3-1036" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> I2 <span class="op">=</span> <span class="fu">intersectPoint</span>(exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">P</span><span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">v</span><span class="op">,</span> baseOut<span class="op">,</span> wRidge)<span class="op">;</span></span>
<span id="cb3-1037"><a href="#cb3-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1038"><a href="#cb3-1038" aria-hidden="true" tabindex="-1"></a>  <span class="co">// draw outer extension lines along chord directions to the L line</span></span>
<span id="cb3-1039"><a href="#cb3-1039" aria-hidden="true" tabindex="-1"></a>  dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">P</span>[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">P</span>[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> I0[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> I0[<span class="dv">1</span>])</span>
<span id="cb3-1040"><a href="#cb3-1040" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.1</span>)<span class="op">;</span></span>
<span id="cb3-1041"><a href="#cb3-1041" aria-hidden="true" tabindex="-1"></a>  dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">P</span>[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">P</span>[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> I2[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> I2[<span class="dv">1</span>])</span>
<span id="cb3-1042"><a href="#cb3-1042" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.1</span>)<span class="op">;</span></span>
<span id="cb3-1043"><a href="#cb3-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1044"><a href="#cb3-1044" aria-hidden="true" tabindex="-1"></a>  <span class="co">// the L dimension line and ticks at those intersection points</span></span>
<span id="cb3-1045"><a href="#cb3-1045" aria-hidden="true" tabindex="-1"></a>  dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> I0[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> I0[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> I2[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> I2[<span class="dv">1</span>])</span>
<span id="cb3-1046"><a href="#cb3-1046" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">1.2</span>)<span class="op">;</span></span>
<span id="cb3-1047"><a href="#cb3-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTick</span>(dims<span class="op">,</span> I0[<span class="dv">0</span>]<span class="op">,</span>I0[<span class="dv">1</span>]<span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">v</span>[<span class="dv">0</span>]<span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">v</span>[<span class="dv">1</span>]<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb3-1048"><a href="#cb3-1048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTick</span>(dims<span class="op">,</span> I2[<span class="dv">0</span>]<span class="op">,</span>I2[<span class="dv">1</span>]<span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">v</span>[<span class="dv">0</span>]<span class="op">,</span> exts[<span class="dv">2</span>]<span class="op">.</span><span class="at">v</span>[<span class="dv">1</span>]<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb3-1049"><a href="#cb3-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1050"><a href="#cb3-1050" aria-hidden="true" tabindex="-1"></a>  <span class="co">// L label</span></span>
<span id="cb3-1051"><a href="#cb3-1051" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> midL<span class="op">=</span>[(I0[<span class="dv">0</span>]<span class="op">+</span>I2[<span class="dv">0</span>])<span class="op">/</span><span class="dv">2</span><span class="op">,</span>(I0[<span class="dv">1</span>]<span class="op">+</span>I2[<span class="dv">1</span>])<span class="op">/</span><span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-1052"><a href="#cb3-1052" aria-hidden="true" tabindex="-1"></a>  dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb3-1053"><a href="#cb3-1053" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> midL[<span class="dv">0</span>]<span class="op">+</span>nOut[<span class="dv">0</span>]<span class="op">*</span><span class="dv">18</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> midL[<span class="dv">1</span>]<span class="op">+</span>nOut[<span class="dv">1</span>]<span class="op">*</span><span class="dv">18</span>)</span>
<span id="cb3-1054"><a href="#cb3-1054" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"#4b5563"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(<span class="st">"L"</span>)<span class="op">;</span></span>
<span id="cb3-1055"><a href="#cb3-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1056"><a href="#cb3-1056" aria-hidden="true" tabindex="-1"></a>  <span class="co">// top-chord true length (above far truss)</span></span>
<span id="cb3-1057"><a href="#cb3-1057" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">function</span>(){</span>
<span id="cb3-1058"><a href="#cb3-1058" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> y <span class="op">=</span> yTruss[<span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-1059"><a href="#cb3-1059" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> P <span class="op">=</span> [<span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span>y<span class="op">,</span><span class="dv">0</span>)]<span class="op">;</span></span>
<span id="cb3-1060"><a href="#cb3-1060" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Q <span class="op">=</span> [<span class="fu">sPX</span>(half_in<span class="op">,</span>y<span class="op">,</span>rise_in)<span class="op">,</span> <span class="fu">sPY</span>(half_in<span class="op">,</span>y<span class="op">,</span>rise_in)]<span class="op">;</span></span>
<span id="cb3-1061"><a href="#cb3-1061" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> <span class="fu">vnorm</span>(Q[<span class="dv">0</span>]<span class="op">-</span>P[<span class="dv">0</span>]<span class="op">,</span> Q[<span class="dv">1</span>]<span class="op">-</span>P[<span class="dv">1</span>])<span class="op">;</span> <span class="kw">let</span> n<span class="op">=</span>[<span class="op">-</span>t[<span class="dv">1</span>]<span class="op">,</span>t[<span class="dv">0</span>]]<span class="op">;</span> <span class="cf">if</span>(n[<span class="dv">1</span>]<span class="op">&gt;</span><span class="dv">0</span>) n<span class="op">=</span>[<span class="op">-</span>n[<span class="dv">0</span>]<span class="op">,-</span>n[<span class="dv">1</span>]]<span class="op">;</span></span>
<span id="cb3-1062"><a href="#cb3-1062" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> off<span class="op">=</span><span class="dv">80</span><span class="op">,</span> labelOff<span class="op">=</span><span class="dv">16</span><span class="op">,</span> tickLen<span class="op">=</span><span class="dv">8</span><span class="op">;</span></span>
<span id="cb3-1063"><a href="#cb3-1063" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Pn<span class="op">=</span>[P[<span class="dv">0</span>]<span class="op">+</span>n[<span class="dv">0</span>]<span class="op">*</span>off<span class="op">,</span> P[<span class="dv">1</span>]<span class="op">+</span>n[<span class="dv">1</span>]<span class="op">*</span>off]<span class="op">,</span> Qn<span class="op">=</span>[Q[<span class="dv">0</span>]<span class="op">+</span>n[<span class="dv">0</span>]<span class="op">*</span>off<span class="op">,</span> Q[<span class="dv">1</span>]<span class="op">+</span>n[<span class="dv">1</span>]<span class="op">*</span>off]<span class="op">;</span></span>
<span id="cb3-1064"><a href="#cb3-1064" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>Pn[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>Pn[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span>Qn[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span>Qn[<span class="dv">1</span>])</span>
<span id="cb3-1065"><a href="#cb3-1065" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span>DIM)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.2</span>)<span class="op">;</span></span>
<span id="cb3-1066"><a href="#cb3-1066" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dims<span class="op">,</span> Pn[<span class="dv">0</span>]<span class="op">,</span>Pn[<span class="dv">1</span>]<span class="op">,</span> n[<span class="dv">0</span>]<span class="op">,</span>n[<span class="dv">1</span>]<span class="op">,</span> tickLen)<span class="op">;</span></span>
<span id="cb3-1067"><a href="#cb3-1067" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dims<span class="op">,</span> Qn[<span class="dv">0</span>]<span class="op">,</span>Qn[<span class="dv">1</span>]<span class="op">,</span> n[<span class="dv">0</span>]<span class="op">,</span>n[<span class="dv">1</span>]<span class="op">,</span> tickLen)<span class="op">;</span></span>
<span id="cb3-1068"><a href="#cb3-1068" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> label <span class="op">=</span> <span class="vs">`Top-chord true length â‰ˆ </span><span class="sc">${</span> (T_in<span class="op">/</span><span class="dv">12</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="sc">}</span><span class="vs"> ft (</span><span class="sc">${</span> T_in<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="sc">}</span><span class="vs"> in)`</span><span class="op">;</span></span>
<span id="cb3-1069"><a href="#cb3-1069" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ang <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">atan2</span>(Qn[<span class="dv">1</span>]<span class="op">-</span>Pn[<span class="dv">1</span>]<span class="op">,</span> Qn[<span class="dv">0</span>]<span class="op">-</span>Pn[<span class="dv">0</span>])<span class="op">*</span><span class="dv">180</span><span class="op">/</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">;</span></span>
<span id="cb3-1070"><a href="#cb3-1070" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mid<span class="op">=</span>[(Pn[<span class="dv">0</span>]<span class="op">+</span>Qn[<span class="dv">0</span>])<span class="op">/</span><span class="dv">2</span><span class="op">,</span>(Pn[<span class="dv">1</span>]<span class="op">+</span>Qn[<span class="dv">1</span>])<span class="op">/</span><span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-1071"><a href="#cb3-1071" aria-hidden="true" tabindex="-1"></a>    dims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)</span>
<span id="cb3-1072"><a href="#cb3-1072" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span><span class="vs">`translate(</span><span class="sc">${</span>mid[<span class="dv">0</span>]<span class="op">+</span>n[<span class="dv">0</span>]<span class="op">*</span>labelOff<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>mid[<span class="dv">1</span>]<span class="op">+</span>n[<span class="dv">1</span>]<span class="op">*</span>labelOff<span class="sc">}</span><span class="vs">) rotate(</span><span class="sc">${</span>ang<span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb3-1073"><a href="#cb3-1073" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span><span class="st">"#374151"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"12px"</span>)<span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb3-1074"><a href="#cb3-1074" aria-hidden="true" tabindex="-1"></a>  })()<span class="op">;</span></span>
<span id="cb3-1075"><a href="#cb3-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1076"><a href="#cb3-1076" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-1077"><a href="#cb3-1077" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dynamic tributary ridge dimension (colored, coplanar &amp; colinear)</span></span>
<span id="cb3-1078"><a href="#cb3-1078" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-1079"><a href="#cb3-1079" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drawDynamicRidgeDim</span>(idx){</span>
<span id="cb3-1080"><a href="#cb3-1080" aria-hidden="true" tabindex="-1"></a>    dynDims<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-1081"><a href="#cb3-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1082"><a href="#cb3-1082" aria-hidden="true" tabindex="-1"></a>    <span class="co">// choose near/far extension-lines' y-locations</span></span>
<span id="cb3-1083"><a href="#cb3-1083" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> yNear<span class="op">,</span> yFar<span class="op">,</span> label<span class="op">;</span></span>
<span id="cb3-1084"><a href="#cb3-1084" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (idx<span class="op">===</span><span class="dv">1</span>){ yNear <span class="op">=</span> m0<span class="op">;</span> yFar <span class="op">=</span> m1<span class="op">;</span> label <span class="op">=</span> <span class="st">"L/2"</span><span class="op">;</span> }</span>
<span id="cb3-1085"><a href="#cb3-1085" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (idx<span class="op">===</span><span class="dv">0</span>){ yNear <span class="op">=</span> yTruss[<span class="dv">0</span>]<span class="op">;</span> yFar <span class="op">=</span> m0<span class="op">;</span> label <span class="op">=</span> <span class="st">"L/4"</span><span class="op">;</span> }</span>
<span id="cb3-1086"><a href="#cb3-1086" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> { yNear <span class="op">=</span> m1<span class="op">;</span> yFar <span class="op">=</span> yTruss[<span class="dv">2</span>]<span class="op">;</span> label <span class="op">=</span> <span class="st">"L/4"</span><span class="op">;</span> }</span>
<span id="cb3-1087"><a href="#cb3-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1088"><a href="#cb3-1088" aria-hidden="true" tabindex="-1"></a>    <span class="co">// extension-line bases (through heel at x=0 on those y's), directions along bottom chord</span></span>
<span id="cb3-1089"><a href="#cb3-1089" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Pn <span class="op">=</span> [<span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span>yNear<span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span>yNear<span class="op">,</span><span class="dv">0</span>)]<span class="op">,</span> vn <span class="op">=</span> <span class="fu">bcDirLeft</span>(yNear)<span class="op">;</span></span>
<span id="cb3-1090"><a href="#cb3-1090" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Pf <span class="op">=</span> [<span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span>yFar<span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span>yFar<span class="op">,</span> <span class="dv">0</span>)]<span class="op">,</span> vf <span class="op">=</span> <span class="fu">bcDirLeft</span>(yFar)<span class="op">;</span></span>
<span id="cb3-1091"><a href="#cb3-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1092"><a href="#cb3-1092" aria-hidden="true" tabindex="-1"></a>    <span class="co">// dynamic dimension line: parallel to outer L line, farther out by (tierOff + delta),</span></span>
<span id="cb3-1093"><a href="#cb3-1093" aria-hidden="true" tabindex="-1"></a>    <span class="co">// using a point offset from the inner base at exts[0].E</span></span>
<span id="cb3-1094"><a href="#cb3-1094" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dynamicOff <span class="op">=</span> tierOff <span class="op">+</span> <span class="dv">36</span><span class="op">;</span></span>
<span id="cb3-1095"><a href="#cb3-1095" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> baseDyn <span class="op">=</span> [exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">0</span>] <span class="op">+</span> nOut[<span class="dv">0</span>]<span class="op">*</span>dynamicOff<span class="op">,</span> exts[<span class="dv">0</span>]<span class="op">.</span><span class="at">E</span>[<span class="dv">1</span>] <span class="op">+</span> nOut[<span class="dv">1</span>]<span class="op">*</span>dynamicOff]<span class="op">;</span></span>
<span id="cb3-1096"><a href="#cb3-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1097"><a href="#cb3-1097" aria-hidden="true" tabindex="-1"></a>    <span class="co">// intersections with the two extension lines =&gt; endpoints that guarantee colinearity with chords</span></span>
<span id="cb3-1098"><a href="#cb3-1098" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Inear <span class="op">=</span> <span class="fu">intersectPoint</span>(Pn<span class="op">,</span> vn<span class="op">,</span> baseDyn<span class="op">,</span> wRidge)<span class="op">;</span></span>
<span id="cb3-1099"><a href="#cb3-1099" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Ifar  <span class="op">=</span> <span class="fu">intersectPoint</span>(Pf<span class="op">,</span> vf<span class="op">,</span> baseDyn<span class="op">,</span> wRidge)<span class="op">;</span></span>
<span id="cb3-1100"><a href="#cb3-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1101"><a href="#cb3-1101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> col <span class="op">=</span> vivid[idx]<span class="op">;</span></span>
<span id="cb3-1102"><a href="#cb3-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1103"><a href="#cb3-1103" aria-hidden="true" tabindex="-1"></a>    <span class="co">// draw dynamic extension lines (along chord directions)</span></span>
<span id="cb3-1104"><a href="#cb3-1104" aria-hidden="true" tabindex="-1"></a>    dynDims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>Pn[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>Pn[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span>Inear[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span>Inear[<span class="dv">1</span>])</span>
<span id="cb3-1105"><a href="#cb3-1105" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> col)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">1.6</span>)<span class="op">;</span></span>
<span id="cb3-1106"><a href="#cb3-1106" aria-hidden="true" tabindex="-1"></a>    dynDims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>Pf[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>Pf[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span>Ifar[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span>Ifar[<span class="dv">1</span>])</span>
<span id="cb3-1107"><a href="#cb3-1107" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> col)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">1.6</span>)<span class="op">;</span></span>
<span id="cb3-1108"><a href="#cb3-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1109"><a href="#cb3-1109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// dynamic dimension line + ticks</span></span>
<span id="cb3-1110"><a href="#cb3-1110" aria-hidden="true" tabindex="-1"></a>    dynDims<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span>Inear[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span>Inear[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span>Ifar[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span>Ifar[<span class="dv">1</span>])</span>
<span id="cb3-1111"><a href="#cb3-1111" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> col)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">2.2</span>)<span class="op">;</span></span>
<span id="cb3-1112"><a href="#cb3-1112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dynDims<span class="op">,</span> Inear[<span class="dv">0</span>]<span class="op">,</span>Inear[<span class="dv">1</span>]<span class="op">,</span> vn[<span class="dv">0</span>]<span class="op">,</span> vn[<span class="dv">1</span>]<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb3-1113"><a href="#cb3-1113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addTick</span>(dynDims<span class="op">,</span> Ifar[<span class="dv">0</span>]<span class="op">,</span> Ifar[<span class="dv">1</span>]<span class="op">,</span> vf[<span class="dv">0</span>]<span class="op">,</span> vf[<span class="dv">1</span>]<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb3-1114"><a href="#cb3-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1115"><a href="#cb3-1115" aria-hidden="true" tabindex="-1"></a>    <span class="co">// label (pulled farther from the line)</span></span>
<span id="cb3-1116"><a href="#cb3-1116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mid<span class="op">=</span>[(Inear[<span class="dv">0</span>]<span class="op">+</span>Ifar[<span class="dv">0</span>])<span class="op">/</span><span class="dv">2</span><span class="op">,</span>(Inear[<span class="dv">1</span>]<span class="op">+</span>Ifar[<span class="dv">1</span>])<span class="op">/</span><span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-1117"><a href="#cb3-1117" aria-hidden="true" tabindex="-1"></a>    dynDims<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb3-1118"><a href="#cb3-1118" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> mid[<span class="dv">0</span>] <span class="op">+</span> nOut[<span class="dv">0</span>]<span class="op">*</span><span class="dv">26</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> mid[<span class="dv">1</span>] <span class="op">+</span> nOut[<span class="dv">1</span>]<span class="op">*</span><span class="dv">26</span>) <span class="co">// extra clearance</span></span>
<span id="cb3-1119"><a href="#cb3-1119" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span><span class="st">"middle"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span><span class="st">"12px"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> col)</span>
<span id="cb3-1120"><a href="#cb3-1120" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>(label)<span class="op">;</span></span>
<span id="cb3-1121"><a href="#cb3-1121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1122"><a href="#cb3-1122" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">clearDynamicRidgeDim</span>(){ dynDims<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span> }</span>
<span id="cb3-1123"><a href="#cb3-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1124"><a href="#cb3-1124" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-1125"><a href="#cb3-1125" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Hover handlers</span></span>
<span id="cb3-1126"><a href="#cb3-1126" aria-hidden="true" tabindex="-1"></a>  <span class="co">// -----------------------------</span></span>
<span id="cb3-1127"><a href="#cb3-1127" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">setActive</span>(idx){</span>
<span id="cb3-1128"><a href="#cb3-1128" aria-hidden="true" tabindex="-1"></a>    hiAreas<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span> hiTruss<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-1129"><a href="#cb3-1129" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"left"</span><span class="op">,</span><span class="st">"right"</span>]<span class="op">.</span><span class="fu">forEach</span>(side<span class="kw">=&gt;</span>{</span>
<span id="cb3-1130"><a href="#cb3-1130" aria-hidden="true" tabindex="-1"></a>      hiAreas<span class="op">.</span><span class="fu">append</span>(<span class="st">"path"</span>)</span>
<span id="cb3-1131"><a href="#cb3-1131" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"d"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">line</span>()<span class="op">.</span><span class="fu">curve</span>(d3<span class="op">.</span><span class="at">curveLinearClosed</span>)(<span class="fu">stripPoly</span>(side<span class="op">,</span> yZones[idx][<span class="dv">0</span>]<span class="op">,</span> yZones[idx][<span class="dv">1</span>])))</span>
<span id="cb3-1132"><a href="#cb3-1132" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> pastel[idx])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill-opacity"</span><span class="op">,</span> <span class="fl">0.32</span>)</span>
<span id="cb3-1133"><a href="#cb3-1133" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> pastel[idx])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> <span class="fl">0.85</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="fl">1.2</span>)<span class="op">;</span></span>
<span id="cb3-1134"><a href="#cb3-1134" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb3-1135"><a href="#cb3-1135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drawHoweTruss</span>(yTruss[idx]<span class="op">,</span> hiTruss<span class="op">,</span> { <span class="dt">stroke</span><span class="op">:</span> vivid[idx]<span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="fl">3.2</span><span class="op">,</span> <span class="dt">className</span><span class="op">:</span> <span class="st">"truss-overlay"</span> })<span class="op">;</span></span>
<span id="cb3-1136"><a href="#cb3-1136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drawDynamicRidgeDim</span>(idx)<span class="op">;</span></span>
<span id="cb3-1137"><a href="#cb3-1137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSpecific</span>(idx)<span class="op">;</span></span>
<span id="cb3-1138"><a href="#cb3-1138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1139"><a href="#cb3-1139" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">clearActive</span>(){</span>
<span id="cb3-1140"><a href="#cb3-1140" aria-hidden="true" tabindex="-1"></a>    hiAreas<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span> hiTruss<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb3-1141"><a href="#cb3-1141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clearDynamicRidgeDim</span>()<span class="op">;</span></span>
<span id="cb3-1142"><a href="#cb3-1142" aria-hidden="true" tabindex="-1"></a>    currentIdx <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb3-1143"><a href="#cb3-1143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateSpecific</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb3-1144"><a href="#cb3-1144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1145"><a href="#cb3-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1146"><a href="#cb3-1146" aria-hidden="true" tabindex="-1"></a>  <span class="co">// front eave guide</span></span>
<span id="cb3-1147"><a href="#cb3-1147" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> e0 <span class="op">=</span> [<span class="fu">sPX</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>)]<span class="op">,</span> e1 <span class="op">=</span> [<span class="fu">sPX</span>(span_in<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">sPY</span>(span_in<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>)]<span class="op">;</span></span>
<span id="cb3-1148"><a href="#cb3-1148" aria-hidden="true" tabindex="-1"></a>  g<span class="op">.</span><span class="fu">append</span>(<span class="st">"line"</span>)</span>
<span id="cb3-1149"><a href="#cb3-1149" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> e0[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> e0[<span class="dv">1</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> e1[<span class="dv">0</span>])<span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> e1[<span class="dv">1</span>])</span>
<span id="cb3-1150"><a href="#cb3-1150" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span><span class="st">"#e5e7eb"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span><span class="fl">1.2</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-dasharray"</span><span class="op">,</span><span class="st">"3 3"</span>)<span class="op">;</span></span>
<span id="cb3-1151"><a href="#cb3-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1152"><a href="#cb3-1152" aria-hidden="true" tabindex="-1"></a>  <span class="co">// init</span></span>
<span id="cb3-1153"><a href="#cb3-1153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateSpecific</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb3-1154"><a href="#cb3-1154" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> container<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb3-1155"><a href="#cb3-1155" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6ImQzID0gcmVxdWlyZShcImQzQDdcIilcbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMiIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IntcbiAgLy8gPT09PT0gVW5pdHMgJiBoZWxwZXJzIChzaGFyZWQpID09PT09XG4gIGNvbnN0IElOID0gMC4wMjU0LCBGVCA9IDEyICogSU47ICAgLy8gbWV0ZXJzIHBlciBpbmNoLCBtZXRlcnMgcGVyIGZvb3RcblxuICAvLyBGb3JtYXR0ZXJzXG4gIGZ1bmN0aW9uIGZtdFNwYW4obSwgdW5pdHNNb2RlKSB7XG4gICAgaWYgKHVuaXRzTW9kZSA9PT0gXCJ1c2NzXCIpIHJldHVybiBgJHsobS9GVCkudG9GaXhlZCgyKX0gZnRgO1xuICAgIHJldHVybiBgJHttLnRvRml4ZWQoMyl9IG1gO1xuICB9XG4gIGZ1bmN0aW9uIGZtdFN1YihtLCB1bml0c01vZGUpIHtcbiAgICBpZiAodW5pdHNNb2RlID09PSBcInVzY3NcIikgcmV0dXJuIGAkeyhtL0lOKS50b0ZpeGVkKDIpfSBpbmA7XG4gICAgcmV0dXJuIGAke20udG9GaXhlZCgzKX0gbWA7XG4gIH1cbiAgZnVuY3Rpb24gZm10SGVpZ2h0KG0sIHVuaXRzTW9kZSkge1xuICAgIGlmICh1bml0c01vZGUgPT09IFwidXNjc1wiKSByZXR1cm4gYCR7KG0vSU4pLnRvRml4ZWQoMil9IGluYDtcbiAgICByZXR1cm4gYCR7bS50b0ZpeGVkKDMpfSBtYDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFjY3VtdWxhdGVBcmMobm9kZXMpIHtcbiAgICBsZXQgcyA9IDA7XG4gICAgY29uc3Qgb3V0ID0gW3suLi5ub2Rlc1swXSwgc31dO1xuICAgIGZvciAobGV0IGsgPSAxOyBrIDwgbm9kZXMubGVuZ3RoOyBrKyspIHtcbiAgICAgIGNvbnN0IGR4ID0gbm9kZXNba10ueGggLSBub2Rlc1trLTFdLnhoO1xuICAgICAgY29uc3QgZHkgPSBub2Rlc1trXS55aCAtIG5vZGVzW2stMV0ueWg7XG4gICAgICBjb25zdCBkcyA9IE1hdGguaHlwb3QoZHgsIGR5KTtcbiAgICAgIHMgKz0gZHM7XG4gICAgICBvdXQucHVzaCh7Li4ubm9kZXNba10sIHN9KTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNsaWNlUG9seWxpbmVCeVMobm9kZXNTLCBzMCwgczEpIHtcbiAgICBjb25zdCBzZWdzID0gW107XG4gICAgZm9yIChsZXQgayA9IDE7IGsgPCBub2Rlc1MubGVuZ3RoOyBrKyspIHtcbiAgICAgIGNvbnN0IEEgPSBub2Rlc1Nbay0xXSwgQiA9IG5vZGVzU1trXTtcbiAgICAgIGNvbnN0IHNBID0gQS5zLCBzQiA9IEIucztcbiAgICAgIGNvbnN0IG92ZXJsYXAwID0gTWF0aC5tYXgoczAsIHNBKTtcbiAgICAgIGNvbnN0IG92ZXJsYXAxID0gTWF0aC5taW4oczEsIHNCKTtcbiAgICAgIGlmIChvdmVybGFwMSA8PSBvdmVybGFwMCkgY29udGludWU7XG4gICAgICBjb25zdCB0MCA9IChvdmVybGFwMCAtIHNBKSAvIChzQiAtIHNBKTtcbiAgICAgIGNvbnN0IHQxID0gKG92ZXJsYXAxIC0gc0EpIC8gKHNCIC0gc0EpO1xuICAgICAgY29uc3QgUDAgPSB7IHhoOiBBLnhoICsgKEIueGggLSBBLnhoKSAqIHQwLCB5aDogQS55aCArIChCLnloIC0gQS55aCkgKiB0MCB9O1xuICAgICAgY29uc3QgUDEgPSB7IHhoOiBBLnhoICsgKEIueGggLSBBLnhoKSAqIHQxLCB5aDogQS55aCArIChCLnloIC0gQS55aCkgKiB0MSB9O1xuICAgICAgc2Vncy5wdXNoKFtQMCwgUDFdKTtcbiAgICB9XG4gICAgcmV0dXJuIHNlZ3M7XG4gIH1cblxuICBmdW5jdGlvbiBzQXRYKHRvcFMsIHhUYXJnZXRfbSkge1xuICAgIGlmICh4VGFyZ2V0X20gPD0gdG9wU1swXS54aCkgcmV0dXJuIDA7XG4gICAgY29uc3QgbGFzdCA9IHRvcFNbdG9wUy5sZW5ndGgtMV07XG4gICAgaWYgKHhUYXJnZXRfbSA+PSBsYXN0LnhoKSByZXR1cm4gbGFzdC5zO1xuICAgIGZvciAobGV0IGsgPSAxOyBrIDwgdG9wUy5sZW5ndGg7IGsrKykge1xuICAgICAgY29uc3QgQSA9IHRvcFNbay0xXSwgQiA9IHRvcFNba107XG4gICAgICBpZiAoeFRhcmdldF9tIDw9IEIueGgpIHtcbiAgICAgICAgY29uc3QgdCA9ICh4VGFyZ2V0X20gLSBBLnhoKSAvIChCLnhoIC0gQS54aCk7XG4gICAgICAgIHJldHVybiBBLnMgKyB0ICogKEIucyAtIEEucyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsYXN0LnM7XG4gIH1cblxuICBmdW5jdGlvbiBhcnJvd1RpY2tzKHAsIHEsIG9mZlZlYywgdGlja0xlbiA9IDUpIHtcbiAgICBjb25zdCB1eCA9IHEueCAtIHAueCwgdXkgPSBxLnkgLSBwLnk7XG4gICAgY29uc3QgTCA9IE1hdGguaHlwb3QodXgsIHV5KSB8fCAxO1xuICAgIGNvbnN0IHZ4ID0gLXV5IC8gTCwgdnkgPSB1eCAvIEw7XG4gICAgcmV0dXJuIFtcbiAgICAgIFtwLnggKyBvZmZWZWMueCArIHZ4ICogdGlja0xlbiwgcC55ICsgb2ZmVmVjLnkgKyB2eSAqIHRpY2tMZW4sIHAueCArIG9mZlZlYy54IC0gdnggKiB0aWNrTGVuLCBwLnkgKyBvZmZWZWMueSAtIHZ5ICogdGlja0xlbl0sXG4gICAgICBbcS54ICsgb2ZmVmVjLnggKyB2eCAqIHRpY2tMZW4sIHEueSArIG9mZlZlYy55ICsgdnkgKiB0aWNrTGVuLCBxLnggKyBvZmZWZWMueCAtIHZ4ICogdGlja0xlbiwgcS55ICsgb2ZmVmVjLnkgLSB2eSAqIHRpY2tMZW5dLFxuICAgIF07XG4gIH1cblxuICAvLyA9PT0gTGFiZWw6IHNsYW50ZWQgdG9wLWNob3JkIHRydWUgbGVuZ3RoIChsZWZ0IGhhbGYpLCB+ODUgcHggbm9ybWFsID09PVxuICBmdW5jdGlvbiBwbGFjZVRvcENob3JkTGVuZ3RoTGFiZWwodG9wTm9kZXMsIHRvcFMsIGdyb3VwLCB1bml0c01vZGUsIHgsIHlTY2FsZSkge1xuICAgIGNvbnN0IGsgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih0b3BOb2Rlcy5sZW5ndGggLSAyLCBNYXRoLmZsb29yKHRvcE5vZGVzLmxlbmd0aCAvIDQpKSk7IC8vIH5sZWZ0IHF1YXJ0ZXJcbiAgICBjb25zdCBBID0gdG9wTm9kZXNba10sIEIgPSB0b3BOb2Rlc1trKzFdO1xuICAgIGNvbnN0IHB4ID0geChBLnhoKSwgcHkgPSB5U2NhbGUoQS55aCk7XG4gICAgY29uc3QgcXggPSB4KEIueGgpLCBxeSA9IHlTY2FsZShCLnloKTtcbiAgICBjb25zdCBkeCA9IHF4IC0gcHgsIGR5ID0gcXkgLSBweTtcbiAgICBjb25zdCBMcCA9IE1hdGguaHlwb3QoZHgsIGR5KSB8fCAxO1xuICAgIGxldCBueCA9IC1keSAvIExwLCBueSA9IGR4IC8gTHA7ICAgICAgICAgLy8gc2NyZWVuLXNwYWNlIG5vcm1hbFxuICAgIGNvbnN0IHNpZ24gPSAobnkgPiAwKSA/IC0xIDogMTsgICAgICAgICAgLy8gcHVzaCB1cHdhcmQgaW4gc2NyZWVuIGNvb3Jkc1xuICAgIGNvbnN0IG9mZiA9IDg1OyAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDw8IHVwZGF0ZWQgZnJvbSAxNTAgdG8gfjg1XG4gICAgY29uc3QgdHggPSAocHggKyBxeCkgLyAyICsgbnggKiBvZmYgKiBzaWduO1xuICAgIGNvbnN0IHR5ID0gKHB5ICsgcXkpIC8gMiArIG55ICogb2ZmICogc2lnbjtcbiAgICBjb25zdCBhbmdsZURlZyA9IE1hdGguYXRhbjIoZHksIGR4KSAqIDE4MC9NYXRoLlBJO1xuXG4gICAgZ3JvdXAuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImxhYmVsLWRpbVwiKVxuICAgICAgLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLCBcIm1pZGRsZVwiKVxuICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgYHRyYW5zbGF0ZSgke3R4fSwke3R5fSkgcm90YXRlKCR7YW5nbGVEZWd9KWApXG4gICAgICAudGV4dChgVG9wLWNob3JkIHRydWUgbGVuZ3RoIOKJiCAke2ZtdFNwYW4odG9wU1t0b3BTLmxlbmd0aCAtIDFdLnMsIHVuaXRzTW9kZSl9YCk7XG4gIH1cblxuICAvLyA9PT0gTmV3OiBkaWFnb25hbC1jaG9yZCBkaW1lbnNpb24gbGluZXMgZm9yIExFRlQgdG9wIGNob3JkICh2ZXJ5IGxpZ2h0IGdyYXkpID09PVxuICBmdW5jdGlvbiBkcmF3TGVmdFRvcENob3JkRGlhZ0RpbSh0b3BOb2RlcywgZ3JvdXAsIHgsIHlTY2FsZSkge1xuICAgIGNvbnN0IG1pZElkeCA9IE1hdGguZmxvb3IoKHRvcE5vZGVzLmxlbmd0aCAtIDEpIC8gMik7IC8vIGFwZXggaW5kZXhcbiAgICBjb25zdCBBID0gdG9wTm9kZXNbMF0sIEIgPSB0b3BOb2Rlc1ttaWRJZHhdOyAgICAgICAgICAvLyBsZWZ0IGhlZWwgdG8gYXBleCAobGVmdCB0b3AgY2hvcmQpXG4gICAgY29uc3QgUCA9IHsgeDogeChBLnhoKSwgeTogeVNjYWxlKEEueWgpIH07XG4gICAgY29uc3QgUSA9IHsgeDogeChCLnhoKSwgeTogeVNjYWxlKEIueWgpIH07XG5cbiAgICBjb25zdCBkeCA9IFEueCAtIFAueCwgZHkgPSBRLnkgLSBQLnk7XG4gICAgY29uc3QgTHAgPSBNYXRoLmh5cG90KGR4LCBkeSkgfHwgMTtcbiAgICBjb25zdCB1eCA9IGR4IC8gTHAsIHV5ID0gZHkgLyBMcDtcbiAgICBsZXQgbnggPSAtdXksIG55ID0gdXg7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxcbiAgICBjb25zdCBzaWduID0gKG55ID4gMCkgPyAtMSA6IDE7ICAgICAgICAgICAgICAgICAgICAgICAvLyBzYW1lIHNpZGUgYXMgbWFpbiBsYWJlbFxuICAgIGNvbnN0IG9mZiA9IDgwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNsaWdodGx5IGJlbG93IHRoZSB0cnVlLWxlbmd0aCBsYWJlbCAoODUpXG4gICAgY29uc3QgdGljayA9IDEwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5kIHRpY2sgaGFsZi1sZW5ndGhcblxuICAgIC8vIFNoaWZ0ZWQgZW5kIHBvaW50cyBmb3IgdGhlIHBhcmFsbGVsIGRpbSBsaW5lXG4gICAgY29uc3QgUG4gPSB7IHg6IFAueCArIG54ICogb2ZmICogc2lnbiwgeTogUC55ICsgbnkgKiBvZmYgKiBzaWduIH07XG4gICAgY29uc3QgUW4gPSB7IHg6IFEueCArIG54ICogb2ZmICogc2lnbiwgeTogUS55ICsgbnkgKiBvZmYgKiBzaWduIH07XG5cbiAgICAvLyBQYXJhbGxlbCBsaW5lICh2ZXJ5IGxpZ2h0IGdyYXkpXG4gICAgZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImRpbS1naG9zdFwiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCBQbi54KS5hdHRyKFwieTFcIiwgUG4ueSlcbiAgICAgIC5hdHRyKFwieDJcIiwgUW4ueCkuYXR0cihcInkyXCIsIFFuLnkpO1xuXG4gICAgLy8gRW5kIHRpY2tzIChub3JtYWwgdG8gdGhlIGNob3JkLCBjZW50ZXJlZCBvbiBQbiBhbmQgUW4pXG4gICAgZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcInRpY2stZ2hvc3RcIilcbiAgICAgIC5hdHRyKFwieDFcIiwgUG4ueCAtIG54ICogdGljaykuYXR0cihcInkxXCIsIFBuLnkgLSBueSAqIHRpY2spXG4gICAgICAuYXR0cihcIngyXCIsIFBuLnggKyBueCAqIHRpY2spLmF0dHIoXCJ5MlwiLCBQbi55ICsgbnkgKiB0aWNrKTtcbiAgICBncm91cC5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidGljay1naG9zdFwiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCBRbi54IC0gbnggKiB0aWNrKS5hdHRyKFwieTFcIiwgUW4ueSAtIG55ICogdGljaylcbiAgICAgIC5hdHRyKFwieDJcIiwgUW4ueCArIG54ICogdGljaykuYXR0cihcInkyXCIsIFFuLnkgKyBueSAqIHRpY2spO1xuICB9XG5cbiAgLy8gPT09IFZlcnRpY2FsIGhlaWdodCBkaW1lbnNpb24gKHNob3J0IGVxdWFsIHN0dWJzIGF0IGRpbSBsaW5lOyB2ZXJ0aWNhbCBsYWJlbCkgPT09XG4gIGZ1bmN0aW9uIGRyYXdBcGV4SGVpZ2h0RGltKGdyb3VwLCB4LCB5U2NhbGUsIHNwYW5fbSwgcmlzZV9tLCB1bml0c01vZGUpIHtcbiAgICBjb25zdCBiYXNlWSA9IHlTY2FsZSgwKTtcbiAgICBjb25zdCB4RGltICA9IHgoMCkgLSAyNjsgIC8vIHRvIHRoZSBsZWZ0IG9mIHRoZSBoZWVsIChkaW1lbnNpb24gbGluZSBwb3NpdGlvbilcbiAgICBjb25zdCBzdHViID0gMjQ7ICAgICAgICAgIC8vIHNob3J0LCBlcXVhbC1sZW5ndGggaG9yaXpvbnRhbCBzdHVic1xuXG4gICAgLy8gU2hvcnQgaG9yaXpvbnRhbCBzdHVicyBhdCB0b3AgKGFwZXggeSkgYW5kIGJvdHRvbSAoaGVlbCB5KVxuICAgIGdyb3VwLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJleHRcIilcbiAgICAgIC5hdHRyKFwieDFcIiwgeERpbSkuYXR0cihcInkxXCIsIHlTY2FsZShyaXNlX20pKS5hdHRyKFwieDJcIiwgeERpbSArIHN0dWIpLmF0dHIoXCJ5MlwiLCB5U2NhbGUocmlzZV9tKSk7XG4gICAgZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImV4dFwiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCB4RGltKS5hdHRyKFwieTFcIiwgYmFzZVkpLmF0dHIoXCJ4MlwiLCB4RGltICsgc3R1YikuYXR0cihcInkyXCIsIGJhc2VZKTtcblxuICAgIC8vIFZlcnRpY2FsIGRpbWVuc2lvbiBsaW5lXG4gICAgZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImRpbVwiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCB4RGltKS5hdHRyKFwieTFcIiwgeVNjYWxlKHJpc2VfbSkpLmF0dHIoXCJ4MlwiLCB4RGltKS5hdHRyKFwieTJcIiwgYmFzZVkpO1xuXG4gICAgLy8gRW5kIHRpY2tzIG9uIHRoZSB2ZXJ0aWNhbCBkaW0gbGluZVxuICAgIGNvbnN0IHRpY2tzID0gW1xuICAgICAgW3hEaW0gLSA2LCB5U2NhbGUocmlzZV9tKSwgeERpbSArIDYsIHlTY2FsZShyaXNlX20pXSxcbiAgICAgIFt4RGltIC0gNiwgYmFzZVksICAgICAgICAgIHhEaW0gKyA2LCBiYXNlWV1cbiAgICBdO1xuICAgIHRpY2tzLmZvckVhY2godCA9PiBncm91cC5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidGlja1wiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCB0WzBdKS5hdHRyKFwieTFcIiwgdFsxXSkuYXR0cihcIngyXCIsIHRbMl0pLmF0dHIoXCJ5MlwiLCB0WzNdKSk7XG5cbiAgICAvLyBWZXJ0aWNhbCBsYWJlbCAocm90YXRlZCksIG9mZnNldCBzbGlnaHRseSBsZWZ0IG9mIHRoZSBkaW0gbGluZVxuICAgIGNvbnN0IHlNaWQgPSAoeVNjYWxlKHJpc2VfbSkgKyBiYXNlWSkgLyAyO1xuICAgIGdyb3VwLmFwcGVuZChcInRleHRcIilcbiAgICAgIC5hdHRyKFwiY2xhc3NcIixcImxhYmVsXCIpXG4gICAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoJHt4RGltIC0gMTh9LCR7eU1pZH0pIHJvdGF0ZSgtOTApYClcbiAgICAgIC50ZXh0KGBIZWlnaHQ6ICR7Zm10SGVpZ2h0KHJpc2VfbSwgdW5pdHNNb2RlKX1gKTtcbiAgfVxuXG4gIC8vID09PT09IENvbnRhaW5lciwgY29udHJvbHMsIGFuZCBTVkcgc2hlbGwgPT09PT1cbiAgY29uc3QgY29udGFpbmVyID0gZDMuY3JlYXRlKFwiZGl2XCIpLmF0dHIoXCJjbGFzc1wiLCBcInZpei13cmFwXCIpO1xuICBjb25zdCBjb250cm9scyA9IGNvbnRhaW5lci5hcHBlbmQoXCJkaXZcIikuYXR0cihcImNsYXNzXCIsXCJjb250cm9sc1wiKTtcblxuICAvLyBUcnVzcyBzZWxlY3RvclxuICBjb250cm9scy5hcHBlbmQoXCJsYWJlbFwiKS5hdHRyKFwiZm9yXCIsXCJ0cnVzc1R5cGVcIikudGV4dChcIlRydXNzOlwiKTtcbiAgY29uc3Qgc2VsZWN0VHJ1c3MgPSBjb250cm9scy5hcHBlbmQoXCJzZWxlY3RcIikuYXR0cihcImlkXCIsXCJ0cnVzc1R5cGVcIik7XG4gIHNlbGVjdFRydXNzLnNlbGVjdEFsbChcIm9wdGlvblwiKVxuICAgIC5kYXRhKFtcbiAgICAgIHt2YWw6XCJkb3VibGUtaG93ZVwiLCBsYWJlbDpcIkRvdWJsZSBIb3dlICg2LXBhbmVsKVwifSxcbiAgICAgIHt2YWw6XCJkb3VibGUtZmlua1wiLCBsYWJlbDpcIkRvdWJsZSBGaW5rICg0MC1mdCBjYW5vbmljYWwpXCJ9LFxuICAgIF0pXG4gICAgLmVudGVyKCkuYXBwZW5kKFwib3B0aW9uXCIpXG4gICAgICAuYXR0cihcInZhbHVlXCIsIGQ9PmQudmFsKS50ZXh0KGQ9PmQubGFiZWwpO1xuICBzZWxlY3RUcnVzcy5wcm9wZXJ0eShcInZhbHVlXCIsXCJkb3VibGUtaG93ZVwiKTtcblxuICAvLyBVbml0cyBzZWxlY3RvclxuICBjb250cm9scy5hcHBlbmQoXCJsYWJlbFwiKS5hdHRyKFwiZm9yXCIsXCJ1bml0c01vZGVcIikudGV4dChcIlVuaXRzOlwiKTtcbiAgY29uc3Qgc2VsZWN0VW5pdHMgPSBjb250cm9scy5hcHBlbmQoXCJzZWxlY3RcIikuYXR0cihcImlkXCIsXCJ1bml0c01vZGVcIik7XG4gIHNlbGVjdFVuaXRzLnNlbGVjdEFsbChcIm9wdGlvblwiKVxuICAgIC5kYXRhKFtcbiAgICAgIHt2YWw6XCJ1c2NzXCIsIGxhYmVsOlwiVVNDUyAoZnQgc3BhbiwgaW4gc3ViLWRpbXMpXCJ9LFxuICAgICAge3ZhbDpcIm1ldHJpY1wiLCBsYWJlbDpcIk1ldHJpYyAobSlcIn0sXG4gICAgXSlcbiAgICAuZW50ZXIoKS5hcHBlbmQoXCJvcHRpb25cIilcbiAgICAgIC5hdHRyKFwidmFsdWVcIiwgZD0+ZC52YWwpLnRleHQoZD0+ZC5sYWJlbCk7XG4gIHNlbGVjdFVuaXRzLnByb3BlcnR5KFwidmFsdWVcIixcInVzY3NcIik7XG5cbiAgLy8gRXh0cmEgaGVhZHJvb20gYWJvdmUgY2hvcmQgZm9yIGxhYmVsc1xuICBjb25zdCBtYXJnaW4gPSB7dG9wOiAxNjAsIHJpZ2h0OiA0MCwgYm90dG9tOiAxMTAsIGxlZnQ6IDYwfTtcbiAgY29uc3QgVyA9IDEwMDAsIEggPSA2NDA7XG4gIGNvbnN0IGlubmVyVyA9IFcgLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodDtcbiAgY29uc3QgaW5uZXJIID0gSCAtIG1hcmdpbi50b3AgLSBtYXJnaW4uYm90dG9tO1xuXG4gIGNvbnN0IHN2ZyA9IGNvbnRhaW5lci5hcHBlbmQoXCJzdmdcIikuYXR0cihcInZpZXdCb3hcIiwgWzAsMCxXLEhdLmpvaW4oXCIgXCIpKTtcbiAgY29uc3QgZyAgID0gc3ZnLmFwcGVuZChcImdcIikuYXR0cihcInRyYW5zZm9ybVwiLCBgdHJhbnNsYXRlKCR7bWFyZ2luLmxlZnR9LCR7bWFyZ2luLnRvcH0pYCk7XG5cbiAgLy8gPT09PT0gRGltZW5zaW9uIGRyYXdlcnMgPT09PT1cbiAgZnVuY3Rpb24gZHJhd0RpbUFsb25nQ2hvcmQodG9wTm9kZXMsIGssIGdyb3VwLCB1bml0c01vZGUsIHgsIHlTY2FsZSkge1xuICAgIGNvbnN0IEEgPSB0b3BOb2Rlc1trXSwgQiA9IHRvcE5vZGVzW2srMV07XG4gICAgaWYgKCFBIHx8ICFCKSByZXR1cm47XG4gICAgY29uc3QgUCA9IHt4OiB4KEEueGgpLCB5OiB5U2NhbGUoQS55aCl9O1xuICAgIGNvbnN0IFEgPSB7eDogeChCLnhoKSwgeTogeVNjYWxlKEIueWgpfTtcblxuICAgIC8vIFBlcnBlbmRpY3VsYXIgKG9mZnNldCBBQk9WRSBjaG9yZClcbiAgICBjb25zdCB1eCA9IFEueCAtIFAueCwgdXkgPSBRLnkgLSBQLnksIEwgPSBNYXRoLmh5cG90KHV4LCB1eSkgfHwgMTtcbiAgICBjb25zdCBueCA9IC0odXkgLyBMKSwgbnkgPSB1eCAvIEw7XG4gICAgY29uc3Qgb2ZmID0gMTIsIHNpZ24gPSAobnkgPiAwKSA/IC0xIDogMTtcbiAgICBjb25zdCBvZmZWZWMgPSB7eDogbnggKiBvZmYgKiBzaWduLCB5OiBueSAqIG9mZiAqIHNpZ259O1xuXG4gICAgZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImRpbVwiKVxuICAgICAgLmF0dHIoXCJ4MVwiLCBQLnggKyBvZmZWZWMueCkuYXR0cihcInkxXCIsIFAueSArIG9mZlZlYy55KVxuICAgICAgLmF0dHIoXCJ4MlwiLCBRLnggKyBvZmZWZWMueCkuYXR0cihcInkyXCIsIFEueSArIG9mZlZlYy55KTtcblxuICAgIGFycm93VGlja3MoUCwgUSwgb2ZmVmVjLCA1KS5mb3JFYWNoKHQgPT4gZ3JvdXAuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcInRpY2tcIilcbiAgICAgIC5hdHRyKFwieDFcIiwgdFswXSkuYXR0cihcInkxXCIsIHRbMV0pLmF0dHIoXCJ4MlwiLCB0WzJdKS5hdHRyKFwieTJcIiwgdFszXSkpO1xuXG4gICAgY29uc3QgbWlkID0geyB4OiAoUC54K1EueCkvMiArIG9mZlZlYy54LCB5OiAoUC55K1EueSkvMiArIG9mZlZlYy55IH07XG4gICAgY29uc3QgbGVuX20gPSBNYXRoLmh5cG90KEIueGggLSBBLnhoLCBCLnloIC0gQS55aCk7XG4gICAgZ3JvdXAuYXBwZW5kKFwidGV4dFwiKS5hdHRyKFwiY2xhc3NcIixcImxhYmVsLXNtYWxsXCIpXG4gICAgICAuYXR0cihcInhcIiwgbWlkLngpLmF0dHIoXCJ5XCIsIG1pZC55IC0gOCkuYXR0cihcInRleHQtYW5jaG9yXCIsIFwibWlkZGxlXCIpXG4gICAgICAudGV4dChmbXRTdWIobGVuX20sIHVuaXRzTW9kZSkpO1xuICB9XG5cbiAgZnVuY3Rpb24gZHJhd0RpbUhvcml6b250YWwodG9wTm9kZXMsIGssIGdyb3VwLCBiYXNlWSwgeU9mZnNldFB4LCB1bml0c01vZGUsIHgpIHtcbiAgICBjb25zdCBBID0gdG9wTm9kZXNba10sIEIgPSB0b3BOb2Rlc1trKzFdO1xuICAgIGlmICghQSB8fCAhQikgcmV0dXJuO1xuICAgIGNvbnN0IHgxcCA9IHgoQS54aCksIHgycCA9IHgoQi54aCk7XG4gICAgY29uc3QgeTAgID0gYmFzZVkgKyB5T2Zmc2V0UHg7XG5cbiAgICBncm91cC5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwiZGltXCIpXG4gICAgICAuYXR0cihcIngxXCIsIHgxcCkuYXR0cihcInkxXCIsIHkwKS5hdHRyKFwieDJcIiwgeDJwKS5hdHRyKFwieTJcIiwgeTApO1xuXG4gICAgW3gxcCwgeDJwXS5mb3JFYWNoKHh4ID0+IHtcbiAgICAgIGdyb3VwLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJleHRcIikuYXR0cihcIngxXCIsIHh4KS5hdHRyKFwieTFcIiwgYmFzZVkpLmF0dHIoXCJ4MlwiLCB4eCkuYXR0cihcInkyXCIsIHkwKTtcbiAgICAgIGdyb3VwLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ0aWNrXCIpLmF0dHIoXCJ4MVwiLCB4eCkuYXR0cihcInkxXCIsIHkwLTUpLmF0dHIoXCJ4MlwiLCB4eCkuYXR0cihcInkyXCIsIHkwKzUpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZHhfbSA9IChCLnhoIC0gQS54aCk7XG4gICAgZ3JvdXAuYXBwZW5kKFwidGV4dFwiKS5hdHRyKFwiY2xhc3NcIixcImxhYmVsLXNtYWxsXCIpXG4gICAgICAuYXR0cihcInhcIiwgKHgxcCt4MnApLzIpLmF0dHIoXCJ5XCIsIHkwIC0gNikuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgIC50ZXh0KGZtdFN1YihkeF9tLCB1bml0c01vZGUpKTtcbiAgfVxuXG4gIC8vID09PT09IFJlbmRlciBmdW5jdGlvbiAoc3dpdGNoYWJsZSkgPT09PT1cbiAgZnVuY3Rpb24gcmVuZGVyKHRydXNzVHlwZT1cImRvdWJsZS1ob3dlXCIsIHVuaXRzTW9kZT1cInVzY3NcIikge1xuICAgIGcuc2VsZWN0QWxsKFwiKlwiKS5yZW1vdmUoKTtcblxuICAgIGNvbnN0IGNob3JkcyA9IGcuYXBwZW5kKFwiZ1wiKTtcbiAgICBjb25zdCB3ZWJzRyAgPSBnLmFwcGVuZChcImdcIikuYXR0cihcImNsYXNzXCIsXCJ3ZWJzXCIpO1xuICAgIGNvbnN0IGRpbXMgICA9IGcuYXBwZW5kKFwiZ1wiKTtcbiAgICBjb25zdCBoaWdobGlnaHQgPSBnLmFwcGVuZChcImdcIik7XG4gICAgY29uc3Qgbm9kZXNHID0gZy5hcHBlbmQoXCJnXCIpO1xuXG4gICAgbGV0IHRvcE5vZGVzID0gW107XG4gICAgbGV0IHRvcFMgPSBudWxsO1xuICAgIGxldCBzcGFuX20gPSAwO1xuICAgIGxldCByaXNlX20gPSAwO1xuICAgIGxldCB4LCB5U2NhbGU7XG4gICAgbGV0IHRvcEpvaW5JZHggPSBuZXcgU2V0KCk7XG5cbiAgICBpZiAodHJ1c3NUeXBlID09PSBcImRvdWJsZS1ob3dlXCIpIHtcbiAgICAgIC8vID09PSBEb3VibGUgSG93ZSAoZGVmYXVsdCBzcGFuOiA0MCBmdCkgPT09XG4gICAgICBjb25zdCBzcGFuX2Z0ID0gNDA7XG4gICAgICBzcGFuX20gPSBzcGFuX2Z0ICogRlQ7XG4gICAgICByaXNlX20gPSAwLjIgKiBzcGFuX207ICAgICAgICAgICAvLyBzaW1wbGUgc3ltbWV0cmljIHJpZGdlXG4gICAgICBjb25zdCBuUGFuZWxzID0gNjtcbiAgICAgIGNvbnN0IHBhbmVsX20gPSBzcGFuX20gLyBuUGFuZWxzO1xuXG4gICAgICB4ID0gZDMuc2NhbGVMaW5lYXIoKS5kb21haW4oWzAsIHNwYW5fbV0pLnJhbmdlKFswLCBpbm5lclddKTtcbiAgICAgIHlTY2FsZSA9IGQzLnNjYWxlTGluZWFyKCkuZG9tYWluKFtyaXNlX20gKyAxLCAtMV0pLnJhbmdlKFswLCBpbm5lckhdKTtcbiAgICAgIGNvbnN0IGJhc2VZID0geVNjYWxlKDApO1xuXG4gICAgICAvLyBUb3AgY2hvcmQgbm9kZXMgKHN5bW1ldHJpYyByaWRnZSlcbiAgICAgIHRvcE5vZGVzID0gZDMucmFuZ2UoblBhbmVscyArIDEpLm1hcChpID0+IHtcbiAgICAgICAgY29uc3QgeGggPSBpICogcGFuZWxfbTtcbiAgICAgICAgY29uc3QgbWlkID0gc3Bhbl9tIC8gMjtcbiAgICAgICAgY29uc3QgdCA9IHhoIDw9IG1pZCA/IHhoIC8gbWlkIDogKHNwYW5fbSAtIHhoKSAvIG1pZDtcbiAgICAgICAgY29uc3QgeWggPSByaXNlX20gKiB0O1xuICAgICAgICByZXR1cm4ge2ksIHhoLCB5aH07XG4gICAgICB9KTtcblxuICAgICAgLy8gY2hvcmRzICYgYmFzZWxpbmVcbiAgICAgIGcuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImJhc2VsaW5lXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIiwgeCgwKSkuYXR0cihcInkxXCIsIGJhc2VZKS5hdHRyKFwieDJcIiwgeChzcGFuX20pKS5hdHRyKFwieTJcIiwgYmFzZVkpO1xuICAgICAgY2hvcmRzLmFwcGVuZChcInBhdGhcIikuYXR0cihcImNsYXNzXCIsXCJjaG9yZC1ib3RcIilcbiAgICAgICAgLmF0dHIoXCJkXCIsIGQzLmxpbmUoKS54KGQ9PmRbMF0pLnkoZD0+ZFsxXSkoW1t4KDApLCBiYXNlWV0sW3goc3Bhbl9tKSwgYmFzZVldXSkgKTtcbiAgICAgIGNob3Jkcy5hcHBlbmQoXCJwYXRoXCIpLmF0dHIoXCJjbGFzc1wiLFwiY2hvcmQtdG9wXCIpXG4gICAgICAgIC5hdHRyKFwiZFwiLCBkMy5saW5lKCkueChkPT54KGQueGgpKS55KGQ9PnlTY2FsZShkLnloKSkodG9wTm9kZXMpKTtcblxuICAgICAgLy8gd2VicyAoNSB2ZXJ0aWNhbHMgKyBkaWFnb25hbHMgdG93YXJkIGNlbnRlcilcbiAgICAgIGNvbnN0IG1pZElkeCA9IG5QYW5lbHMvMjtcbiAgICAgIFsxLDIsbWlkSWR4LDQsNV0uZm9yRWFjaChpPT57XG4gICAgICAgIHdlYnNHLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ3ZWJcIilcbiAgICAgICAgICAuYXR0cihcIngxXCIsIHgodG9wTm9kZXNbaV0ueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKHRvcE5vZGVzW2ldLnloKSlcbiAgICAgICAgICAuYXR0cihcIngyXCIsIHgodG9wTm9kZXNbaV0ueGgpKS5hdHRyKFwieTJcIiwgYmFzZVkpO1xuICAgICAgfSk7XG4gICAgICAvLyBkaWFnb25hbHM6IExlZnQgdG9wKDEpLT5ib3R0b20oMiksIHRvcCgyKS0+Ym90dG9tKDMpOyBSaWdodCB0b3AoNSktPmJvdHRvbSg0KSwgdG9wKDQpLT5ib3R0b20oMylcbiAgICAgIHdlYnNHLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ3ZWJcIilcbiAgICAgICAgLmF0dHIoXCJ4MVwiLCB4KHRvcE5vZGVzWzFdLnhoKSkuYXR0cihcInkxXCIsIHlTY2FsZSh0b3BOb2Rlc1sxXS55aCkpXG4gICAgICAgIC5hdHRyKFwieDJcIiwgeCh0b3BOb2Rlc1syXS54aCkpLmF0dHIoXCJ5MlwiLCBiYXNlWSk7XG4gICAgICB3ZWJzRy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwid2ViXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIiwgeCh0b3BOb2Rlc1syXS54aCkpLmF0dHIoXCJ5MVwiLCB5U2NhbGUodG9wTm9kZXNbMl0ueWgpKVxuICAgICAgICAuYXR0cihcIngyXCIsIHgodG9wTm9kZXNbbWlkSWR4XS54aCkpLmF0dHIoXCJ5MlwiLCBiYXNlWSk7XG4gICAgICB3ZWJzRy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwid2ViXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIiwgeCh0b3BOb2Rlc1s1XS54aCkpLmF0dHIoXCJ5MVwiLCB5U2NhbGUodG9wTm9kZXNbNV0ueWgpKVxuICAgICAgICAuYXR0cihcIngyXCIsIHgodG9wTm9kZXNbNF0ueGgpKS5hdHRyKFwieTJcIiwgYmFzZVkpO1xuICAgICAgd2Vic0cuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcIndlYlwiKVxuICAgICAgICAuYXR0cihcIngxXCIsIHgodG9wTm9kZXNbNF0ueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKHRvcE5vZGVzWzRdLnloKSlcbiAgICAgICAgLmF0dHIoXCJ4MlwiLCB4KHRvcE5vZGVzW21pZElkeF0ueGgpKS5hdHRyKFwieTJcIiwgYmFzZVkpO1xuXG4gICAgICAvLyBpbmNsdWRlIGVuZCBub2RlcyBpbiBob3ZlciBzZXRcbiAgICAgIHRvcEpvaW5JZHggPSBuZXcgU2V0KFswLDEsMiwzLDQsNSw2XSk7XG4gICAgICB0b3BTID0gYWNjdW11bGF0ZUFyYyh0b3BOb2Rlcyk7XG5cbiAgICAgIC8vIHBlci1wYW5lbCBkaW1zIChzdWItZGltZW5zaW9ucylcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdG9wTm9kZXMubGVuZ3RoIC0gMTsgaysrKSB7XG4gICAgICAgIGRyYXdEaW1BbG9uZ0Nob3JkKHRvcE5vZGVzLCBrLCBkaW1zLCB1bml0c01vZGUsIHgsIHlTY2FsZSk7XG4gICAgICAgIGRyYXdEaW1Ib3Jpem9udGFsKHRvcE5vZGVzLCBrLCBkaW1zLCBiYXNlWSwgMjgsIHVuaXRzTW9kZSwgeCk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRvdGFsIHNwYW4gZGltXG4gICAgICBjb25zdCB5RF90b3RhbCA9IGJhc2VZICsgNzA7XG4gICAgICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJkaW0gZGltLXRvdGFsXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIiwgeCgwKSkuYXR0cihcInkxXCIsIHlEX3RvdGFsKS5hdHRyKFwieDJcIiwgeChzcGFuX20pKS5hdHRyKFwieTJcIiwgeURfdG90YWwpO1xuICAgICAgWzAsIHNwYW5fbV0uZm9yRWFjaChYPT57XG4gICAgICAgIGRpbXMuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImV4dFwiKVxuICAgICAgICAgIC5hdHRyKFwieDFcIiwgeChYKSkuYXR0cihcInkxXCIsIGJhc2VZKS5hdHRyKFwieDJcIiwgeChYKSkuYXR0cihcInkyXCIsIHlEX3RvdGFsKTtcbiAgICAgIH0pO1xuICAgICAgW1t4KDApLHlEX3RvdGFsXSxbeChzcGFuX20pLHlEX3RvdGFsXV0uZm9yRWFjaCgoW3h4LHl5XSk9PntcbiAgICAgICAgZGltcy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidGlja1wiKS5hdHRyKFwieDFcIiwgeHgpLmF0dHIoXCJ5MVwiLCB5eS02KS5hdHRyKFwieDJcIiwgeHgpLmF0dHIoXCJ5MlwiLCB5eSs2KTtcbiAgICAgIH0pO1xuICAgICAgZGltcy5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJjbGFzc1wiLFwibGFiZWxcIilcbiAgICAgICAgLmF0dHIoXCJ4XCIsICh4KDApK3goc3Bhbl9tKSkvMikuYXR0cihcInlcIiwgeURfdG90YWwgLSAxMCkuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgLnRleHQoYCR7Zm10U3BhbihzcGFuX20sIHVuaXRzTW9kZSl9IChob3Jpem9udGFsIHNwYW4pYCk7XG5cbiAgICAgIC8vIHRvcC1jaG9yZCB0cnVlIGxlbmd0aCBsYWJlbCAoc2xhbnRlZCwgbGVmdCBoYWxmLCB+ODVweCBvZmYpXG4gICAgICBwbGFjZVRvcENob3JkTGVuZ3RoTGFiZWwodG9wTm9kZXMsIHRvcFMsIGRpbXMsIHVuaXRzTW9kZSwgeCwgeVNjYWxlKTtcblxuICAgICAgLy8gTkVXOiBkaWFnb25hbC1jaG9yZCBkaW0gKGxlZnQgdG9wIGNob3JkKSBiZWxvdyB0aGUgbGFiZWxcbiAgICAgIGRyYXdMZWZ0VG9wQ2hvcmREaWFnRGltKHRvcE5vZGVzLCBkaW1zLCB4LCB5U2NhbGUpO1xuXG4gICAgICAvLyBhcGV4LWhlaWdodCBkaW0gYXQgbGVmdCAoc2hvcnQgZXF1YWwgc3R1YnM7IHZlcnRpY2FsIGxhYmVsKVxuICAgICAgZHJhd0FwZXhIZWlnaHREaW0oZGltcywgeCwgeVNjYWxlLCBzcGFuX20sIHJpc2VfbSwgdW5pdHNNb2RlKTtcblxuICAgICAgLy8gY29sb3Igc2NhbGVcbiAgICAgIGNvbnN0IGNvbG9yU2NhbGUgPSBkMy5zY2FsZU9yZGluYWwoKVxuICAgICAgICAuZG9tYWluKGQzLnJhbmdlKHRvcFMubGVuZ3RoKSlcbiAgICAgICAgLnJhbmdlKFtcIiMyNTYzZWJcIixcIiNkYzI2MjZcIixcIiMxNmEzNGFcIixcIiNhODU1ZjdcIixcIiNlYTU4MGNcIixcIiMwODkxYjJcIixcIiNlYWIzMDhcIixcIiMwZWE1ZTlcIixcIiNmOTczMTZcIixcIiMyMmM1NWVcIixcIiNlZjQ0NDRcIl0pO1xuXG4gICAgICBmdW5jdGlvbiBzaG93VHJpYnV0YXJ5KGlOb2RlKSB7XG4gICAgICAgIGhpZ2hsaWdodC5zZWxlY3RBbGwoXCIqXCIpLnJlbW92ZSgpO1xuICAgICAgICBjb25zdCBjb2xvciA9IGNvbG9yU2NhbGUoaU5vZGUpO1xuXG4gICAgICAgIC8vIEFsb25nLWNob3JkIHNwYW5cbiAgICAgICAgbGV0IHMwLCBzMTtcbiAgICAgICAgaWYgKGlOb2RlID09PSAwKSB7XG4gICAgICAgICAgY29uc3QgeEVuZCA9IHRvcE5vZGVzWzBdLnhoLCB4TmV4dCA9IHRvcE5vZGVzWzFdLnhoO1xuICAgICAgICAgIGNvbnN0IHhIYWxmID0geEVuZCArICh4TmV4dCAtIHhFbmQpLzI7XG4gICAgICAgICAgczAgPSAwO1xuICAgICAgICAgIHMxID0gc0F0WCh0b3BTLCB4SGFsZik7XG4gICAgICAgIH0gZWxzZSBpZiAoaU5vZGUgPT09IHRvcFMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGNvbnN0IHhFbmQgPSB0b3BOb2Rlc1t0b3BOb2Rlcy5sZW5ndGgtMV0ueGgsIHhQcmV2ID0gdG9wTm9kZXNbdG9wTm9kZXMubGVuZ3RoLTJdLnhoO1xuICAgICAgICAgIGNvbnN0IHhIYWxmID0geFByZXYgKyAoeEVuZCAtIHhQcmV2KS8yO1xuICAgICAgICAgIHMwID0gc0F0WCh0b3BTLCB4SGFsZik7XG4gICAgICAgICAgczEgPSB0b3BTW3RvcFMubGVuZ3RoLTFdLnM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3Qgc19pICAgPSB0b3BTW2lOb2RlXS5zO1xuICAgICAgICAgIGNvbnN0IHNfcHJldiA9IHRvcFNbaU5vZGUtMV0ucztcbiAgICAgICAgICBjb25zdCBzX25leHQgPSB0b3BTW2lOb2RlKzFdLnM7XG4gICAgICAgICAgczAgPSAoc19wcmV2ICsgc19pKSAvIDI7XG4gICAgICAgICAgczEgPSAoc19pICsgc19uZXh0KSAvIDI7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZWdzID0gc2xpY2VQb2x5bGluZUJ5Uyh0b3BTLCBzMCwgczEpO1xuXG4gICAgICAgIHNlZ3MuZm9yRWFjaCgoW1AsUV0pPT57XG4gICAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ0cmlidVwiKS5hdHRyKFwic3Ryb2tlXCIsIGNvbG9yKVxuICAgICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4KFAueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKFAueWgpKVxuICAgICAgICAgICAgLmF0dHIoXCJ4MlwiLCB4KFEueGgpKS5hdHRyKFwieTJcIiwgeVNjYWxlKFEueWgpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTWV0cmljcyAmIGxhYmVsIHBsYWNlbWVudFxuICAgICAgICBsZXQgTF9hbG9uZyA9IDAsIFhjID0gMCwgWWMgPSAwLCBzdW1EWHAgPSAwLCBzdW1EWXAgPSAwO1xuICAgICAgICBzZWdzLmZvckVhY2goKFtQLFFdKT0+e1xuICAgICAgICAgIGNvbnN0IGRzID0gTWF0aC5oeXBvdChRLnhoIC0gUC54aCwgUS55aCAtIFAueWgpO1xuICAgICAgICAgIExfYWxvbmcgKz0gZHM7XG4gICAgICAgICAgY29uc3QgeG0gPSAoUC54aCArIFEueGgpLzIsIHltID0gKFAueWggKyBRLnloKS8yO1xuICAgICAgICAgIFhjICs9IHhtICogZHM7IFljICs9IHltICogZHM7XG4gICAgICAgICAgc3VtRFhwICs9ICh4KFEueGgpIC0geChQLnhoKSk7XG4gICAgICAgICAgc3VtRFlwICs9ICh5U2NhbGUoUS55aCkgLSB5U2NhbGUoUC55aCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKExfYWxvbmcgPiAwKSB7IFhjIC89IExfYWxvbmc7IFljIC89IExfYWxvbmc7IH1cblxuICAgICAgICBjb25zdCBMcCA9IE1hdGguaHlwb3Qoc3VtRFhwLCBzdW1EWXApIHx8IDE7XG4gICAgICAgIGxldCBueCA9IC1zdW1EWXAgLyBMcCwgbnkgPSBzdW1EWHAgLyBMcDtcbiAgICAgICAgY29uc3Qgc2lnbiA9IChueSA+IDApID8gLTEgOiAxO1xuICAgICAgICBjb25zdCBvZmZBbG9uZyA9IDUwLCBvZmZOb2RlID0gNzQ7XG4gICAgICAgIGNvbnN0IGFuZ2xlRGVnID0gTWF0aC5hdGFuMihzdW1EWXAsIHN1bURYcCkgKiAxODAvTWF0aC5QSTtcblxuICAgICAgICBjb25zdCB0eCA9IHgoWGMpICsgbnggKiBvZmZBbG9uZyAqIHNpZ247XG4gICAgICAgIGNvbnN0IHR5ID0geVNjYWxlKFljKSArIG55ICogb2ZmQWxvbmcgKiBzaWduO1xuICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIixcImxhYmVsLWRpbVwiKVxuICAgICAgICAgIC5hdHRyKFwiZmlsbFwiLCBjb2xvcilcbiAgICAgICAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBgdHJhbnNsYXRlKCR7dHh9LCR7dHl9KSByb3RhdGUoJHthbmdsZURlZ30pYClcbiAgICAgICAgICAudGV4dChgQWxvbmcgY2hvcmQ6ICR7Zm10U3ViKExfYWxvbmcsIHVuaXRzTW9kZSl9YCk7XG5cbiAgICAgICAgY29uc3QgdHgyID0geChYYykgKyBueCAqIG9mZk5vZGUgKiBzaWduO1xuICAgICAgICBjb25zdCB0eTIgPSB5U2NhbGUoWWMpICsgbnkgKiBvZmZOb2RlICogc2lnbjtcbiAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcInRleHRcIilcbiAgICAgICAgICAuYXR0cihcImNsYXNzXCIsXCJsYWJlbC1kaW1cIilcbiAgICAgICAgICAuYXR0cihcImZpbGxcIiwgY29sb3IpXG4gICAgICAgICAgLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLFwibWlkZGxlXCIpXG4gICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgYHRyYW5zbGF0ZSgke3R4Mn0sJHt0eTJ9KSByb3RhdGUoJHthbmdsZURlZ30pYClcbiAgICAgICAgICAudGV4dChgTm9kZSAke2lOb2RlfSB0cmlidXRhcnlgKTtcblxuICAgICAgICAvLyBIb3Jpem9udGFsIHByb2plY3Rpb25cbiAgICAgICAgY29uc3QgbiA9IHRvcE5vZGVzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgeEggPSB0b3BOb2Rlc1tpTm9kZV0ueGg7XG4gICAgICAgIGNvbnN0IHhMID0gKGlOb2RlID09PSAwKSAgICAgPyB4SCA6ICh4SCArIHRvcE5vZGVzW2lOb2RlLTFdLnhoKS8yO1xuICAgICAgICBjb25zdCB4UiA9IChpTm9kZSA9PT0gbi0xKSAgID8geEggOiAoeEggKyB0b3BOb2Rlc1tpTm9kZSsxXS54aCkvMjtcblxuICAgICAgICBjb25zdCBMeF9tID0gTWF0aC5hYnMoeFIgLSB4TCk7XG4gICAgICAgIGNvbnN0IHhMZWZ0X20gID0gTWF0aC5taW4oeEwsIHhSKTtcbiAgICAgICAgY29uc3QgeFJpZ2h0X20gPSBNYXRoLm1heCh4TCwgeFIpO1xuICAgICAgICBjb25zdCB4MXAgPSB4KHhMZWZ0X20pLCB4MnAgPSB4KHhSaWdodF9tKTtcbiAgICAgICAgY29uc3QgeUQgPSBiYXNlWSArIDk1O1xuXG4gICAgICAgIGhpZ2hsaWdodC5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidHJpYnUtZGltXCIpLmF0dHIoXCJzdHJva2VcIiwgY29sb3IpXG4gICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4MXApLmF0dHIoXCJ5MVwiLCB5RCkuYXR0cihcIngyXCIsIHgycCkuYXR0cihcInkyXCIsIHlEKTtcbiAgICAgICAgW3gxcCx4MnBdLmZvckVhY2goeHg9PntcbiAgICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcInRyaWJ1LWRpbVwiKS5hdHRyKFwic3Ryb2tlXCIsIGNvbG9yKVxuICAgICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4eCkuYXR0cihcInkxXCIsIGJhc2VZKS5hdHRyKFwieDJcIiwgeHgpLmF0dHIoXCJ5MlwiLCB5RCk7XG4gICAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ0cmlidS1kaW1cIikuYXR0cihcInN0cm9rZVwiLCBjb2xvcilcbiAgICAgICAgICAgIC5hdHRyKFwieDFcIiwgeHgpLmF0dHIoXCJ5MVwiLCB5RC02KS5hdHRyKFwieDJcIiwgeHgpLmF0dHIoXCJ5MlwiLCB5RCs2KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGhpZ2hsaWdodC5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJjbGFzc1wiLFwibGFiZWwtZGltXCIpLmF0dHIoXCJmaWxsXCIsIGNvbG9yKVxuICAgICAgICAgIC5hdHRyKFwieFwiLCAoeDFwK3gycCkvMikuYXR0cihcInlcIiwgeUQgKyAxNikuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgICAudGV4dChgSG9yaXpvbnRhbDogJHtmbXRTdWIoTHhfbSwgdW5pdHNNb2RlKX1gKTtcblxuICAgICAgICBjb25zdCBsZWZ0SW4gID0gKHhMZWZ0X20gIC8gSU4pLnRvRml4ZWQoMik7XG4gICAgICAgIGNvbnN0IHJpZ2h0SW4gPSAoeFJpZ2h0X20gLyBJTikudG9GaXhlZCgyKTtcbiAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcInRleHRcIikuYXR0cihcImNsYXNzXCIsXCJsYWJlbC1kaW1cIikuYXR0cihcImZpbGxcIiwgY29sb3IpXG4gICAgICAgICAgLmF0dHIoXCJ4XCIsIHgxcCkuYXR0cihcInlcIiwgeUQgKyAzMikuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgICAudGV4dChgJHtsZWZ0SW59IGluYCk7XG4gICAgICAgIGhpZ2hsaWdodC5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJjbGFzc1wiLFwibGFiZWwtZGltXCIpLmF0dHIoXCJmaWxsXCIsIGNvbG9yKVxuICAgICAgICAgIC5hdHRyKFwieFwiLCB4MnApLmF0dHIoXCJ5XCIsIHlEICsgMzIpLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLFwibWlkZGxlXCIpXG4gICAgICAgICAgLnRleHQoYCR7cmlnaHRJbn0gaW5gKTtcbiAgICAgIH1cblxuICAgICAgLy8gSG92ZXIgY2lyY2xlcyAoaW5jbHVkZXMgZW5kIG5vZGVzKVxuICAgICAgY29uc3QgdG9wSm9pblNvcnRlZCA9IEFycmF5LmZyb20odG9wSm9pbklkeCkuc29ydCgoYSxiKT0+YS1iKTtcbiAgICAgIHRvcEpvaW5Tb3J0ZWQuZm9yRWFjaCgoaWR4KSA9PiB7XG4gICAgICAgIGNvbnN0IG5kID0gdG9wTm9kZXNbaWR4XTtcbiAgICAgICAgY29uc3QgcHggPSB4KG5kLnhoKSwgcHkgPSB5U2NhbGUobmQueWgpO1xuICAgICAgICBub2Rlc0cuYXBwZW5kKFwiY2lyY2xlXCIpLmF0dHIoXCJjbGFzc1wiLFwibm9kZS1yaW5nXCIpLmF0dHIoXCJjeFwiLCBweCkuYXR0cihcImN5XCIsIHB5KS5hdHRyKFwiclwiLCA1KTtcbiAgICAgICAgbm9kZXNHLmFwcGVuZChcImNpcmNsZVwiKS5hdHRyKFwiY2xhc3NcIixcIm5vZGUtaGl0XCIpLmF0dHIoXCJjeFwiLCBweCkuYXR0cihcImN5XCIsIHB5KS5hdHRyKFwiclwiLCAxNClcbiAgICAgICAgICAub24oXCJtb3VzZWVudGVyXCIsIGZ1bmN0aW9uKCl7IGQzLnNlbGVjdCh0aGlzLnByZXZpb3VzU2libGluZykuY2xhc3NlZChcImhvdFwiLCB0cnVlKTsgc2hvd1RyaWJ1dGFyeShpZHgpOyB9KVxuICAgICAgICAgIC5vbihcIm1vdXNlbGVhdmVcIiwgZnVuY3Rpb24oKXsgZDMuc2VsZWN0KHRoaXMucHJldmlvdXNTaWJsaW5nKS5jbGFzc2VkKFwiaG90XCIsIGZhbHNlKTsgaGlnaGxpZ2h0LnNlbGVjdEFsbChcIipcIikucmVtb3ZlKCk7IH0pO1xuICAgICAgfSk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gPT09IERvdWJsZSBGaW5rIChjYW5vbmljYWwgNDAgZnQ7IGFuZ2xlcyBwcmVzZXJ2ZWQpID09PVxuICAgICAgY29uc3Qgc3Bhbl9mdCA9IDQwLCBzcGFuX2luID0gc3Bhbl9mdCAqIDEyLCBoYWxmX2luID0gc3Bhbl9pbi8yO1xuICAgICAgY29uc3QgcmlzZV9iYXNlX2luID0gMTA1Ljk1ODsgICAgICAgICAgICAgIC8vIGdpdmVuIGF0IDQwIGZ0XG4gICAgICBjb25zdCBzbG9wZV9wZXJfaW4gPSByaXNlX2Jhc2VfaW4gLyAyNDA7ICAgLy8gcGVyIGluY2ggb2YgaGFsZi1zcGFuXG4gICAgICBjb25zdCByaXNlX2luID0gc2xvcGVfcGVyX2luICogaGFsZl9pbjtcbiAgICAgIHJpc2VfbSA9IHJpc2VfaW4gKiBJTjtcbiAgICAgIHNwYW5fbSA9IHNwYW5faW4gKiBJTjtcblxuICAgICAgeCA9IGQzLnNjYWxlTGluZWFyKCkuZG9tYWluKFswLCBzcGFuX21dKS5yYW5nZShbMCwgaW5uZXJXXSk7XG4gICAgICB5U2NhbGUgPSBkMy5zY2FsZUxpbmVhcigpLmRvbWFpbihbcmlzZV9tICsgMSwgLTFdKS5yYW5nZShbMCwgaW5uZXJIXSk7XG4gICAgICBjb25zdCBiYXNlWSA9IHlTY2FsZSgwKTtcblxuICAgICAgY29uc3QgciA9IHNwYW5faW4gLyA0ODA7XG4gICAgICBjb25zdCB0b3BfeF9pbiA9IFswLCA4OC40LCAxNjQuMiwgMjQwLjAsIDMxNS44LCAzOTEuNiwgNDgwLjBdLm1hcCh2ID0+IHYgKiByKTtcbiAgICAgIGNvbnN0IHRvcE5vZGVzX2luID0gdG9wX3hfaW4ubWFwKCh4aW4sIGkpID0+ICh7IGksIHhoX2luOiB4aW4sIHloX2luOiBzbG9wZV9wZXJfaW4gKiBNYXRoLm1pbih4aW4sIHNwYW5faW4gLSB4aW4pIH0pKTtcbiAgICAgIHRvcE5vZGVzID0gdG9wTm9kZXNfaW4ubWFwKCh7aSwgeGhfaW4sIHloX2lufSkgPT4gKHsgaSwgeGg6IHhoX2luKklOLCB5aDogeWhfaW4qSU4gfSkpO1xuXG4gICAgICAvLyBjaG9yZHMgJiBiYXNlbGluZVxuICAgICAgZy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwiYmFzZWxpbmVcIilcbiAgICAgICAgLmF0dHIoXCJ4MVwiLCB4KDApKS5hdHRyKFwieTFcIiwgYmFzZVkpLmF0dHIoXCJ4MlwiLCB4KHNwYW5fbSkpLmF0dHIoXCJ5MlwiLCBiYXNlWSk7XG4gICAgICBjaG9yZHMuYXBwZW5kKFwicGF0aFwiKS5hdHRyKFwiY2xhc3NcIixcImNob3JkLWJvdFwiKVxuICAgICAgICAuYXR0cihcImRcIiwgZDMubGluZSgpLngoZD0+ZFswXSkueShkPT5kWzFdKShbW3goMCksIGJhc2VZXSxbeChzcGFuX20pLCBiYXNlWV1dKSApO1xuICAgICAgY2hvcmRzLmFwcGVuZChcInBhdGhcIikuYXR0cihcImNsYXNzXCIsXCJjaG9yZC10b3BcIilcbiAgICAgICAgLmF0dHIoXCJkXCIsIGQzLmxpbmUoKS54KGQ9PngoZC54aCkpLnkoZD0+eVNjYWxlKGQueWgpKSh0b3BOb2RlcykpO1xuXG4gICAgICAvLyB3ZWJzIHBlciBjYW5vbmljYWwgbWFwcGluZ1xuICAgICAgY29uc3QgYnB0ID0geGluID0+ICh7IHhoOiB4aW4qSU4sIHloOiAwIH0pO1xuICAgICAgY29uc3QgVCA9IHRvcE5vZGVzO1xuICAgICAgY29uc3QgQ190b3AgICA9IFRbM10sIEwxX3RvcCA9IFRbMV0sIEwyTDNfdG9wID0gVFsyXSwgUjJSM190b3AgPSBUWzRdLCBSMV90b3AgPSBUWzVdO1xuICAgICAgY29uc3QgYl9taWQgICA9IGJwdCgyNDAuMCAqIHIpO1xuICAgICAgY29uc3QgYl8xMDM1NiA9IGJwdCgxMDMuNTYgKiByKSwgYl8xOTQ1MiA9IGJwdCgxOTQuNTIgKiByKTtcbiAgICAgIGNvbnN0IGJfMjg1NDggPSBicHQoMjg1LjQ4ICogciksIGJfMzc2NDQgPSBicHQoMzc2LjQ0ICogcik7XG5cbiAgICAgIC8vIExlZnQgZGlhZ29uYWxzXG4gICAgICBbW0wxX3RvcCwgYl8xMDM1Nl0sW0wyTDNfdG9wLCBiXzEwMzU2XSxbTDJMM190b3AsIGJfMTk0NTJdLFtDX3RvcCwgYl8xOTQ1Ml1dLmZvckVhY2goKFtQLFFdKT0+e1xuICAgICAgICB3ZWJzRy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwid2ViXCIpXG4gICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4KFAueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKFAueWgpKVxuICAgICAgICAgIC5hdHRyKFwieDJcIiwgeChRLnhoKSkuYXR0cihcInkyXCIsIHlTY2FsZShRLnloKSk7XG4gICAgICB9KTtcbiAgICAgIC8vIENlbnRlciB2ZXJ0aWNhbFxuICAgICAgd2Vic0cuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcIndlYlwiKVxuICAgICAgICAuYXR0cihcIngxXCIsIHgoQ190b3AueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKENfdG9wLnloKSlcbiAgICAgICAgLmF0dHIoXCJ4MlwiLCB4KGJfbWlkLnhoKSkuYXR0cihcInkyXCIsIHlTY2FsZShiX21pZC55aCkpO1xuICAgICAgLy8gUmlnaHQgZGlhZ29uYWxzXG4gICAgICBbW1IxX3RvcCwgYl8zNzY0NF0sW1IyUjNfdG9wLCBiXzM3NjQ0XSxbUjJSM190b3AsIGJfMjg1NDhdLFtDX3RvcCwgYl8yODU0OF1dLmZvckVhY2goKFtQLFFdKT0+e1xuICAgICAgICB3ZWJzRy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwid2ViXCIpXG4gICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4KFAueGgpKS5hdHRyKFwieTFcIiwgeVNjYWxlKFAueWgpKVxuICAgICAgICAgIC5hdHRyKFwieDJcIiwgeChRLnhoKSkuYXR0cihcInkyXCIsIHlTY2FsZShRLnloKSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gaW5jbHVkZSBlbmQgbm9kZXNcbiAgICAgIHRvcEpvaW5JZHggPSBuZXcgU2V0KFswLDEsMiwzLDQsNSw2XSk7XG4gICAgICB0b3BTID0gYWNjdW11bGF0ZUFyYyh0b3BOb2Rlcyk7XG5cbiAgICAgIC8vIHBlci1wYW5lbCBkaW1zIChzdWItZGltZW5zaW9ucylcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdG9wTm9kZXMubGVuZ3RoIC0gMTsgaysrKSB7XG4gICAgICAgIGRyYXdEaW1BbG9uZ0Nob3JkKHRvcE5vZGVzLCBrLCBkaW1zLCB1bml0c01vZGUsIHgsIHlTY2FsZSk7XG4gICAgICAgIGRyYXdEaW1Ib3Jpem9udGFsKHRvcE5vZGVzLCBrLCBkaW1zLCBiYXNlWSwgMjgsIHVuaXRzTW9kZSwgeCk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRvdGFsIHNwYW4gZGltXG4gICAgICBjb25zdCB5RF90b3RhbCA9IGJhc2VZICsgNzA7XG4gICAgICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJkaW0gZGltLXRvdGFsXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIiwgeCgwKSkuYXR0cihcInkxXCIsIHlEX3RvdGFsKS5hdHRyKFwieDJcIiwgeChzcGFuX20pKS5hdHRyKFwieTJcIiwgeURfdG90YWwpO1xuICAgICAgWzAsIHNwYW5fbV0uZm9yRWFjaChYPT57XG4gICAgICAgIGRpbXMuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcImV4dFwiKVxuICAgICAgICAgIC5hdHRyKFwieDFcIiwgeChYKSkuYXR0cihcInkxXCIsIGJhc2VZKS5hdHRyKFwieDJcIiwgeChYKSkuYXR0cihcInkyXCIsIHlEX3RvdGFsKTtcbiAgICAgIH0pO1xuICAgICAgW1t4KDApLHlEX3RvdGFsXSxbeChzcGFuX20pLHlEX3RvdGFsXV0uZm9yRWFjaCgoW3h4LHl5XSk9PntcbiAgICAgICAgZGltcy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidGlja1wiKS5hdHRyKFwieDFcIiwgeHgpLmF0dHIoXCJ5MVwiLCB5eS02KS5hdHRyKFwieDJcIiwgeHgpLmF0dHIoXCJ5MlwiLCB5eSs2KTtcbiAgICAgIH0pO1xuICAgICAgZGltcy5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJjbGFzc1wiLFwibGFiZWxcIilcbiAgICAgICAgLmF0dHIoXCJ4XCIsICh4KDApK3goc3Bhbl9tKSkvMikuYXR0cihcInlcIiwgeURfdG90YWwgLSAxMCkuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgLnRleHQoYCR7Zm10U3BhbihzcGFuX20sIHVuaXRzTW9kZSl9IChob3Jpem9udGFsIHNwYW4pYCk7XG5cbiAgICAgIC8vIHRvcC1jaG9yZCB0cnVlIGxlbmd0aCBsYWJlbCAoc2xhbnRlZCwgbGVmdCBoYWxmLCB+ODVweCBvZmYpXG4gICAgICBwbGFjZVRvcENob3JkTGVuZ3RoTGFiZWwodG9wTm9kZXMsIHRvcFMsIGRpbXMsIHVuaXRzTW9kZSwgeCwgeVNjYWxlKTtcblxuICAgICAgLy8gTkVXOiBkaWFnb25hbC1jaG9yZCBkaW0gKGxlZnQgdG9wIGNob3JkKSBiZWxvdyB0aGUgbGFiZWxcbiAgICAgIGRyYXdMZWZ0VG9wQ2hvcmREaWFnRGltKHRvcE5vZGVzLCBkaW1zLCB4LCB5U2NhbGUpO1xuXG4gICAgICAvLyBhcGV4LWhlaWdodCBkaW0gYXQgbGVmdCAoc2hvcnQgZXF1YWwgc3R1YnM7IHZlcnRpY2FsIGxhYmVsKVxuICAgICAgZHJhd0FwZXhIZWlnaHREaW0oZGltcywgeCwgeVNjYWxlLCBzcGFuX20sIHJpc2VfbSwgdW5pdHNNb2RlKTtcblxuICAgICAgLy8gY29sb3Igc2NhbGVcbiAgICAgIGNvbnN0IGNvbG9yU2NhbGUgPSBkMy5zY2FsZU9yZGluYWwoKVxuICAgICAgICAuZG9tYWluKGQzLnJhbmdlKHRvcFMubGVuZ3RoKSlcbiAgICAgICAgLnJhbmdlKFtcIiMyNTYzZWJcIixcIiNkYzI2MjZcIixcIiMxNmEzNGFcIixcIiNhODU1ZjdcIixcIiNlYTU4MGNcIixcIiMwODkxYjJcIixcIiNlYWIzMDhcIixcIiMwZWE1ZTlcIixcIiNmOTczMTZcIixcIiMyMmM1NWVcIixcIiNlZjQ0NDRcIl0pO1xuXG4gICAgICBmdW5jdGlvbiBzaG93VHJpYnV0YXJ5KGlOb2RlKSB7XG4gICAgICAgIGhpZ2hsaWdodC5zZWxlY3RBbGwoXCIqXCIpLnJlbW92ZSgpO1xuICAgICAgICBjb25zdCBjb2xvciA9IGNvbG9yU2NhbGUoaU5vZGUpO1xuXG4gICAgICAgIC8vIEFsb25nLWNob3JkIHNwYW4gKEZpbmsgcnVsZTogYWxvbmctY2hvcmQgaGFsdmVzIGJldHdlZW4gbmVpZ2hib3JzKVxuICAgICAgICBjb25zdCBzX2kgICA9IHRvcFNbaU5vZGVdLnM7XG4gICAgICAgIGNvbnN0IHNfcHJldiA9IGlOb2RlID4gMCA/IHRvcFNbaU5vZGUtMV0ucyA6IHNfaTtcbiAgICAgICAgY29uc3Qgc19uZXh0ID0gaU5vZGUgPCB0b3BTLmxlbmd0aC0xID8gdG9wU1tpTm9kZSsxXS5zIDogc19pO1xuXG4gICAgICAgIGxldCBzMCwgczE7XG4gICAgICAgIGlmIChpTm9kZSA9PT0gMCkge1xuICAgICAgICAgIHMwID0gc19pO1xuICAgICAgICAgIHMxID0gc19pICsgMC41KihzX25leHQgLSBzX2kpO1xuICAgICAgICB9IGVsc2UgaWYgKGlOb2RlID09PSB0b3BTLmxlbmd0aC0xKSB7XG4gICAgICAgICAgczAgPSBzX2kgLSAwLjUqKHNfaSAtIHNfcHJldik7XG4gICAgICAgICAgczEgPSBzX2k7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgczAgPSAoc19wcmV2ICsgc19pKS8yO1xuICAgICAgICAgIHMxID0gKHNfaSArIHNfbmV4dCkvMjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNlZ3MgPSBzbGljZVBvbHlsaW5lQnlTKHRvcFMsIHMwLCBzMSk7XG5cbiAgICAgICAgc2Vncy5mb3JFYWNoKChbUCxRXSk9PntcbiAgICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcInRyaWJ1XCIpLmF0dHIoXCJzdHJva2VcIiwgY29sb3IpXG4gICAgICAgICAgICAuYXR0cihcIngxXCIsIHgoUC54aCkpLmF0dHIoXCJ5MVwiLCB5U2NhbGUoUC55aCkpXG4gICAgICAgICAgICAuYXR0cihcIngyXCIsIHgoUS54aCkpLmF0dHIoXCJ5MlwiLCB5U2NhbGUoUS55aCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBNZXRyaWNzICYgbGFiZWwgcGxhY2VtZW50XG4gICAgICAgIGxldCBMX2Fsb25nID0gMCwgWGMgPSAwLCBZYyA9IDAsIHN1bURYcCA9IDAsIHN1bURZcCA9IDA7XG4gICAgICAgIHNlZ3MuZm9yRWFjaCgoW1AsUV0pPT57XG4gICAgICAgICAgY29uc3QgZHMgPSBNYXRoLmh5cG90KFEueGggLSBQLnhoLCBRLnloIC0gUC55aCk7XG4gICAgICAgICAgTF9hbG9uZyArPSBkcztcbiAgICAgICAgICBjb25zdCB4bSA9IChQLnhoICsgUS54aCkvMiwgeW0gPSAoUC55aCArIFEueWgpLzI7XG4gICAgICAgICAgWGMgKz0geG0gKiBkczsgWWMgKz0geW0gKiBkcztcbiAgICAgICAgICBzdW1EWHAgKz0gKHgoUS54aCkgLSB4KFAueGgpKTtcbiAgICAgICAgICBzdW1EWXAgKz0gKHlTY2FsZShRLnloKSAtIHlTY2FsZShQLnloKSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoTF9hbG9uZyA+IDApIHsgWGMgLz0gTF9hbG9uZzsgWWMgLz0gTF9hbG9uZzsgfVxuXG4gICAgICAgIGNvbnN0IExwID0gTWF0aC5oeXBvdChzdW1EWHAsIHN1bURZcCkgfHwgMTtcbiAgICAgICAgbGV0IG54ID0gLXN1bURZcCAvIExwLCBueSA9IHN1bURYcCAvIExwO1xuICAgICAgICBjb25zdCBzaWduID0gKG55ID4gMCkgPyAtMSA6IDE7XG4gICAgICAgIGNvbnN0IG9mZkFsb25nID0gNTAsIG9mZk5vZGUgPSA3NDtcbiAgICAgICAgY29uc3QgYW5nbGVEZWcgPSBNYXRoLmF0YW4yKHN1bURZcCwgc3VtRFhwKSAqIDE4MC9NYXRoLlBJO1xuXG4gICAgICAgIGNvbnN0IHR4ID0geChYYykgKyBueCAqIG9mZkFsb25nICogc2lnbjtcbiAgICAgICAgY29uc3QgdHkgPSB5U2NhbGUoWWMpICsgbnkgKiBvZmZBbG9uZyAqIHNpZ247XG4gICAgICAgIGhpZ2hsaWdodC5hcHBlbmQoXCJ0ZXh0XCIpXG4gICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLFwibGFiZWwtZGltXCIpXG4gICAgICAgICAgLmF0dHIoXCJmaWxsXCIsIGNvbG9yKVxuICAgICAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIixcIm1pZGRsZVwiKVxuICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoJHt0eH0sJHt0eX0pIHJvdGF0ZSgke2FuZ2xlRGVnfSlgKVxuICAgICAgICAgIC50ZXh0KGBBbG9uZyBjaG9yZDogJHtmbXRTdWIoTF9hbG9uZywgdW5pdHNNb2RlKX1gKTtcblxuICAgICAgICBjb25zdCB0eDIgPSB4KFhjKSArIG54ICogb2ZmTm9kZSAqIHNpZ247XG4gICAgICAgIGNvbnN0IHR5MiA9IHlTY2FsZShZYykgKyBueSAqIG9mZk5vZGUgKiBzaWduO1xuICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIixcImxhYmVsLWRpbVwiKVxuICAgICAgICAgIC5hdHRyKFwiZmlsbFwiLCBjb2xvcilcbiAgICAgICAgICAuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBgdHJhbnNsYXRlKCR7dHgyfSwke3R5Mn0pIHJvdGF0ZSgke2FuZ2xlRGVnfSlgKVxuICAgICAgICAgIC50ZXh0KGBOb2RlICR7aU5vZGV9IHRyaWJ1dGFyeWApO1xuXG4gICAgICAgIC8vIEhvcml6b250YWwgcHJvamVjdGlvblxuICAgICAgICBjb25zdCBuID0gdG9wTm9kZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCB4SCA9IHRvcE5vZGVzW2lOb2RlXS54aDtcbiAgICAgICAgY29uc3QgeEwgPSAoaU5vZGUgPT09IDApICAgICA/IHhIIDogKHhIICsgdG9wTm9kZXNbaU5vZGUtMV0ueGgpLzI7XG4gICAgICAgIGNvbnN0IHhSID0gKGlOb2RlID09PSBuLTEpICAgPyB4SCA6ICh4SCArIHRvcE5vZGVzW2lOb2RlKzFdLnhoKS8yO1xuXG4gICAgICAgIGNvbnN0IEx4X20gPSBNYXRoLmFicyh4UiAtIHhMKTtcbiAgICAgICAgY29uc3QgeExlZnRfbSAgPSBNYXRoLm1pbih4TCwgeFIpO1xuICAgICAgICBjb25zdCB4UmlnaHRfbSA9IE1hdGgubWF4KHhMLCB4Uik7XG4gICAgICAgIGNvbnN0IHgxcCA9IHgoeExlZnRfbSksIHgycCA9IHgoeFJpZ2h0X20pO1xuICAgICAgICBjb25zdCB5RCA9IGJhc2VZICsgOTU7XG5cbiAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcImxpbmVcIikuYXR0cihcImNsYXNzXCIsXCJ0cmlidS1kaW1cIikuYXR0cihcInN0cm9rZVwiLCBjb2xvcilcbiAgICAgICAgICAuYXR0cihcIngxXCIsIHgxcCkuYXR0cihcInkxXCIsIHlEKS5hdHRyKFwieDJcIiwgeDJwKS5hdHRyKFwieTJcIiwgeUQpO1xuICAgICAgICBbeDFwLHgycF0uZm9yRWFjaCh4eD0+e1xuICAgICAgICAgIGhpZ2hsaWdodC5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJjbGFzc1wiLFwidHJpYnUtZGltXCIpLmF0dHIoXCJzdHJva2VcIiwgY29sb3IpXG4gICAgICAgICAgICAuYXR0cihcIngxXCIsIHh4KS5hdHRyKFwieTFcIiwgYmFzZVkpLmF0dHIoXCJ4MlwiLCB4eCkuYXR0cihcInkyXCIsIHlEKTtcbiAgICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwiY2xhc3NcIixcInRyaWJ1LWRpbVwiKS5hdHRyKFwic3Ryb2tlXCIsIGNvbG9yKVxuICAgICAgICAgICAgLmF0dHIoXCJ4MVwiLCB4eCkuYXR0cihcInkxXCIsIHlELTYpLmF0dHIoXCJ4MlwiLCB4eCkuYXR0cihcInkyXCIsIHlEKzYpO1xuICAgICAgICB9KTtcbiAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcInRleHRcIikuYXR0cihcImNsYXNzXCIsXCJsYWJlbC1kaW1cIikuYXR0cihcImZpbGxcIiwgY29sb3IpXG4gICAgICAgICAgLmF0dHIoXCJ4XCIsICh4MXAreDJwKS8yKS5hdHRyKFwieVwiLCB5RCArIDE2KS5hdHRyKFwidGV4dC1hbmNob3JcIixcIm1pZGRsZVwiKVxuICAgICAgICAgIC50ZXh0KGBIb3Jpem9udGFsOiAke2ZtdFN1YihMeF9tLCB1bml0c01vZGUpfWApO1xuXG4gICAgICAgIGNvbnN0IGxlZnRJbiAgPSAoeExlZnRfbSAgLyBJTikudG9GaXhlZCgyKTtcbiAgICAgICAgY29uc3QgcmlnaHRJbiA9ICh4UmlnaHRfbSAvIElOKS50b0ZpeGVkKDIpO1xuICAgICAgICBoaWdobGlnaHQuYXBwZW5kKFwidGV4dFwiKS5hdHRyKFwiY2xhc3NcIixcImxhYmVsLWRpbVwiKS5hdHRyKFwiZmlsbFwiLCBjb2xvcilcbiAgICAgICAgICAuYXR0cihcInhcIiwgeDFwKS5hdHRyKFwieVwiLCB5RCArIDMyKS5hdHRyKFwidGV4dC1hbmNob3JcIixcIm1pZGRsZVwiKVxuICAgICAgICAgIC50ZXh0KGAke2xlZnRJbn0gaW5gKTtcbiAgICAgICAgaGlnaGxpZ2h0LmFwcGVuZChcInRleHRcIikuYXR0cihcImNsYXNzXCIsXCJsYWJlbC1kaW1cIikuYXR0cihcImZpbGxcIiwgY29sb3IpXG4gICAgICAgICAgLmF0dHIoXCJ4XCIsIHgycCkuYXR0cihcInlcIiwgeUQgKyAzMikuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgICAgICAudGV4dChgJHtyaWdodElufSBpbmApO1xuICAgICAgfVxuXG4gICAgICAvLyBIb3ZlciBjaXJjbGVzIChpbmNsdWRlcyBlbmQgbm9kZXMpXG4gICAgICBjb25zdCB0b3BKb2luU29ydGVkID0gQXJyYXkuZnJvbSh0b3BKb2luSWR4KS5zb3J0KChhLGIpPT5hLWIpO1xuICAgICAgdG9wSm9pblNvcnRlZC5mb3JFYWNoKChpZHgpID0+IHtcbiAgICAgICAgY29uc3QgbmQgPSB0b3BOb2Rlc1tpZHhdO1xuICAgICAgICBjb25zdCBweCA9IHgobmQueGgpLCBweSA9IHlTY2FsZShuZC55aCk7XG4gICAgICAgIG5vZGVzRy5hcHBlbmQoXCJjaXJjbGVcIikuYXR0cihcImNsYXNzXCIsXCJub2RlLXJpbmdcIikuYXR0cihcImN4XCIsIHB4KS5hdHRyKFwiY3lcIiwgcHkpLmF0dHIoXCJyXCIsIDUpO1xuICAgICAgICBub2Rlc0cuYXBwZW5kKFwiY2lyY2xlXCIpLmF0dHIoXCJjbGFzc1wiLFwibm9kZS1oaXRcIikuYXR0cihcImN4XCIsIHB4KS5hdHRyKFwiY3lcIiwgcHkpLmF0dHIoXCJyXCIsIDE0KVxuICAgICAgICAgIC5vbihcIm1vdXNlZW50ZXJcIiwgZnVuY3Rpb24oKXsgZDMuc2VsZWN0KHRoaXMucHJldmlvdXNTaWJsaW5nKS5jbGFzc2VkKFwiaG90XCIsIHRydWUpOyBzaG93VHJpYnV0YXJ5KGlkeCk7IH0pXG4gICAgICAgICAgLm9uKFwibW91c2VsZWF2ZVwiLCBmdW5jdGlvbigpeyBkMy5zZWxlY3QodGhpcy5wcmV2aW91c1NpYmxpbmcpLmNsYXNzZWQoXCJob3RcIiwgZmFsc2UpOyBoaWdobGlnaHQuc2VsZWN0QWxsKFwiKlwiKS5yZW1vdmUoKTsgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBJbml0aWFsIHJlbmRlciAmIGNvbnRyb2wgd2lyaW5nXG4gIGZ1bmN0aW9uIHJlcmVuZGVyKCkge1xuICAgIHJlbmRlcihzZWxlY3RUcnVzcy5wcm9wZXJ0eShcInZhbHVlXCIpLCBzZWxlY3RVbml0cy5wcm9wZXJ0eShcInZhbHVlXCIpKTtcbiAgfVxuICByZXJlbmRlcigpO1xuICBzZWxlY3RUcnVzcy5vbihcImNoYW5nZVwiLCByZXJlbmRlcik7XG4gIHNlbGVjdFVuaXRzLm9uKFwiY2hhbmdlXCIsIHJlcmVuZGVyKTtcblxuICAvLyBSZXR1cm4gRE9NIG5vZGUgc28gUXVhcnRvIHJlbmRlcnMgdGhlIFVJICsgU1ZHXG4gIHJldHVybiBjb250YWluZXIubm9kZSgpOyAgIC8vIDwtLSBub3QgJ3N2ZycsIG5vdCAnc3ZnOydcbn1cbiJ9LHsibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMyIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6IntcbiAgLy8gPT09IFRocmVlLVRydXNzIFJvb2Y6IFRyaWJ1dGFyeSBBcmVhcyAmIERlYWQtTG9hZCBFeHByZXNzaW9ucyAoaXNvbWV0cmljLCBjb2xpbmVhciBleHRlbnNpb25zKSA9PT1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBCYXNpYyBnZW9tZXRyeVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdCBzcGFuX2luID0gNDAgKiAxMjsgICAgICAgICAgIC8vIDQwIGZ0IHNwYW4gKGluKVxuICBjb25zdCBoYWxmX2luID0gc3Bhbl9pbiAvIDI7XG4gIGNvbnN0IHJpc2VfaW4gPSAoNi8xMikgKiBoYWxmX2luOyAgLy8gNjoxMiBwaXRjaCAtPiAxMjAgaW5cblxuICBjb25zdCBMX3VuaXRzID0gOTAwOyAgICAgICAgICAgICAgIC8vIGRpc3BsYXllZCByaWRnZSBydW4gKHN5bWJvbGljIEwpXG4gIGNvbnN0IERfdW5pdHMgPSBMX3VuaXRzIC8gMjsgICAgICAgLy8gdHJ1c3Mgc3BhY2luZyBcIkwvMlwiIChkaXNwbGF5IG9ubHkpXG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gSXNvbWV0cmljIHByb2plY3Rpb25cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY29uc3QgZGVnID0gZCA9PiBkICogTWF0aC5QSSAvIDE4MDtcbiAgY29uc3QgcGhpWCA9IGRlZygzMCksIHBoaVkgPSBkZWcoMTUwKSwgcGhpWiA9IGRlZyg5MCk7XG4gIGNvbnN0IHV4ID0geyB4OiBNYXRoLmNvcyhwaGlYKSwgeTogTWF0aC5zaW4ocGhpWCkgfTsgICAvLyBzcGFuICh4KVxuICBjb25zdCB1eSA9IHsgeDogTWF0aC5jb3MocGhpWSksIHk6IE1hdGguc2luKHBoaVkpIH07ICAgLy8gcmlkZ2UgKHkpXG4gIGNvbnN0IHV6ID0geyB4OiBNYXRoLmNvcyhwaGlaKSwgeTogTWF0aC5zaW4ocGhpWikgfTsgICAvLyB2ZXJ0aWNhbCAoeilcblxuICBjb25zdCBXID0gMTUwMCwgSCA9IDg0MDtcbiAgY29uc3QgbWFyZ2luID0ge3RvcDogMjQsIHJpZ2h0OiA1NiwgYm90dG9tOiAyNCwgbGVmdDogNzJ9O1xuICBjb25zdCBpbm5lclcgPSBXIC0gbWFyZ2luLmxlZnQgLSBtYXJnaW4ucmlnaHQ7XG4gIGNvbnN0IGlubmVySCA9IEggLSBtYXJnaW4udG9wIC0gbWFyZ2luLmJvdHRvbTtcblxuICBjb25zdCBjb250YWluZXIgPSBkMy5jcmVhdGUoXCJkaXZcIikuYXR0cihcImNsYXNzXCIsIFwidml6LXdyYXBcIik7XG4gIGNvbnRhaW5lci5hcHBlbmQoXCJoM1wiKS50ZXh0KFwiVGhyZWUtVHJ1c3MgUm9vZjogRGVhZC1Mb2FkIFRyaWJ1dGFyeSBBcmVhcyAoaXNvbWV0cmljKVwiKTtcbiAgY29udGFpbmVyLmFwcGVuZChcImRpdlwiKVxuICAgIC5zdHlsZShcIm1hcmdpblwiLFwiMnB4IDAgMTBweCAwXCIpLnN0eWxlKFwiY29sb3JcIixcIiM0YjU1NjNcIikuc3R5bGUoXCJmb250LXNpemVcIixcIjE0cHhcIilcbiAgICAuaHRtbChcIjQwLWZ0IGRvdWJsZSBIb3dlIHRydXNzZXMgQCA8Yj42LzEyPC9iPiBwaXRjaC4gUmlkZ2UgbGVuZ3RoIHNob3duIGFzIDxiPkw8L2I+OyB0cnVzcyBzcGFjaW5nIGlzIDxiPkwvMjwvYj4gKGRlcHRoIGV4YWdnZXJhdGVkKS5cIik7XG5cbiAgY29uc3Qgc3ZnID0gY29udGFpbmVyLmFwcGVuZChcInN2Z1wiKS5hdHRyKFwidmlld0JveFwiLCBbMCwwLFcsSF0uam9pbihcIiBcIikpO1xuICBjb25zdCBnICAgPSBzdmcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUoJHttYXJnaW4ubGVmdH0sJHttYXJnaW4udG9wfSlgKTtcblxuICAvLyBzY2FsZSBmYWN0b3JzOiBrZWVwIHo9PXggZm9yIHBpdGNoIGZpZGVsaXR5OyB3aWRlbiByaWRnZSBkZXB0aCAxLjV4XG4gIGNvbnN0IGt4ID0gKGlubmVyVyAqIDAuNjIpIC8gc3Bhbl9pbjtcbiAgY29uc3Qga3ogPSBreDtcbiAgY29uc3Qga3kgPSAxLjUgKiAoaW5uZXJXICogMC4yNikgLyBMX3VuaXRzO1xuXG4gIGZ1bmN0aW9uIFAwKHhfaW4sIHlfdSwgel9pbil7XG4gICAgY29uc3QgWCA9IHhfaW4gKiBreCAqIHV4LnggKyB5X3UgKiBreSAqIHV5LnggKyB6X2luICoga3ogKiB1ei54O1xuICAgIGNvbnN0IFltID0geF9pbiAqIGt4ICogdXgueSArIHlfdSAqIGt5ICogdXkueSArIHpfaW4gKiBreiAqIHV6Lnk7IC8vIHVwLXBvc2l0aXZlXG4gICAgcmV0dXJuIFtYLCAtWW1dO1xuICB9XG4gIGNvbnN0IFBYID0gKHgseSx6KT0+IFAwKHgseSx6KVswXTtcbiAgY29uc3QgUFkgPSAoeCx5LHopPT4gUDAoeCx5LHopWzFdO1xuICBjb25zdCBzY3JlZW5QdCA9ICh4LHkseik9PltQWCh4LHkseiksIFBZKHgseSx6KV07XG5cbiAgLy8gaGVscGVyc1xuICBjb25zdCBESU0gPSBcIiNjYmQ1ZTFcIjtcbiAgY29uc3Qgdm5vcm0gPSAoZHgsZHkpPT57IGNvbnN0IEwgPSBNYXRoLmh5cG90KGR4LGR5KXx8MTsgcmV0dXJuIFtkeC9MLCBkeS9MXTsgfTtcbiAgY29uc3QgYWRkVGljayA9IChHLHgseSx2eCx2eSxsZW4pPT57IGNvbnN0IFt1eHgsdXl5XT12bm9ybSh2eCx2eSk7XG4gICAgRy5hcHBlbmQoXCJsaW5lXCIpXG4gICAgICAuYXR0cihcIngxXCIsIHgtdXh4KmxlbikuYXR0cihcInkxXCIsIHktdXl5KmxlbilcbiAgICAgIC5hdHRyKFwieDJcIiwgeCt1eHgqbGVuKS5hdHRyKFwieTJcIiwgeSt1eXkqbGVuKVxuICAgICAgLmF0dHIoXCJzdHJva2VcIiwgRElNKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIDEuMik7XG4gIH07XG4gIGNvbnN0IGJjRGlyTGVmdCA9ICh5KT0+eyBjb25zdCBBPXNjcmVlblB0KDAseSwwKSwgQj1zY3JlZW5QdCgtMTAseSwwKTsgcmV0dXJuIHZub3JtKEJbMF0tQVswXSwgQlsxXS1BWzFdKTsgfTtcblxuICAvLyByb2J1c3QgMkQgbGluZSBpbnRlcnNlY3Rpb246IFAgKyB0KnYgd2l0aCBRICsgcyp3XG4gIGZ1bmN0aW9uIGludGVyc2VjdFBvaW50KFAsIHYsIFEsIHcpe1xuICAgIGNvbnN0IGRldCA9IHZbMF0qd1sxXSAtIHZbMV0qd1swXTtcbiAgICBpZiAoTWF0aC5hYnMoZGV0KSA8IDFlLTkpIHJldHVybiBudWxsO1xuICAgIGNvbnN0IGRYID0gUVswXS1QWzBdLCBkWSA9IFFbMV0tUFsxXTtcbiAgICBjb25zdCB0ID0gKGRYKndbMV0gLSBkWSp3WzBdKSAvIGRldDtcbiAgICByZXR1cm4gW1BbMF0gKyB0KnZbMF0sIFBbMV0gKyB0KnZbMV1dO1xuICB9XG5cbiAgLy8gcm9vZiBmYWNlcyBmb3IgYmJveCBhbmQgZHJhd2luZ1xuICBmdW5jdGlvbiBzdHJpcFBvbHlSYXcoc2lkZSwgeTAsIHkxKXtcbiAgICBpZihzaWRlPT09XCJsZWZ0XCIpe1xuICAgICAgcmV0dXJuIFsgUDAoMCx5MCwwKSwgUDAoaGFsZl9pbix5MCxyaXNlX2luKSwgUDAoaGFsZl9pbix5MSxyaXNlX2luKSwgUDAoMCx5MSwwKSBdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWyBQMChoYWxmX2luLHkwLHJpc2VfaW4pLCBQMChzcGFuX2luLHkwLDApLCBQMChzcGFuX2luLHkxLDApLCBQMChoYWxmX2luLHkxLHJpc2VfaW4pIF07XG4gICAgfVxuICB9XG5cbiAgLy8gYXV0by1maXQgdHJhbnNsYXRpb25cbiAgY29uc3QgYWxsID0gWyAuLi5zdHJpcFBvbHlSYXcoXCJsZWZ0XCIsMCwyKkRfdW5pdHMpLCAuLi5zdHJpcFBvbHlSYXcoXCJyaWdodFwiLDAsMipEX3VuaXRzKSBdO1xuICBsZXQgbWluWD1JbmZpbml0eSxtYXhYPS1JbmZpbml0eSxtaW5ZPUluZmluaXR5LG1heFk9LUluZmluaXR5O1xuICBhbGwuZm9yRWFjaCgoW1gsWV0pPT57bWluWD1NYXRoLm1pbihtaW5YLFgpO21heFg9TWF0aC5tYXgobWF4WCxYKTttaW5ZPU1hdGgubWluKG1pblksWSk7bWF4WT1NYXRoLm1heChtYXhZLFkpO30pO1xuICBjb25zdCB0eCA9IChpbm5lclcgLSAobWF4WC1taW5YKSkvMiAtIG1pblg7XG4gIGNvbnN0IHR5ID0gKGlubmVySCAtIChtYXhZLW1pblkpKS8yIC0gbWluWTtcbiAgY29uc3Qgc1BYID0gKHgseSx6KT0+IFBYKHgseSx6KSt0eDtcbiAgY29uc3Qgc1BZID0gKHgseSx6KT0+IFBZKHgseSx6KSt0eTtcbiAgY29uc3Qgc1B0ID0gKHgseSx6KT0+IFtzUFgoeCx5LHopLCBzUFkoeCx5LHopXTtcblxuICAvLyB0b3AgY2hvcmQgbm9kZXMgKGRvdWJsZSBIb3dlKVxuICBjb25zdCBuUGFuZWxzID0gNiwgcGFuZWxfaW4gPSBzcGFuX2luIC8gblBhbmVscztcbiAgY29uc3QgdG9wTm9kZXMgPSBkMy5yYW5nZShuUGFuZWxzICsgMSkubWFwKGkgPT4ge1xuICAgIGNvbnN0IHggPSBpICogcGFuZWxfaW47XG4gICAgY29uc3QgdCA9IHggPD0gaGFsZl9pbiA/ICh4L2hhbGZfaW4pIDogKChzcGFuX2luLXgpL2hhbGZfaW4pO1xuICAgIHJldHVybiB7aSwgeF9pbjogeCwgel9pbjogcmlzZV9pbiAqIHR9O1xuICB9KTtcbiAgY29uc3QgYm90dG9tWiA9IDA7XG5cbiAgLy8gd2VicyArIHRydXNzXG4gIGZ1bmN0aW9uIGRyYXdIb3dlV2VicyhnciwgeSwgc3Ryb2tlLCBzdyl7XG4gICAgY29uc3QgbWlkID0gblBhbmVscy8yO1xuICAgIFsxLDIsbWlkLDQsNV0uZm9yRWFjaChpPT57XG4gICAgICBjb25zdCBBID0gdG9wTm9kZXNbaV07XG4gICAgICBnci5hcHBlbmQoXCJsaW5lXCIpXG4gICAgICAgIC5hdHRyKFwieDFcIixzUFgoQS54X2luLHksQS56X2luKSkuYXR0cihcInkxXCIsc1BZKEEueF9pbix5LEEuel9pbikpXG4gICAgICAgIC5hdHRyKFwieDJcIixzUFgoQS54X2luLHksYm90dG9tWikpLmF0dHIoXCJ5MlwiLHNQWShBLnhfaW4seSxib3R0b21aKSlcbiAgICAgICAgLmF0dHIoXCJzdHJva2VcIiwgc3Ryb2tlKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIHN3KTtcbiAgICB9KTtcbiAgICBbWzEsMl0sWzIsbWlkXV0uZm9yRWFjaCgoW2lhLGliXSk9PntcbiAgICAgIGNvbnN0IEE9dG9wTm9kZXNbaWFdLCBCPXRvcE5vZGVzW2liXTtcbiAgICAgIGdyLmFwcGVuZChcImxpbmVcIilcbiAgICAgICAgLmF0dHIoXCJ4MVwiLHNQWChBLnhfaW4seSxBLnpfaW4pKS5hdHRyKFwieTFcIixzUFkoQS54X2luLHksQS56X2luKSlcbiAgICAgICAgLmF0dHIoXCJ4MlwiLHNQWChCLnhfaW4seSxib3R0b21aKSkuYXR0cihcInkyXCIsc1BZKEIueF9pbix5LGJvdHRvbVopKVxuICAgICAgICAuYXR0cihcInN0cm9rZVwiLCBzdHJva2UpLmF0dHIoXCJzdHJva2Utd2lkdGhcIiwgc3cpO1xuICAgIH0pO1xuICAgIFtbNSw0XSxbNCxtaWRdXS5mb3JFYWNoKChbaWEsaWJdKT0+e1xuICAgICAgY29uc3QgQT10b3BOb2Rlc1tpYV0sIEI9dG9wTm9kZXNbaWJdO1xuICAgICAgZ3IuYXBwZW5kKFwibGluZVwiKVxuICAgICAgICAuYXR0cihcIngxXCIsc1BYKEEueF9pbix5LEEuel9pbikpLmF0dHIoXCJ5MVwiLHNQWShBLnhfaW4seSxBLnpfaW4pKVxuICAgICAgICAuYXR0cihcIngyXCIsc1BYKEIueF9pbix5LGJvdHRvbVopKS5hdHRyKFwieTJcIixzUFkoQi54X2luLHksYm90dG9tWikpXG4gICAgICAgIC5hdHRyKFwic3Ryb2tlXCIsIHN0cm9rZSkuYXR0cihcInN0cm9rZS13aWR0aFwiLCBzdyk7XG4gICAgfSk7XG4gIH1cbiAgZnVuY3Rpb24gZHJhd0hvd2VUcnVzcyh5LCByb290LCB7c3Ryb2tlPVwiIzkzYzVmZFwiLCBzdHJva2VXaWR0aD0yLjIsIGNsYXNzTmFtZT1cInRydXNzXCJ9PXt9KXtcbiAgICBjb25zdCBnciA9IHJvb3QuYXBwZW5kKFwiZ1wiKS5hdHRyKFwiY2xhc3NcIiwgY2xhc3NOYW1lKS5zdHlsZShcInBvaW50ZXItZXZlbnRzXCIsXCJub25lXCIpO1xuICAgIGdyLmFwcGVuZChcImxpbmVcIilcbiAgICAgIC5hdHRyKFwieDFcIixzUFgoMCx5LGJvdHRvbVopKS5hdHRyKFwieTFcIixzUFkoMCx5LGJvdHRvbVopKVxuICAgICAgLmF0dHIoXCJ4MlwiLHNQWChzcGFuX2luLHksYm90dG9tWikpLmF0dHIoXCJ5MlwiLHNQWShzcGFuX2luLHksYm90dG9tWikpXG4gICAgICAuYXR0cihcInN0cm9rZVwiLCBzdHJva2UpLmF0dHIoXCJzdHJva2Utd2lkdGhcIiwgc3Ryb2tlV2lkdGgpO1xuICAgIGdyLmFwcGVuZChcInBhdGhcIilcbiAgICAgIC5hdHRyKFwiZFwiLCBkMy5saW5lKCkueChkPT5zUFgoZC54X2luLHksZC56X2luKSkueShkPT5zUFkoZC54X2luLHksZC56X2luKSkodG9wTm9kZXMpKVxuICAgICAgLmF0dHIoXCJmaWxsXCIsXCJub25lXCIpLmF0dHIoXCJzdHJva2VcIiwgc3Ryb2tlKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIHN0cm9rZVdpZHRoKTtcbiAgICBkcmF3SG93ZVdlYnMoZ3IsIHksIHN0cm9rZSwgMS42KTtcbiAgICByZXR1cm4gZ3I7XG4gIH1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBTY2VuZVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdCB5VHJ1c3MgPSBbMCwgRF91bml0cywgMipEX3VuaXRzXTtcbiAgY29uc3QgbTAgPSBEX3VuaXRzLzIsIG0xID0gRF91bml0cyArIERfdW5pdHMvMjtcbiAgY29uc3QgeVpvbmVzID0gW1swLG0wXSxbbTAsbTFdLFttMSwyKkRfdW5pdHNdXTtcblxuICAvLyByb29mXG4gIGNvbnN0IHJvb2ZHID0gZy5hcHBlbmQoXCJnXCIpO1xuICBbXCJsZWZ0XCIsXCJyaWdodFwiXS5mb3JFYWNoKHNpZGU9PntcbiAgICBjb25zdCBwb2x5ID0gKHNpZGU9PT1cImxlZnRcIj8gc3RyaXBQb2x5UmF3KFwibGVmdFwiLDAsMipEX3VuaXRzKSA6IHN0cmlwUG9seVJhdyhcInJpZ2h0XCIsMCwyKkRfdW5pdHMpKVxuICAgICAgLm1hcCgoW1gsWV0pPT5bWCt0eCwgWSt0eV0pO1xuICAgIHJvb2ZHLmFwcGVuZChcInBhdGhcIilcbiAgICAgIC5hdHRyKFwiZFwiLCBkMy5saW5lKCkuY3VydmUoZDMuY3VydmVMaW5lYXJDbG9zZWQpKHBvbHkpKVxuICAgICAgLmF0dHIoXCJmaWxsXCIsXCIjOWNhM2FmXCIpLmF0dHIoXCJmaWxsLW9wYWNpdHlcIiwwLjEyKVxuICAgICAgLmF0dHIoXCJzdHJva2VcIixcIiM5Y2EzYWZcIikuYXR0cihcInN0cm9rZS1vcGFjaXR5XCIsMC4zMCkuYXR0cihcInN0cm9rZS13aWR0aFwiLDEpO1xuICB9KTtcblxuICAvLyB0cnVzc2VzIChtaWRkbGUgb3JhbmdleSwgYmFjayBkYXJrZXIgZ3JlZW4pXG4gIGNvbnN0IHRydXNzRyA9IGcuYXBwZW5kKFwiZ1wiKTtcbiAgY29uc3QgcGFzdGVsID0gW1wiIzkzYzVmZFwiLCBcIiNmNTllMGJcIiwgXCIjMzRkMzk5XCJdOyAvLyBiYWNrIGRhcmtlclxuICBjb25zdCB2aXZpZCAgPSBbXCIjMjU2M2ViXCIsIFwiI2Q5NzcwNlwiLCBcIiMwNTk2NjlcIl07IC8vIGhvdmVyIGNvbG9yc1xuICB5VHJ1c3MuZm9yRWFjaCgoeSxpKT0+IGRyYXdIb3dlVHJ1c3MoeSwgdHJ1c3NHLCB7IHN0cm9rZTogcGFzdGVsW2ldLCBzdHJva2VXaWR0aDogMi4yLCBjbGFzc05hbWU6YHRydXNzIHRydXNzLSR7aX1gIH0pKTtcblxuICAvLyBob3ZlciBzY2FmZm9sZGluZ1xuICBjb25zdCBoaXRHID0gZy5hcHBlbmQoXCJnXCIpLnN0eWxlKFwicG9pbnRlci1ldmVudHNcIixcIm5vbmVcIik7XG4gIGNvbnN0IHNlZ0hpdHMgPSBoaXRHLmFwcGVuZChcImdcIikuc3R5bGUoXCJwb2ludGVyLWV2ZW50c1wiLFwiYWxsXCIpO1xuICBjb25zdCBIVUQgPSBnLmFwcGVuZChcImdcIikuc3R5bGUoXCJwb2ludGVyLWV2ZW50c1wiLFwibm9uZVwiKTtcbiAgY29uc3QgaGlBcmVhcyA9IEhVRC5hcHBlbmQoXCJnXCIpO1xuICBjb25zdCBoaVRydXNzID0gSFVELmFwcGVuZChcImdcIik7XG4gIGNvbnN0IGR5bkRpbXMgPSBnLmFwcGVuZChcImdcIikuYXR0cihcImNsYXNzXCIsXCJkeW4tZGltc1wiKS5zdHlsZShcInBvaW50ZXItZXZlbnRzXCIsXCJub25lXCIpO1xuXG4gIGZ1bmN0aW9uIHN0cmlwUG9seShzaWRlLHkwLHkxKXsgcmV0dXJuIHN0cmlwUG9seVJhdyhzaWRlLHkwLHkxKS5tYXAoKFtYLFldKT0+W1grdHgsIFkrdHldKTsgfVxuICBjb25zdCBzZWdtZW50cyA9IFtdO1xuICBbXCJsZWZ0XCIsXCJyaWdodFwiXS5mb3JFYWNoKHNpZGU9PiB5Wm9uZXMuZm9yRWFjaCgoeXIsaWR4KT0+c2VnbWVudHMucHVzaCh7c2lkZSx0cnVzczppZHgseTA6eXJbMF0seTE6eXJbMV19KSkpO1xuICBzZWdIaXRzLnNlbGVjdEFsbChcInBhdGguc2VnSGl0XCIpXG4gICAgLmRhdGEoc2VnbWVudHMpLmVudGVyKCkuYXBwZW5kKFwicGF0aFwiKVxuICAgICAgLmF0dHIoXCJjbGFzc1wiLFwic2VnSGl0XCIpXG4gICAgICAuYXR0cihcImRcIiwgZD0+IGQzLmxpbmUoKS5jdXJ2ZShkMy5jdXJ2ZUxpbmVhckNsb3NlZCkoc3RyaXBQb2x5KGQuc2lkZSxkLnkwLGQueTEpKSlcbiAgICAgIC5hdHRyKFwiZmlsbFwiLFwiI2ZmZlwiKS5hdHRyKFwiZmlsbC1vcGFjaXR5XCIsMC4wMDEpXG4gICAgICAuYXR0cihcInN0cm9rZVwiLFwibm9uZVwiKS5zdHlsZShcImN1cnNvclwiLFwicG9pbnRlclwiKVxuICAgICAgLm9uKFwibW91c2VlbnRlclwiLChfLGQpPT5zZXRBY3RpdmUoZC50cnVzcykpXG4gICAgICAub24oXCJtb3VzZW1vdmVcIiwgKF8sZCk9PnNldEFjdGl2ZShkLnRydXNzKSlcbiAgICAgIC5vbihcIm1vdXNlbGVhdmVcIiwgY2xlYXJBY3RpdmUpO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIE1hdGggcGFuZWwgKE0gaW5wdXQgKyBkeW5hbWljIHRleHQpXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGNvbnN0IFRfaW4gPSBNYXRoLmh5cG90KGhhbGZfaW4sIHJpc2VfaW4pO1xuICBjb25zdCBUX2Z0ID0gVF9pbiAvIDEyO1xuXG4gIGNvbnN0IG1hdGhXcmFwID0gY29udGFpbmVyLmFwcGVuZChcImRpdlwiKS5hdHRyKFwiY2xhc3NcIixcIm1hdGgtd3JhcFwiKVxuICAgIC5zdHlsZShcIm1hcmdpblwiLFwiMTRweCAwIDAgMFwiKTtcblxuICBjb25zdCBnZW4gPSBtYXRoV3JhcC5hcHBlbmQoXCJkaXZcIilcbiAgICAuc3R5bGUoXCJwYWRkaW5nXCIsXCIxMnB4IDE0cHhcIikuc3R5bGUoXCJiYWNrZ3JvdW5kXCIsXCIjZjlmYWZiXCIpXG4gICAgLnN0eWxlKFwiYm9yZGVyXCIsXCIxcHggc29saWQgI2U1ZTdlYlwiKS5zdHlsZShcImJvcmRlci1yYWRpdXNcIixcIjZweFwiKVxuICAgIC5zdHlsZShcImZvbnQtZmFtaWx5XCIsXCJ1aS1tb25vc3BhY2UsIFNGTW9uby1SZWd1bGFyLCBNZW5sbywgTW9uYWNvLCBDb25zb2xhcywgJ0xpYmVyYXRpb24gTW9ubycsICdDb3VyaWVyIE5ldycsIG1vbm9zcGFjZVwiKVxuICAgIC5zdHlsZShcImZvbnQtc2l6ZVwiLFwiMTRweFwiKS5zdHlsZShcImxpbmUtaGVpZ2h0XCIsXCIxLjVcIik7XG5cbiAgZ2VuLmFwcGVuZChcImRpdlwiKS5zdHlsZShcImNvbG9yXCIsXCIjMTExODI3XCIpLnN0eWxlKFwibWFyZ2luLWJvdHRvbVwiLFwiNnB4XCIpXG4gICAgLmh0bWwoXCI8Yj5DYWxjdWxhdGluZyBhIHRydXNz4oCZcyBkZWFkIGxvYWQ8L2I+XCIpO1xuXG4gIGxldCBNVmFsID0gMS4wO1xuICBjb25zdCBjdHJsID0gZ2VuLmFwcGVuZChcImRpdlwiKS5zdHlsZShcIm1hcmdpblwiLFwiNHB4IDAgMTBweCAwXCIpLnN0eWxlKFwiY29sb3JcIixcIiMzNzQxNTFcIik7XG4gIGN0cmwuYXBwZW5kKFwic3BhblwiKS50ZXh0KFwiTSAod2VpZ2h0IHBlciB1bml0IGFyZWEpOiBcIik7XG4gIGNvbnN0IG1JbnB1dCA9IGN0cmwuYXBwZW5kKFwiaW5wdXRcIikuYXR0cihcInR5cGVcIixcIm51bWJlclwiKS5hdHRyKFwic3RlcFwiLFwiMC4xXCIpLmF0dHIoXCJ2YWx1ZVwiLFwiMS4wXCIpXG4gICAgLnN0eWxlKFwid2lkdGhcIixcIjkwcHhcIikuc3R5bGUoXCJtYXJnaW4tbGVmdFwiLFwiNnB4XCIpO1xuICBjdHJsLmFwcGVuZChcInNwYW5cIikuc3R5bGUoXCJtYXJnaW4tbGVmdFwiLFwiNnB4XCIpLnN0eWxlKFwiY29sb3JcIixcIiM2YjcyODBcIikudGV4dChcIih1bml0cy9hcmVhKVwiKTtcblxuICBnZW4uYXBwZW5kKFwiZGl2XCIpLnRleHQoXCJMZXQgTCA9IHJpZGdlIGxlbmd0aCwgVCA9IHRvcC1jaG9yZCB0cnVlIGxlbmd0aCwgTSA9IHJvb2Ygd2VpZ2h0IHBlciB1bml0IGFyZWEuXCIpO1xuICBnZW4uYXBwZW5kKFwiZGl2XCIpLnRleHQoXCJGb3IgYSB0cnVzcyB3aXRoIHRyaWJ1dGFyeSByaWRnZSBsZW5ndGggYjpcIik7XG4gIGdlbi5hcHBlbmQoXCJkaXZcIikudGV4dChcIiAg4oCiIFRvdGFsIHRydXNzIGxvYWQ6ICAgVyA9ICgyIMK3IFQgwrcgYikgwrcgTVwiKTtcbiAgZ2VuLmFwcGVuZChcImRpdlwiKS50ZXh0KFwiICDigKIgTGluZSBsb2FkIG9uIHRydXNzOiB3ID0gVyAvIFQgPSAoMiDCtyBiKSDCtyBNXCIpO1xuICBnZW4uYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwibWFyZ2luLXRvcFwiLFwiNnB4XCIpLnRleHQoXCJIZXJlLCBiID0gTC80IGZvciBhbiBlbmQgdHJ1c3MsIGFuZCBiID0gTC8yIGZvciB0aGUgbWlkZGxlIHRydXNzLlwiKTtcblxuICBjb25zdCBzcGVjID0gbWF0aFdyYXAuYXBwZW5kKFwiZGl2XCIpXG4gICAgLnN0eWxlKFwibWFyZ2luXCIsXCIxMHB4IDAgMCAwXCIpLnN0eWxlKFwicGFkZGluZ1wiLFwiMTJweCAxNHB4XCIpXG4gICAgLnN0eWxlKFwiYmFja2dyb3VuZFwiLFwiI2ZmZmZmZlwiKS5zdHlsZShcImJvcmRlclwiLFwiMXB4IHNvbGlkICNlNWU3ZWJcIikuc3R5bGUoXCJib3JkZXItcmFkaXVzXCIsXCI2cHhcIilcbiAgICAuc3R5bGUoXCJmb250LWZhbWlseVwiLFwidWktbW9ub3NwYWNlLCBTRk1vbm8tUmVndWxhciwgTWVubG8sIE1vbmFjbywgQ29uc29sYXMsICdMaWJlcmF0aW9uIE1vbm8nLCAnQ291cmllciBOZXcnLCBtb25vc3BhY2VcIilcbiAgICAuc3R5bGUoXCJmb250LXNpemVcIixcIjE0cHhcIikuc3R5bGUoXCJsaW5lLWhlaWdodFwiLFwiMS41XCIpO1xuXG4gIGNvbnN0IHNwZWNUaXRsZSA9IHNwZWMuYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwibWFyZ2luLWJvdHRvbVwiLFwiNnB4XCIpLnN0eWxlKFwiY29sb3JcIixcIiMxMTE4MjdcIilcbiAgICAuaHRtbChcIjxiPkhvdmVyIG92ZXIgYSByb29mIGJheSB0byBzZWUgc3BlY2lmaWMgZXhwcmVzc2lvbnM8L2I+XCIpO1xuICBjb25zdCBzcGVjTGluZXMgPSBzcGVjLmFwcGVuZChcImRpdlwiKTtcbiAgbGV0IGN1cnJlbnRJZHggPSBudWxsO1xuXG4gIGZ1bmN0aW9uIGNvZWZTdHIodmFsKXsgcmV0dXJuIChNYXRoLnJvdW5kKHZhbCoxMDApLzEwMCkudG9GaXhlZCgyKTsgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZVNwZWNpZmljKGlkeCl7XG4gICAgc3BlY0xpbmVzLnNlbGVjdEFsbChcIipcIikucmVtb3ZlKCk7XG4gICAgaWYoaWR4ID09PSBudWxsIHx8IGlkeCA9PT0gdW5kZWZpbmVkKXtcbiAgICAgIHNwZWNUaXRsZS5odG1sKFwiPGI+SG92ZXIgb3ZlciBhIHJvb2YgYmF5IHRvIHNlZSBzcGVjaWZpYyBleHByZXNzaW9uczwvYj5cIik7XG4gICAgICBzcGVjTGluZXMuYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwiY29sb3JcIixcIiM2YjcyODBcIikudGV4dChcIk5vIGJheSBzZWxlY3RlZC5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGN1cnJlbnRJZHggPSBpZHg7XG4gICAgY29uc3Qgd2hpY2ggPSAoaWR4PT09MSkgPyBcIk1pZGRsZSB0cnVzc1wiIDogKGlkeD09PTAgPyBcIlJpZ2h0L2Zyb250IGVuZCB0cnVzc1wiIDogXCJMZWZ0L2JhY2sgZW5kIHRydXNzXCIpO1xuICAgIGNvbnN0IGJTeW0gPSAoaWR4PT09MSkgPyBcIkwvMlwiIDogXCJMLzRcIjtcbiAgICBjb25zdCB2aXZpZENvbG9yID0gKGlkeD09PTEpID8gXCIjZDk3NzA2XCIgOiAoaWR4PT09MCA/IFwiIzI1NjNlYlwiIDogXCIjMDU5NjY5XCIpO1xuXG4gICAgY29uc3QgY1cgPSAoaWR4PT09MSkgPyAoVF9mdCAqIE1WYWwpIDogKFRfZnQgKiBNVmFsIC8gMik7IC8vIFcgPSBjVyAqIExcbiAgICBjb25zdCBjdyA9IChpZHg9PT0xKSA/ICgxICogTVZhbCkgICA6ICgwLjUgKiBNVmFsKTsgICAgICAgLy8gdyA9IGN3ICogTFxuICAgIHNwZWNUaXRsZS5odG1sKGA8Yj4ke3doaWNofSAodHJpYnV0YXJ5KTwvYj5gKTtcbiAgICBzcGVjTGluZXMuYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwiY29sb3JcIixcIiMzNzQxNTFcIilcbiAgICAgIC50ZXh0KGBHaXZlbiBUIOKJiCAke1RfZnQudG9GaXhlZCgyKX0gZnQgKCR7VF9pbi50b0ZpeGVkKDIpfSBpbikgYW5kIE0gPSAke01WYWwudG9GaXhlZCgyKX06YCk7XG5cbiAgICBzcGVjTGluZXMuYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwiY29sb3JcIiwgdml2aWRDb2xvcilcbiAgICAgIC50ZXh0KGBUb3RhbCBsb2FkOiAgIFcgPSAoMiDCtyBUIMK3ICR7YlN5bX0pIMK3IE0gPSAoMiDCtyAke1RfZnQudG9GaXhlZCgyKX0gwrcgJHtiU3ltfSkgwrcgJHtNVmFsLnRvRml4ZWQoMil9ID0gJHtjb2VmU3RyKGNXKX3Ct0xgKTtcbiAgICBjb25zdCB3RXhwciA9IChpZHg9PT0xKSA/IFwiTCDCtyBNXCIgOiBcIihMLzIpIMK3IE1cIjtcbiAgICBzcGVjTGluZXMuYXBwZW5kKFwiZGl2XCIpLnN0eWxlKFwiY29sb3JcIiwgdml2aWRDb2xvcilcbiAgICAgIC50ZXh0KGBMaW5lIGxvYWQ6ICAgIHcgPSAyIMK3ICR7YlN5bX0gwrcgTSA9ICR7d0V4cHJ9ID0gJHtjb2VmU3RyKGN3KX3Ct0xgKTtcbiAgfVxuICBtSW5wdXQub24oXCJpbnB1dFwiLCBmdW5jdGlvbigpe1xuICAgIGNvbnN0IHYgPSBwYXJzZUZsb2F0KHRoaXMudmFsdWUpO1xuICAgIE1WYWwgPSBOdW1iZXIuaXNGaW5pdGUodikgPyB2IDogMS4wO1xuICAgIHVwZGF0ZVNwZWNpZmljKGN1cnJlbnRJZHgpO1xuICB9KTtcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBTdGF0aWMgZGltZW5zaW9uIHRpZXJzICsgY2hvcmQgdHJ1ZSBsZW5ndGhcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY29uc3QgZGltcyA9IGcuYXBwZW5kKFwiZ1wiKS5hdHRyKFwiY2xhc3NcIixcImRpbXNcIikuc3R5bGUoXCJwb2ludGVyLWV2ZW50c1wiLFwibm9uZVwiKTtcblxuICAvLyBpbm5lciB0aWVyOiBMLzIg4oCUIGV4dGVuc2lvbiBsaW5lcyBhcmUgY29saW5lYXIgd2l0aCB0aGUgYm90dG9tIGNob3JkcyAodW5jaGFuZ2VkKVxuICBjb25zdCBleHRMZW4gPSA1NiwgdGlja0xlbiA9IDc7XG4gIGNvbnN0IGV4dHMgPSB5VHJ1c3MubWFwKHk9PntcbiAgICBjb25zdCBQID0gW3NQWCgwLHksMCksIHNQWSgwLHksMCldO1xuICAgIGNvbnN0IHYgPSBiY0RpckxlZnQoeSk7XG4gICAgY29uc3QgRSA9IFtQWzBdICsgdlswXSpleHRMZW4sIFBbMV0gKyB2WzFdKmV4dExlbl07XG4gICAgZGltcy5hcHBlbmQoXCJsaW5lXCIpLmF0dHIoXCJ4MVwiLFBbMF0pLmF0dHIoXCJ5MVwiLFBbMV0pLmF0dHIoXCJ4MlwiLEVbMF0pLmF0dHIoXCJ5MlwiLEVbMV0pXG4gICAgICAuYXR0cihcInN0cm9rZVwiLCBESU0pLmF0dHIoXCJzdHJva2Utd2lkdGhcIiwxLjEpO1xuICAgIHJldHVybiB7eSwgUCwgRSwgdn07XG4gIH0pO1xuXG4gIC8vIGNvbm5lY3QgTC8yIHNwYW5zXG4gIFtbMCwxXSxbMSwyXV0uZm9yRWFjaCgoW2ksal0pPT57XG4gICAgY29uc3QgQSA9IGV4dHNbaV0uRSwgQiA9IGV4dHNbal0uRTtcbiAgICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsQVswXSkuYXR0cihcInkxXCIsQVsxXSkuYXR0cihcIngyXCIsQlswXSkuYXR0cihcInkyXCIsQlsxXSlcbiAgICAgIC5hdHRyKFwic3Ryb2tlXCIsIERJTSkuYXR0cihcInN0cm9rZS13aWR0aFwiLDEuMSk7XG4gICAgYWRkVGljayhkaW1zLCBBWzBdLEFbMV0sIGV4dHNbaV0udlswXSwgZXh0c1tpXS52WzFdLCB0aWNrTGVuKTtcbiAgICBhZGRUaWNrKGRpbXMsIEJbMF0sQlsxXSwgZXh0c1tqXS52WzBdLCBleHRzW2pdLnZbMV0sIHRpY2tMZW4pO1xuICAgIGNvbnN0IG1pZD1bKEFbMF0rQlswXSkvMiwoQVsxXStCWzFdKS8yXTtcbiAgICBjb25zdCB3PXZub3JtKEJbMF0tQVswXSxCWzFdLUFbMV0pOyBsZXQgbj1bLXdbMV0sd1swXV07XG4gICAgY29uc3QgYmNNaWQ9YmNEaXJMZWZ0KHlUcnVzc1sxXSk7IGlmKG5bMF0qYmNNaWRbMF0rblsxXSpiY01pZFsxXTwwKSBuPVstblswXSwtblsxXV07XG4gICAgZGltcy5hcHBlbmQoXCJ0ZXh0XCIpLmF0dHIoXCJ4XCIsIG1pZFswXStuWzBdKjEyKS5hdHRyKFwieVwiLCBtaWRbMV0rblsxXSoxMilcbiAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIixcIm1pZGRsZVwiKS5hdHRyKFwiZmlsbFwiLFwiIzRiNTU2M1wiKS5zdHlsZShcImZvbnQtc2l6ZVwiLFwiMTJweFwiKS50ZXh0KFwiTC8yXCIpO1xuICB9KTtcblxuICAvLyBvdXRlciB0aWVyOiBMIOKAlCBleHRlbnNpb24gbGluZXMgbXVzdCBiZSBjb2xpbmVhciB3aXRoIGNob3JkcyBhbmQgbWVldCB0aGUgTCBsaW5lXG4gIC8vIGNvbXB1dGUgcmlkZ2UgZGlyZWN0aW9uICsgb3V0d2FyZCBub3JtYWwgZnJvbSBpbm5lciBFIHBvaW50c1xuICBjb25zdCB3UmlkZ2UgPSB2bm9ybShleHRzWzJdLkVbMF0tZXh0c1swXS5FWzBdLCBleHRzWzJdLkVbMV0tZXh0c1swXS5FWzFdKTtcbiAgbGV0IG5PdXQgPSBbLXdSaWRnZVsxXSwgd1JpZGdlWzBdXTtcbiAgY29uc3QgYmNNaWQgPSBiY0RpckxlZnQoeVRydXNzWzFdKTsgaWYobk91dFswXSpiY01pZFswXStuT3V0WzFdKmJjTWlkWzFdPDApIG5PdXQ9Wy1uT3V0WzBdLC1uT3V0WzFdXTtcbiAgY29uc3QgdGllck9mZiA9IDU2O1xuICBjb25zdCBiYXNlT3V0ID0gW2V4dHNbMF0uRVswXSArIG5PdXRbMF0qdGllck9mZiwgZXh0c1swXS5FWzFdICsgbk91dFsxXSp0aWVyT2ZmXTsgLy8gcG9pbnQgb24gdGhlIEwgbGluZVxuXG4gIC8vIGZpbmQgaW50ZXJzZWN0aW9ucyB3aXRoIHRoZSB0d28gZW5kIGV4dGVuc2lvbiBsaW5lcyAoc28gZXh0ZW5zaW9ucyBhcmUgY29saW5lYXIgd2l0aCBjaG9yZHMpXG4gIGNvbnN0IEkwID0gaW50ZXJzZWN0UG9pbnQoZXh0c1swXS5QLCBleHRzWzBdLnYsIGJhc2VPdXQsIHdSaWRnZSk7XG4gIGNvbnN0IEkyID0gaW50ZXJzZWN0UG9pbnQoZXh0c1syXS5QLCBleHRzWzJdLnYsIGJhc2VPdXQsIHdSaWRnZSk7XG5cbiAgLy8gZHJhdyBvdXRlciBleHRlbnNpb24gbGluZXMgYWxvbmcgY2hvcmQgZGlyZWN0aW9ucyB0byB0aGUgTCBsaW5lXG4gIGRpbXMuYXBwZW5kKFwibGluZVwiKS5hdHRyKFwieDFcIiwgZXh0c1swXS5QWzBdKS5hdHRyKFwieTFcIiwgZXh0c1swXS5QWzFdKS5hdHRyKFwieDJcIiwgSTBbMF0pLmF0dHIoXCJ5MlwiLCBJMFsxXSlcbiAgICAuYXR0cihcInN0cm9rZVwiLCBESU0pLmF0dHIoXCJzdHJva2Utd2lkdGhcIiwxLjEpO1xuICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsIGV4dHNbMl0uUFswXSkuYXR0cihcInkxXCIsIGV4dHNbMl0uUFsxXSkuYXR0cihcIngyXCIsIEkyWzBdKS5hdHRyKFwieTJcIiwgSTJbMV0pXG4gICAgLmF0dHIoXCJzdHJva2VcIiwgRElNKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsMS4xKTtcblxuICAvLyB0aGUgTCBkaW1lbnNpb24gbGluZSBhbmQgdGlja3MgYXQgdGhvc2UgaW50ZXJzZWN0aW9uIHBvaW50c1xuICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsIEkwWzBdKS5hdHRyKFwieTFcIiwgSTBbMV0pLmF0dHIoXCJ4MlwiLCBJMlswXSkuYXR0cihcInkyXCIsIEkyWzFdKVxuICAgIC5hdHRyKFwic3Ryb2tlXCIsIERJTSkuYXR0cihcInN0cm9rZS13aWR0aFwiLCAxLjIpO1xuICBhZGRUaWNrKGRpbXMsIEkwWzBdLEkwWzFdLCBleHRzWzBdLnZbMF0sIGV4dHNbMF0udlsxXSwgOCk7XG4gIGFkZFRpY2soZGltcywgSTJbMF0sSTJbMV0sIGV4dHNbMl0udlswXSwgZXh0c1syXS52WzFdLCA4KTtcblxuICAvLyBMIGxhYmVsXG4gIGNvbnN0IG1pZEw9WyhJMFswXStJMlswXSkvMiwoSTBbMV0rSTJbMV0pLzJdO1xuICBkaW1zLmFwcGVuZChcInRleHRcIilcbiAgICAuYXR0cihcInhcIiwgbWlkTFswXStuT3V0WzBdKjE4KS5hdHRyKFwieVwiLCBtaWRMWzFdK25PdXRbMV0qMTgpXG4gICAgLmF0dHIoXCJ0ZXh0LWFuY2hvclwiLFwibWlkZGxlXCIpLmF0dHIoXCJmaWxsXCIsXCIjNGI1NTYzXCIpLnN0eWxlKFwiZm9udC1zaXplXCIsXCIxMnB4XCIpLnRleHQoXCJMXCIpO1xuXG4gIC8vIHRvcC1jaG9yZCB0cnVlIGxlbmd0aCAoYWJvdmUgZmFyIHRydXNzKVxuICAoZnVuY3Rpb24oKXtcbiAgICBjb25zdCB5ID0geVRydXNzWzJdO1xuICAgIGNvbnN0IFAgPSBbc1BYKDAseSwwKSwgc1BZKDAseSwwKV07XG4gICAgY29uc3QgUSA9IFtzUFgoaGFsZl9pbix5LHJpc2VfaW4pLCBzUFkoaGFsZl9pbix5LHJpc2VfaW4pXTtcbiAgICBjb25zdCB0ID0gdm5vcm0oUVswXS1QWzBdLCBRWzFdLVBbMV0pOyBsZXQgbj1bLXRbMV0sdFswXV07IGlmKG5bMV0+MCkgbj1bLW5bMF0sLW5bMV1dO1xuICAgIGNvbnN0IG9mZj04MCwgbGFiZWxPZmY9MTYsIHRpY2tMZW49ODtcbiAgICBjb25zdCBQbj1bUFswXStuWzBdKm9mZiwgUFsxXStuWzFdKm9mZl0sIFFuPVtRWzBdK25bMF0qb2ZmLCBRWzFdK25bMV0qb2ZmXTtcbiAgICBkaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsUG5bMF0pLmF0dHIoXCJ5MVwiLFBuWzFdKS5hdHRyKFwieDJcIixRblswXSkuYXR0cihcInkyXCIsUW5bMV0pXG4gICAgICAuYXR0cihcInN0cm9rZVwiLERJTSkuYXR0cihcInN0cm9rZS13aWR0aFwiLDEuMik7XG4gICAgYWRkVGljayhkaW1zLCBQblswXSxQblsxXSwgblswXSxuWzFdLCB0aWNrTGVuKTtcbiAgICBhZGRUaWNrKGRpbXMsIFFuWzBdLFFuWzFdLCBuWzBdLG5bMV0sIHRpY2tMZW4pO1xuICAgIGNvbnN0IGxhYmVsID0gYFRvcC1jaG9yZCB0cnVlIGxlbmd0aCDiiYggJHsgKFRfaW4vMTIpLnRvRml4ZWQoMikgfSBmdCAoJHsgVF9pbi50b0ZpeGVkKDIpIH0gaW4pYDtcbiAgICBjb25zdCBhbmcgPSBNYXRoLmF0YW4yKFFuWzFdLVBuWzFdLCBRblswXS1QblswXSkqMTgwL01hdGguUEk7XG4gICAgY29uc3QgbWlkPVsoUG5bMF0rUW5bMF0pLzIsKFBuWzFdK1FuWzFdKS8yXTtcbiAgICBkaW1zLmFwcGVuZChcInRleHRcIikuYXR0cihcInRleHQtYW5jaG9yXCIsXCJtaWRkbGVcIilcbiAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsYHRyYW5zbGF0ZSgke21pZFswXStuWzBdKmxhYmVsT2ZmfSwke21pZFsxXStuWzFdKmxhYmVsT2ZmfSkgcm90YXRlKCR7YW5nfSlgKVxuICAgICAgLmF0dHIoXCJmaWxsXCIsXCIjMzc0MTUxXCIpLnN0eWxlKFwiZm9udC1zaXplXCIsXCIxMnB4XCIpLnRleHQobGFiZWwpO1xuICB9KSgpO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIER5bmFtaWMgdHJpYnV0YXJ5IHJpZGdlIGRpbWVuc2lvbiAoY29sb3JlZCwgY29wbGFuYXIgJiBjb2xpbmVhcilcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgZnVuY3Rpb24gZHJhd0R5bmFtaWNSaWRnZURpbShpZHgpe1xuICAgIGR5bkRpbXMuc2VsZWN0QWxsKFwiKlwiKS5yZW1vdmUoKTtcblxuICAgIC8vIGNob29zZSBuZWFyL2ZhciBleHRlbnNpb24tbGluZXMnIHktbG9jYXRpb25zXG4gICAgbGV0IHlOZWFyLCB5RmFyLCBsYWJlbDtcbiAgICBpZiAoaWR4PT09MSl7IHlOZWFyID0gbTA7IHlGYXIgPSBtMTsgbGFiZWwgPSBcIkwvMlwiOyB9XG4gICAgZWxzZSBpZiAoaWR4PT09MCl7IHlOZWFyID0geVRydXNzWzBdOyB5RmFyID0gbTA7IGxhYmVsID0gXCJMLzRcIjsgfVxuICAgIGVsc2UgeyB5TmVhciA9IG0xOyB5RmFyID0geVRydXNzWzJdOyBsYWJlbCA9IFwiTC80XCI7IH1cblxuICAgIC8vIGV4dGVuc2lvbi1saW5lIGJhc2VzICh0aHJvdWdoIGhlZWwgYXQgeD0wIG9uIHRob3NlIHkncyksIGRpcmVjdGlvbnMgYWxvbmcgYm90dG9tIGNob3JkXG4gICAgY29uc3QgUG4gPSBbc1BYKDAseU5lYXIsMCksIHNQWSgwLHlOZWFyLDApXSwgdm4gPSBiY0RpckxlZnQoeU5lYXIpO1xuICAgIGNvbnN0IFBmID0gW3NQWCgwLHlGYXIsIDApLCBzUFkoMCx5RmFyLCAwKV0sIHZmID0gYmNEaXJMZWZ0KHlGYXIpO1xuXG4gICAgLy8gZHluYW1pYyBkaW1lbnNpb24gbGluZTogcGFyYWxsZWwgdG8gb3V0ZXIgTCBsaW5lLCBmYXJ0aGVyIG91dCBieSAodGllck9mZiArIGRlbHRhKSxcbiAgICAvLyB1c2luZyBhIHBvaW50IG9mZnNldCBmcm9tIHRoZSBpbm5lciBiYXNlIGF0IGV4dHNbMF0uRVxuICAgIGNvbnN0IGR5bmFtaWNPZmYgPSB0aWVyT2ZmICsgMzY7XG4gICAgY29uc3QgYmFzZUR5biA9IFtleHRzWzBdLkVbMF0gKyBuT3V0WzBdKmR5bmFtaWNPZmYsIGV4dHNbMF0uRVsxXSArIG5PdXRbMV0qZHluYW1pY09mZl07XG5cbiAgICAvLyBpbnRlcnNlY3Rpb25zIHdpdGggdGhlIHR3byBleHRlbnNpb24gbGluZXMgPT4gZW5kcG9pbnRzIHRoYXQgZ3VhcmFudGVlIGNvbGluZWFyaXR5IHdpdGggY2hvcmRzXG4gICAgY29uc3QgSW5lYXIgPSBpbnRlcnNlY3RQb2ludChQbiwgdm4sIGJhc2VEeW4sIHdSaWRnZSk7XG4gICAgY29uc3QgSWZhciAgPSBpbnRlcnNlY3RQb2ludChQZiwgdmYsIGJhc2VEeW4sIHdSaWRnZSk7XG5cbiAgICBjb25zdCBjb2wgPSB2aXZpZFtpZHhdO1xuXG4gICAgLy8gZHJhdyBkeW5hbWljIGV4dGVuc2lvbiBsaW5lcyAoYWxvbmcgY2hvcmQgZGlyZWN0aW9ucylcbiAgICBkeW5EaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsUG5bMF0pLmF0dHIoXCJ5MVwiLFBuWzFdKS5hdHRyKFwieDJcIixJbmVhclswXSkuYXR0cihcInkyXCIsSW5lYXJbMV0pXG4gICAgICAuYXR0cihcInN0cm9rZVwiLCBjb2wpLmF0dHIoXCJzdHJva2Utd2lkdGhcIiwgMS42KTtcbiAgICBkeW5EaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsUGZbMF0pLmF0dHIoXCJ5MVwiLFBmWzFdKS5hdHRyKFwieDJcIixJZmFyWzBdKS5hdHRyKFwieTJcIixJZmFyWzFdKVxuICAgICAgLmF0dHIoXCJzdHJva2VcIiwgY29sKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIDEuNik7XG5cbiAgICAvLyBkeW5hbWljIGRpbWVuc2lvbiBsaW5lICsgdGlja3NcbiAgICBkeW5EaW1zLmFwcGVuZChcImxpbmVcIikuYXR0cihcIngxXCIsSW5lYXJbMF0pLmF0dHIoXCJ5MVwiLEluZWFyWzFdKS5hdHRyKFwieDJcIixJZmFyWzBdKS5hdHRyKFwieTJcIixJZmFyWzFdKVxuICAgICAgLmF0dHIoXCJzdHJva2VcIiwgY29sKS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIDIuMik7XG4gICAgYWRkVGljayhkeW5EaW1zLCBJbmVhclswXSxJbmVhclsxXSwgdm5bMF0sIHZuWzFdLCA4KTtcbiAgICBhZGRUaWNrKGR5bkRpbXMsIElmYXJbMF0sIElmYXJbMV0sIHZmWzBdLCB2ZlsxXSwgOCk7XG5cbiAgICAvLyBsYWJlbCAocHVsbGVkIGZhcnRoZXIgZnJvbSB0aGUgbGluZSlcbiAgICBjb25zdCBtaWQ9WyhJbmVhclswXStJZmFyWzBdKS8yLChJbmVhclsxXStJZmFyWzFdKS8yXTtcbiAgICBkeW5EaW1zLmFwcGVuZChcInRleHRcIilcbiAgICAgIC5hdHRyKFwieFwiLCBtaWRbMF0gKyBuT3V0WzBdKjI2KS5hdHRyKFwieVwiLCBtaWRbMV0gKyBuT3V0WzFdKjI2KSAvLyBleHRyYSBjbGVhcmFuY2VcbiAgICAgIC5hdHRyKFwidGV4dC1hbmNob3JcIixcIm1pZGRsZVwiKS5zdHlsZShcImZvbnQtc2l6ZVwiLFwiMTJweFwiKS5hdHRyKFwiZmlsbFwiLCBjb2wpXG4gICAgICAudGV4dChsYWJlbCk7XG4gIH1cbiAgZnVuY3Rpb24gY2xlYXJEeW5hbWljUmlkZ2VEaW0oKXsgZHluRGltcy5zZWxlY3RBbGwoXCIqXCIpLnJlbW92ZSgpOyB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gSG92ZXIgaGFuZGxlcnNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgZnVuY3Rpb24gc2V0QWN0aXZlKGlkeCl7XG4gICAgaGlBcmVhcy5zZWxlY3RBbGwoXCIqXCIpLnJlbW92ZSgpOyBoaVRydXNzLnNlbGVjdEFsbChcIipcIikucmVtb3ZlKCk7XG4gICAgW1wibGVmdFwiLFwicmlnaHRcIl0uZm9yRWFjaChzaWRlPT57XG4gICAgICBoaUFyZWFzLmFwcGVuZChcInBhdGhcIilcbiAgICAgICAgLmF0dHIoXCJkXCIsIGQzLmxpbmUoKS5jdXJ2ZShkMy5jdXJ2ZUxpbmVhckNsb3NlZCkoc3RyaXBQb2x5KHNpZGUsIHlab25lc1tpZHhdWzBdLCB5Wm9uZXNbaWR4XVsxXSkpKVxuICAgICAgICAuYXR0cihcImZpbGxcIiwgcGFzdGVsW2lkeF0pLmF0dHIoXCJmaWxsLW9wYWNpdHlcIiwgMC4zMilcbiAgICAgICAgLmF0dHIoXCJzdHJva2VcIiwgcGFzdGVsW2lkeF0pLmF0dHIoXCJzdHJva2Utb3BhY2l0eVwiLCAwLjg1KS5hdHRyKFwic3Ryb2tlLXdpZHRoXCIsIDEuMik7XG4gICAgfSk7XG4gICAgZHJhd0hvd2VUcnVzcyh5VHJ1c3NbaWR4XSwgaGlUcnVzcywgeyBzdHJva2U6IHZpdmlkW2lkeF0sIHN0cm9rZVdpZHRoOiAzLjIsIGNsYXNzTmFtZTogXCJ0cnVzcy1vdmVybGF5XCIgfSk7XG4gICAgZHJhd0R5bmFtaWNSaWRnZURpbShpZHgpO1xuICAgIHVwZGF0ZVNwZWNpZmljKGlkeCk7XG4gIH1cbiAgZnVuY3Rpb24gY2xlYXJBY3RpdmUoKXtcbiAgICBoaUFyZWFzLnNlbGVjdEFsbChcIipcIikucmVtb3ZlKCk7IGhpVHJ1c3Muc2VsZWN0QWxsKFwiKlwiKS5yZW1vdmUoKTtcbiAgICBjbGVhckR5bmFtaWNSaWRnZURpbSgpO1xuICAgIGN1cnJlbnRJZHggPSBudWxsO1xuICAgIHVwZGF0ZVNwZWNpZmljKG51bGwpO1xuICB9XG5cbiAgLy8gZnJvbnQgZWF2ZSBndWlkZVxuICBjb25zdCBlMCA9IFtzUFgoMCwwLDApLCBzUFkoMCwwLDApXSwgZTEgPSBbc1BYKHNwYW5faW4sMCwwKSwgc1BZKHNwYW5faW4sMCwwKV07XG4gIGcuYXBwZW5kKFwibGluZVwiKVxuICAgIC5hdHRyKFwieDFcIiwgZTBbMF0pLmF0dHIoXCJ5MVwiLCBlMFsxXSkuYXR0cihcIngyXCIsIGUxWzBdKS5hdHRyKFwieTJcIiwgZTFbMV0pXG4gICAgLmF0dHIoXCJzdHJva2VcIixcIiNlNWU3ZWJcIikuYXR0cihcInN0cm9rZS13aWR0aFwiLDEuMikuYXR0cihcInN0cm9rZS1kYXNoYXJyYXlcIixcIjMgM1wiKTtcblxuICAvLyBpbml0XG4gIHVwZGF0ZVNwZWNpZmljKG51bGwpO1xuICByZXR1cm4gY29udGFpbmVyLm5vZGUoKTtcbn1cblxuIn1dfQ==
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../..";
window._ojs.paths.runtimeToRoot = "../../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>